<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìµœì´ˆ ìœ„í—˜ì„±í‰ê°€ | ë™ì§„í† ê±´</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:"Noto Sans KR",sans-serif;
  background:#f4f7ff;
  color:#0b1b3b;
}
.header{
  background:#0b2a4f;
  color:#fff;
  padding:60px 20px;
  text-align:center;
}
.section{max-width:1400px;margin:0 auto;padding:30px}
.box{
  background:#fff;
  border-radius:18px;
  padding:24px;
  margin-bottom:24px;
  box-shadow:0 12px 30px rgba(0,0,0,.08)
}
h2{margin:0 0 16px;font-size:20px;font-weight:800}
label{font-weight:700;font-size:14px}
input,select{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:1px solid #ccc;
}

/* table */
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #bbb;padding:6px;text-align:center}
th{background:#eef3ff}

/* risk color */
.risk-high{background:#fee2e2;color:#991b1b;font-weight:800}
.risk-mid{background:#ffedd5;color:#9a3412;font-weight:800}
.risk-low{background:#dbeafe;color:#1e40af;font-weight:800}

/* buttons */
.actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:16px
}
button{
  padding:12px 26px;
  border-radius:999px;
  border:none;
  font-weight:800;
  cursor:pointer
}
.primary{background:#1f5bd8;color:#fff}
.ghost{background:#fff;border:1px solid #aaa}
.danger{background:#ef4444;color:#fff}

/* print */
@media print{
  body{background:#fff}
  .no-print{display:none !important}
  .page{page-break-after:always}
}
</style>
</head>

<body>

<div class="header no-print">
  <h1>ìµœì´ˆ ìœ„í—˜ì„±í‰ê°€</h1>
</div>

<div class="section no-print">

<!-- í˜„ì¥ ì •ë³´ -->
<div class="box">
  <h2>â‘  í˜„ì¥ ì •ë³´</h2>

  <label>ê¸°ë“±ë¡ í˜„ì¥ ì„ íƒ</label>
  <select id="siteSelect"><option value="">ì„ íƒ</option></select>

  <label style="margin-top:10px">í˜„ì¥ ID (ì˜ë¬¸)</label>
  <input id="siteId">

  <label style="margin-top:10px">íšŒì‚¬ëª…</label>
  <input id="companyName" placeholder="ë™ì§„í† ê±´(ì£¼)">

  <label style="margin-top:10px">í˜„ì¥ëª…</label>
  <input id="siteName">

  <label style="margin-top:10px">ê³µì‚¬ëª…</label>
  <input id="projectName">

  <label style="margin-top:10px">ê³µì‚¬ê¸°ê°„</label>
  <input id="projectPeriod" placeholder="ì°©ê³µì¼ ~ ì¤€ê³µì¼">

  <label style="margin-top:10px">ìµœì´ˆ ìœ„í—˜ì„±í‰ê°€ ì‹¤ì‹œì¼</label>
  <input type="date" id="evalDate">

  <div class="actions" style="justify-content:flex-start">
    <button class="ghost" id="loadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>
</div>

<!-- ì—‘ì…€ -->
<div class="box">
  <h2>â‘¡ ì—‘ì…€ ì—…ë¡œë“œ</h2>

  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <input type="file" id="excelFile" accept=".xlsx,.xls">

    <!-- ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ -->
    <a
      href="https://github.com/es1063122-creator/dj-risk-system/raw/main/%EC%B5%9C%EC%B4%88.xlsx"
      download
      class="excel-download"
    >
      ğŸ“¥ ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
    </a>
  </div>
</div>


<!-- ìœ„í—˜ì„±í‰ê°€ -->
<div class="box" id="tableBox" style="display:none">
  <h2>â‘¢ ìœ„í—˜ì„±í‰ê°€ í•­ëª©</h2>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="checkAll"></th>        
        <th>NO</th>
        <th>ëŒ€ê³µì¢…ëª…</th>
        <th>ì¤‘ê³µì¢…ëª…</th>
        <th>ì„¸ë¶€ê³µì¢…</th>
        <th>ì‘ì—…ë‚´ìš©</th>
        <th>ìœ„í—˜ìš”ì¸</th>
        <th>ìœ„í—˜ë¶„ë¥˜</th>
        <th>ìœ„í—˜ë“±ê¸‰</th>
        <th>ìœ„í—˜ê°ì†ŒëŒ€ì±…</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="actions">
    <button class="danger" id="deleteSelected">ì„ íƒì‚­ì œ</button>
    <button class="ghost" id="pdfBtn">PDF ì €ì¥</button>
    <button class="primary" id="saveBtn">ì €ì¥</button>
    <button class="danger" id="deleteBtn">ì‚­ì œ</button>
  </div>
</div>

</div>

<!-- PDF -->
<div id="pdfArea" style="display:none">

<!-- ê°‘ì§€ -->
<div class="page">
  <h1 style="text-align:center">ìµœì´ˆ ìœ„í—˜ì„±í‰ê°€ ë³´ê³ ì„œ</h1>
  <hr>

  <p><b>í‰ê°€ êµ¬ë¶„ :</b> â˜‘ ìµœì´ˆ â˜ ì •ê¸° â˜ ìˆ˜ì‹œ</p>

  <h3>1. í˜„ì¥ ê¸°ë³¸ ì •ë³´</h3>
  <p>íšŒì‚¬ëª… : <span id="p_company"></span></p>
  <p>í˜„ì¥ëª… : <span id="p_site"></span></p>
  <p>ê³µì‚¬ëª… : <span id="p_project"></span></p>
  <p>ê³µì‚¬ê¸°ê°„ : <span id="p_period"></span></p>
  <p>ìœ„í—˜ì„±í‰ê°€ ì‹¤ì‹œì¼ : <span id="p_date"></span></p>

  <h3>2. ì°¸ì—¬ì ëª…ë‹¨</h3>
  <table>
    <tr><th>êµ¬ë¶„</th><th>ì„±ëª…</th><th>ì§ìœ„</th><th>ì„œëª…</th></tr>
    <tr><td>í˜„ì¥ì†Œì¥</td><td></td><td></td><td></td></tr>
    <tr><td>ê´€ë¦¬ê°ë…ì</td><td></td><td></td><td></td></tr>
    <tr><td>ì•ˆì „ê´€ë¦¬ì</td><td></td><td></td><td></td></tr>
    <tr><td>ê·¼ë¡œìëŒ€í‘œ</td><td></td><td></td><td></td></tr>
  </table>

  <p style="margin-top:20px">
    ë³¸ í˜„ì¥ì˜ ìµœì´ˆ ìœ„í—˜ì„±í‰ê°€ëŠ” ì‚°ì—…ì•ˆì „ë³´ê±´ë²•ì— ë”°ë¼ ìœ í•´Â·ìœ„í—˜ìš”ì¸ì„ ë„ì¶œí•˜ê³ 
    ìœ„í—˜ì„± ì €ê°ëŒ€ì±…ì„ ìˆ˜ë¦½í•˜ì—¬ ê·¼ë¡œìì—ê²Œ ì¶©ë¶„íˆ ì „íŒŒí•˜ì˜€ìŒ.
  </p>

  <!-- ì„œëª… -->
  <div style="margin-top:50px;text-align:right;font-weight:700">
    ì‘ ì„± <span style="display:inline-block;width:140px;border-bottom:1px solid #000;"></span>
    &nbsp;&nbsp;
    ê²€ í†  <span style="display:inline-block;width:140px;border-bottom:1px solid #000;"></span>
    &nbsp;&nbsp;
    ìŠ¹ ì¸ <span style="display:inline-block;width:140px;border-bottom:1px solid #000;"></span>
  </div>
</div>

<!-- ì„¸ë¶€ë‚´ì—­ -->
<div class="page">
  <h2>ìœ„í—˜ì„±í‰ê°€ ì„¸ë¶€ë‚´ì—­</h2>
  <table>
    <thead>
      <tr>
        <th> </th>
        <th>NO</th>
        <th>ëŒ€ê³µì¢…ëª…</th>
        <th>ì¤‘ê³µì¢…ëª…</th>
        <th>ì„¸ë¶€ê³µì¢…</th>
        <th>ì‘ì—…ë‚´ìš©</th>
        <th>ìœ„í—˜ìš”ì¸</th>
        <th>ìœ„í—˜ë¶„ë¥˜</th>
        <th>ìœ„í—˜ë“±ê¸‰</th>
        <th>ìœ„í—˜ê°ì†ŒëŒ€ì±…</th>
      </tr>
    </thead>
    <tbody id="pdfTable"></tbody>
  </table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, getDoc, setDoc, deleteDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  projectId:"dongjin-risk-system"
});
const db = getFirestore(app);

/* site list */
const siteSelect=document.getElementById("siteSelect");
async function loadSites(){
  const snap=await getDocs(collection(db,"sites"));
  snap.forEach(d=>{
    const s=d.data();
    if(!s.active)return;
    const o=document.createElement("option");
    o.value=s.siteId;
    o.textContent=`${s.siteName} (${s.siteId})`;
    siteSelect.appendChild(o);
  });
}
loadSites();
siteSelect.addEventListener("change",()=>siteId.value=siteSelect.value);

/* excel */
let items=[];
excelFile.addEventListener("change",async e=>{
  const buf=await e.target.files[0].arrayBuffer();
  const wb=XLSX.read(buf,{type:"array"});
  items=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
  render();
});

function render(){
  tbody.innerHTML="";
  items.forEach((r,i)=>{
    const cls=r["ìœ„í—˜ë“±ê¸‰"]==="ìƒ"?"risk-high":
              r["ìœ„í—˜ë“±ê¸‰"]==="ì¤‘"?"risk-mid":"risk-low";
    tbody.innerHTML+=`
      <tr>
        <td><input type="checkbox" class="rowCheck" data-i="${i}"></td>
        <td>${r["NO"]||""}</td>
        <td>${r["ëŒ€ê³µì¢…ëª…"]||""}</td>
        <td>${r["ì¤‘ê³µì¢…ëª…"]||""}</td>
        <td>${r["ì„¸ë¶€ê³µì¢…"]||""}</td>
        <td>${r["ì‘ì—…ë‚´ìš©"]||""}</td>
        <td>${r["ìœ„í—˜ìš”ì¸"]||""}</td>
        <td>${r["ìœ„í—˜ë¶„ë¥˜"]||""}</td>
        <td class="${cls}">${r["ìœ„í—˜ë“±ê¸‰"]||""}</td>
        <td>${r["ìœ„í—˜ê°ì†ŒëŒ€ì±…"]||""}</td>
      </tr>`;
  });
  tableBox.style.display="block";
}

/* check delete */
checkAll.addEventListener("change",()=>{
  document.querySelectorAll(".rowCheck").forEach(c=>c.checked=checkAll.checked);
});
deleteSelected.addEventListener("click",()=>{
  items=items.filter((_,i)=>!document.querySelector(`.rowCheck[data-i="${i}"]`)?.checked);
  render();
});

/* load */
loadBtn.addEventListener("click",async ()=>{
  const id=siteId.value.trim();
  const snap=await getDoc(doc(db,"initialRiskAssessments",id));
  if(!snap.exists()){alert("ì—†ìŒ");return;}
  const d=snap.data();
  companyName.value=d.companyName||"";
  siteName.value=d.siteName;
  projectName.value=d.projectName||"";
  projectPeriod.value=d.projectPeriod||"";
  evalDate.value=d.evalDate;
  items=d.items;
  render();
});

/* save */
saveBtn.addEventListener("click",async ()=>{
  const id=siteId.value.trim();
  if(!id||!siteName.value||!items.length){alert("í•„ìˆ˜ê°’ ëˆ„ë½");return;}

  await setDoc(doc(db,"initialRiskAssessments",id),{
    siteId:id,
    companyName:companyName.value,
    siteName:siteName.value,
    projectName:projectName.value,
    projectPeriod:projectPeriod.value,
    evalDate:evalDate.value,
    items,
    updatedAt:serverTimestamp()
  });

  await setDoc(doc(db,"sites",id),{
    siteId:id, siteName:siteName.value, active:true,
    createdAt:serverTimestamp()
  },{merge:true});

  alert("ì €ì¥ ì™„ë£Œ");
});

/* delete */
deleteBtn.addEventListener("click",async ()=>{
  if(!confirm("ì‚­ì œ?"))return;
  await deleteDoc(doc(db,"initialRiskAssessments",siteId.value));
  location.reload();
});

/* pdf */
pdfBtn.addEventListener("click",()=>{
  p_company.textContent=companyName.value;
  p_site.textContent=siteName.value;
  p_project.textContent=projectName.value;
  p_period.textContent=projectPeriod.value;
  p_date.textContent=evalDate.value;
  pdfTable.innerHTML=tbody.innerHTML;
  pdfArea.style.display="block";
  window.print();
  pdfArea.style.display="none";
});
</script>

</body>
</html>
