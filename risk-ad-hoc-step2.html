<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>동진토건 수시 위험성평가 v1.0SR FINAL</title>
  <link rel="icon" type="image/x-icon"
      href="https://raw.githubusercontent.com/es1063122-creator/dj-risk-system/main/djlogo.ico">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --dj:#004080;
      --dj2:#2a6cf6;
      --bg:#f4f7ff;
      --card:#ffffff;
      --line:#e8ecf6;
      --ink:#0b1b3b;
      --muted:#667085;
      --good:#12b76a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --r:16px;
      --shadow:0 10px 26px rgba(0,64,128,.10);
      --shadow2:0 12px 30px rgba(0,64,128,.14);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans KR", system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* ✅ 버전1 느낌: 화면 가로 꽉 차게 + 밀도 유지 */
    .wrap{
      width:100%;
      margin:0;
      padding:14px 16px 24px;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(232,236,246,.95);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:12px;
    }

    /* ===== Header (버전1 스타일) ===== */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width:280px;
    }
    .mark{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg, #0a2a4f 0%, #003a7a 55%, #195cc8 100%);
      box-shadow:0 12px 24px rgba(0,64,128,.18);
      flex:0 0 auto;
    }
    .titles .h1{
      font-weight:900;
      font-size:18px;
      line-height:1.15;
      margin:0;
    }
    .titles .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
      line-height:1.25;
    }

    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(42,108,246,.22);
      background:#eef3ff;
      color:#1246a8;
      font-weight:900;
      font-size:12.5px;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      box-shadow:none;
    }
    .btn:hover{filter:brightness(.99)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:var(--dj);
      border-color:rgba(0,64,128,.2);
      color:#fff;
      box-shadow:var(--shadow2);
    }
    .btn.danger{
      background:#fff;
      color:#b42318;
      border-color:rgba(239,68,68,.22);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    /* ===== Form grid (버전1 밀도) ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      align-items:start;
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    .label{
      font-size:12px;
      font-weight:900;
      color:#2b3a5c;
      letter-spacing:-.2px;
    }
    .hint{
      font-size:11.5px;
      color:var(--muted);
      line-height:1.25;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      background:#fff;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(42,108,246,.45);
      box-shadow:0 0 0 4px rgba(42,108,246,.12);
    }

    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .hr{height:1px; background:var(--line); margin:12px 0}

    /* ===== Section titles ===== */
    .sectionTitle{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .sectionTitle .t{
      font-size:14px;
      font-weight:900;
    }
    .sectionTitle .desc{
      font-size:11.5px;
      color:var(--muted);
      margin-top:2px;
    }

    /* ===== KPI Pills (버전1 느낌) ===== */
    .kpis{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(232,236,246,.95);
      background:#fbfdff;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.idle{background:var(--dj2)}

    /* ===== Table ===== */
    .tableWrap{
      border:1px solid rgba(232,236,246,.95);
      border-radius:14px;
      overflow:auto;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:1320px; /* 버전1처럼 넉넉 */
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:#f8fbff;
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      font-size:12px;
      font-weight:900;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:8px;
      vertical-align:top;
      background:#fff;
    }
    tbody tr:hover td{background:#fbfdff}
    .center{text-align:center}
    .w-ck{width:44px}
    .w-no{width:54px}

    /* 테이블 안 input/textarea: 버전1처럼 낮고 깔끔 */
    .tIn, .tSel, .tTa{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
    }
    .tTa{min-height:66px}
    .miniNote{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    .scoreBox{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .scorePill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      width:max-content;
      border:1px solid rgba(232,236,246,.95);
      background:#fff;
    }
    .scoreLow{border-color:rgba(18,183,106,.25); background:rgba(18,183,106,.06)}
    .scoreMid{border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.07)}
    .scoreHigh{border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.07)}

    .rowBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
      justify-content:flex-start;
    }

    /* ===== Education Section ===== */
    .eduGrid{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      margin-top:10px;
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:16px;
      bottom:16px;
      background:#0b1b3b;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
      font-size:13px;
      display:none;
      z-index:9999;
      max-width:calc(100vw - 32px);
    }

    /* ===== Print / PDF ===== */
    @page { size: A4 landscape; margin: 10mm; }
    @media print{
      body{background:#fff}
      .wrap{padding:0}
      .card{box-shadow:none; border-radius:12px}
      .btns, .rowBtns, .toast{display:none !important}
      .tableWrap{border:1px solid #bbb}
      thead th{background:#f3f6ff}
      input, select, textarea{border:1px solid #bbb; box-shadow:none}
    }
/* ===== v3.2 로고 표시 ===== */
.mark.logo{
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
}

.mark.logo img{
  width:26px;
  height:26px;
  object-fit:contain;
}

  /* ===== v3.1 컬럼 비율 미세조정 (여기에 붙여!) ===== */
  th:nth-child(6){ min-width:75px; }   /* 피해형태 */
  th:nth-child(7){ min-width:45px; }   /* 가능성 */
  th:nth-child(8){ min-width:45px; }   /* 중대성 */
  th:nth-child(10){ min-width:420px; } /* 개선대책 */
  th:nth-child(11){ min-width:75px; }  /* 조치자 */
  th:nth-child(12){ min-width:75px; }  /* 점검자 */
  </style>
</head>

<body>
<div class="wrap">

  <!-- ===== Header (버전1 기준) ===== -->
  <div class="card">
    <div class="header">
      <div class="brand">
        <div class="mark logo">
  <img src="https://raw.githubusercontent.com/es1063122-creator/dj-risk-system/main/djlogo.ico"
       alt="동진토건 로고">
</div>

        <div class="titles">
          <p class="h1">위험성평가서 제 <span id="roundText">1</span>회차</p>
          <div class="sub">동진토건(주) · 수시 위험성평가 시스템 (단일 HTML + Gemini 자동분석 + 저장/전회차)</div>
        </div>
      </div>

      <!-- ✅ 버전1 버튼 배치 유지 + 저장/전회차는 같은 톤으로 자연스럽게 추가 -->
      <div class="btns">
        <button class="btn" id="btnAddRowTop" type="button">행 추가</button>
        <button class="btn" id="btnDeleteSelectedTop" type="button">선택 삭제</button>
        <button class="btn primary" id="btnGenerateTop" type="button">교육/지시사항 생성</button>
        <button class="btn" id="btnPrintTop" type="button">PDF/인쇄</button>

        <button class="btn" id="btnLoadPrev" type="button">전회차 불러오기</button>
        <button class="btn primary" id="btnSave" type="button">저장</button>
      </div>
    </div>
  </div>

  <!-- ===== 기본 정보 (버전1 밀도 유지) ===== -->
  <div class="card">
    <div class="grid">
      <div class="field" style="grid-column: span 3;">
        <div class="label">제목(회차)</div>
        <input id="round" type="number" min="1" value="1">
        <div class="hint">예: “위험성평가서 제 1회차”</div>
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">현장</div>
        <select id="site">
          <option value="파주pmc">파주pmc</option>
          <option value="울산태화강">울산태화강</option>
          <option value="울산우정동">울산우정동</option>
          <option value="강변아이파크">강변아이파크</option>
          <option value="마포로3-1">마포로3-1</option>
          <option value="김해사이언스">김해사이언스</option>
        </select>
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">작성자</div>
        <input id="writer" placeholder="예: 김대홍">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">회의일자</div>
        <input id="meetingDate" type="date">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">평가기간 시작</div>
        <input id="periodStart" type="date">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">평가기간 종료</div>
        <input id="periodEnd" type="date">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">공종 대분류</div>
        <input id="tradeLarge" placeholder="예: 토공 / 철근콘크리트 / 가설">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">공종 소분류</div>
        <input id="tradeSmall" placeholder="예: 굴착 / 거푸집 / 안전시설">
      </div>

      <div class="field" style="grid-column: span 2;">
        <div class="label">작업일수</div>
        <input id="workDays" type="number" min="0" placeholder="예: 5">
      </div>

      <div class="field" style="grid-column: span 5;">
        <div class="label">직종별 인원</div>
        <textarea id="manpower" placeholder="예:
- 굴틀목공 4
- 철근공 3
- 장비기사 1"></textarea>
      </div>

      <div class="field" style="grid-column: span 5;">
        <div class="label">투입장비</div>
        <textarea id="equipments" placeholder="예:
- 굴착기(0.7) 1대
- 지게차 1대"></textarea>
      </div>
    </div>
  </div>

  <!-- ===== 위험성평가 상세 (버전1 기준 + KPI) ===== -->
  <div class="card">
    <div class="sectionTitle">
      <div>
        <div class="t">위험성평가 상세</div>
        <div class="desc">위험요인 입력 후 포커스를 벗어나면 AI가 자동으로 피해형태·가능성·중대성·개선대책을 생성합니다.</div>
      </div>
      <div class="kpis">
        <span class="pill"><span class="dot idle"></span>행 수: <b id="kpiRows">3</b></span>
        <span class="pill"><span class="dot bad"></span>고위험(7~9): <b id="kpiHigh">0</b></span>
        <span class="pill"><span class="dot warn"></span>중위험(4~6): <b id="kpiMid">0</b></span>
        <span class="pill"><span class="dot good"></span>저위험(1~3): <b id="kpiLow">0</b></span>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="center w-ck"><input type="checkbox" id="ckAll"></th>
            <th class="center w-no">No</th>
            <th style="min-width:160px;">작업명</th>
            <th style="min-width:140px;">작업위치</th>
            <th style="min-width:260px;">위험요인 (AI 분석 트리거)</th>
            <th style="min-width:75px;">피해형태</th>
            <th style="min-width:45px;">가능성</th>
            <th style="min-width:45px;">중대성</th>
            <th style="min-width:120px;">위험등급</th>
            <th style="min-width:420px;">개선대책</th>
            <th style="min-width:75px;">조치자</th>
            <th style="min-width:75px;">점검자</th>
            <th class="center" style="min-width:90px;">관리</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- 버전1 느낌: 하단 행 버튼 -->
    <div class="rowBtns">
      <button class="btn" id="btnAddRow" type="button">+ 행 추가</button>
      <button class="btn danger" id="btnDeleteLast" type="button">마지막 행 삭제</button>
    </div>
  </div>

  <!-- ===== 교육/지시사항 (버전1 기준) ===== -->
  <div class="card">
    <div class="sectionTitle">
      <div>
        <div class="t">교육내용(키워드) · 현장소장 지시사항</div>
        <div class="desc">“교육/지시사항 생성” 버튼을 누르면, 표의 분석결과를 종합해 자동 작성합니다.</div>
      </div>
      <div class="kpis">
        <span class="pill"><span class="dot idle" id="sumDot"></span><b id="sumState">대기</b></span>
      </div>
    </div>

    <div style="margin-top:8px;">
      <button class="btn primary" id="btnGenerate" type="button">교육/지시사항 생성</button>
    </div>

    <div class="eduGrid">
      <div class="field" style="grid-column: span 4;">
        <div class="label">교육 키워드 1</div>
        <input id="edu1" placeholder="자동 생성">
      </div>
      <div class="field" style="grid-column: span 4;">
        <div class="label">교육 키워드 2</div>
        <input id="edu2" placeholder="자동 생성">
      </div>
      <div class="field" style="grid-column: span 4;">
        <div class="label">교육 키워드 3</div>
        <input id="edu3" placeholder="자동 생성">
      </div>

      <div class="field" style="grid-column: span 12;">
        <div class="label">현장소장 지시사항 (맨 마지막)</div>
        <textarea id="boss" placeholder="자동 생성 (1~3번 지시사항)"></textarea>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script type="module">
/* =========================================================
   v1.0SR FINAL
   - UI: 버전1 화면 기준(밀도/버튼 위치/테이블 느낌)
   - 개선: 가로 Full width
   - AI: 위험요인 blur 트리거 유지
   - Firestore: 저장 + 전회차 불러오기
========================================================= */

/* =======================
   0) 설정 (키/프로젝트)
======================= */
// ✅ Gemini API Key: 본인 키로 교체
const GEMINI_API_KEY = "AIzaSyA9TGBqlmghmXFim6sLSwClnf350hBUSZg";
const GEMINI_MODEL = "gemini-2.0-flash";

// ✅ Firebase (사용자 제공 config)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  authDomain: "dongjin-risk-system.firebaseapp.com",
  projectId: "dongjin-risk-system",
  storageBucket: "dongjin-risk-system.firebasestorage.app",
  messagingSenderId: "419989869270",
  appId: "1:419989869270:web:b1d2dae3d82a7110732f77",
  measurementId: "G-WP7514NHWL"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =======================
   1) DOM
======================= */
const $ = (id)=>document.getElementById(id);

const roundEl = $("round");
const roundTextEl = $("roundText");
const siteEl = $("site");
const writerEl = $("writer");
const meetingDateEl = $("meetingDate");
const periodStartEl = $("periodStart");
const periodEndEl = $("periodEnd");
const tradeLargeEl = $("tradeLarge");
const tradeSmallEl = $("tradeSmall");
const workDaysEl = $("workDays");
const manpowerEl = $("manpower");
const equipmentsEl = $("equipments");

const tbody = $("tbody");
const ckAll = $("ckAll");

const btnAddRow = $("btnAddRow");
const btnAddRowTop = $("btnAddRowTop");
const btnDeleteSelectedTop = $("btnDeleteSelectedTop");
const btnDeleteLast = $("btnDeleteLast");
const btnGenerate = $("btnGenerate");
const btnGenerateTop = $("btnGenerateTop");
const btnPrintTop = $("btnPrintTop");
const btnSave = $("btnSave");
const btnLoadPrev = $("btnLoadPrev");

const kpiRows = $("kpiRows");
const kpiHigh = $("kpiHigh");
const kpiMid  = $("kpiMid");
const kpiLow  = $("kpiLow");

const edu1 = $("edu1");
const edu2 = $("edu2");
const edu3 = $("edu3");
const boss = $("boss");

const sumDot = $("sumDot");
const sumState = $("sumState");

const toastEl = $("toast");

/* =======================
   2) Toast
======================= */
let toastTimer=null;
function toast(msg){
  if(!msg) return;
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastEl.style.display="none", 1600);
}

/* =======================
   3) 날짜 기본값(오늘)
======================= */
(function initDates(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  const d = String(now.getDate()).padStart(2,"0");
  const iso = `${y}-${m}-${d}`;
  meetingDateEl.value ||= iso;
  periodStartEl.value ||= iso;
  periodEndEl.value ||= iso;
})();

/* =======================
   4) 회차 제목 동기화
======================= */
function syncRoundTitle(){
  const v = Math.max(1, Number(roundEl.value || 1));
  roundEl.value = v;
  roundTextEl.textContent = String(v);
}
// ✅ 회차 기반 제목 생성 (v2.1)
function makeTitleByRound(round){
  const r = Math.max(1, Number(round || 1));
  return `위험성평가서 제 ${r}회차`;
}

roundEl.addEventListener("input", syncRoundTitle);
roundEl.addEventListener("change", syncRoundTitle);
syncRoundTitle();

/* =======================
   5) 위험등급 계산 + KPI
======================= */
function calcScore(prob, sev){
  const p = Number(prob||0);
  const s = Number(sev||0);
  if(p>=1 && p<=3 && s>=1 && s<=3) return p*s;
  return 0;
}
function scoreLabel(score){
  if(!score) return "";
  if(score>=7) return `고(${score})`;
  if(score>=4) return `중(${score})`;
  return `저(${score})`;
}
function scoreClass(score){
  if(score>=7) return "scorePill scoreHigh";
  if(score>=4) return "scorePill scoreMid";
  if(score>=1) return "scorePill scoreLow";
  return "scorePill";
}
function updateKPIs(){
  const rows = [...tbody.querySelectorAll("tr")];
  let low=0, mid=0, high=0;
  rows.forEach(tr=>{
    const score = Number(tr.querySelector("[data-role=score]").dataset.score || 0);
    if(score>=7) high++;
    else if(score>=4) mid++;
    else if(score>=1) low++;
  });
  kpiRows.textContent = rows.length;
  kpiHigh.textContent = high;
  kpiMid.textContent  = mid;
  kpiLow.textContent  = low;
}

/* =======================
   6) Gemini 호출/파싱
======================= */
function extractSection(fullText, startMarker, endMarker=""){
  const s = fullText.indexOf(startMarker);
  if(s < 0) return "";
  let start = s + startMarker.length;
  let chunk = fullText.slice(start);
  if(endMarker){
    const e = chunk.indexOf(endMarker);
    if(e >= 0) chunk = chunk.slice(0, e);
  }
  chunk = chunk.trim();

  if(startMarker.includes("[가능성]") || startMarker.includes("[중대성]")){
    const m = chunk.match(/[1-3]/);
    return m ? m[0] : "";
  }
  return chunk;
}

async function callGemini(promptText){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json; charset=utf-8" },
    body: JSON.stringify({
      contents:[{parts:[{text:promptText}]}],
      generationConfig:{ temperature:0.2, topP:0.9, maxOutputTokens:700 }
    })
  });
  const txt = await res.text();
  if(!res.ok) throw new Error(`Gemini 오류(${res.status}): ${txt.slice(0,200)}`);
  const json = JSON.parse(txt);
  const out = json?.candidates?.[0]?.content?.parts?.map(p=>p.text).join("\n") || "";
  return out.trim();
}

function buildRiskPrompt(riskFactor){
  return `
다음 위험요인에 대해 분석해주세요. 반드시 아래 형식으로만 답변하고 다른 설명은 추가하지 마세요:

[피해형태]
피해 유형을 한 단어로 작성 (예: 추락, 감전, 화재)

[가능성]
1, 2, 3 중 하나의 숫자만 입력

[중대성]
1, 2, 3 중 하나의 숫자만 입력

[개선대책]
각 개선대책을 7~8단어 정도로 구체적이고 실행 가능한 내용으로 작성해주세요.
1. 첫 번째 개선대책 (구체적인 조치사항 포함)
2. 두 번째 개선대책 (구체적인 조치사항 포함)
3. 세 번째 개선대책 (구체적인 조치사항 포함)

위험요인: ${String(riskFactor).replace(/"/g,"'")}
`.trim();
}

function buildSummaryPrompt(risksText, solutionsText){
  return `
다음 위험요인과 개선대책을 바탕으로 교육내용과 현장소장지시사항을 작성해주세요. 반드시 아래 형식으로만 답변해주세요:

[교육내용1]
4~6단어 이내로 핵심 키워드만 작성. 괄호 사용 금지

[교육내용2]
3~5단어 이내로 핵심 키워드만 작성. 괄호 사용 금지

[교육내용3]
3~5단어 이내로 핵심 키워드만 작성. 괄호 사용 금지

[현장소장지시사항]
1. 첫 번째 지시사항 (10단어 이내로 짧고 명확하게)
2. 두 번째 지시사항 (10단어 이내로 짧고 명확하게)
3. 세 번째 지시사항 (10단어 이내로 짧고 명확하게)

위험요인:
${risksText}

개선대책:
${solutionsText}
`.trim();
}

/* =======================
   7) 테이블 Row 생성/렌더
======================= */
const rowBusy = new WeakMap(); // {busy:boolean, lastRisk:string}

function renumber(){
  [...tbody.querySelectorAll("tr")].forEach((tr, idx)=>{
    tr.querySelector("[data-role=no]").textContent = String(idx+1);
  });
  updateKPIs();
}

function setSummaryState(state, kind="idle"){
  sumState.textContent = state;
  sumDot.classList.remove("good","warn","bad","idle");
  if(kind==="ok") sumDot.classList.add("good");
  else if(kind==="err") sumDot.classList.add("bad");
  else if(kind==="busy") sumDot.classList.add("warn");
  else sumDot.classList.add("idle");
}

function renderScore(tr){
  const prob = tr.querySelector("[data-role=prob]").value;
  const sev  = tr.querySelector("[data-role=sev]").value;
  const score = calcScore(prob, sev);

  const gradeCell = tr.querySelector("[data-role=score]");
  gradeCell.dataset.score = String(score || 0);
  gradeCell.innerHTML = "";

  if(score){
    const pill = document.createElement("span");
    pill.className = scoreClass(score);
    pill.innerHTML = `<span class="dot ${score>=7?'bad':score>=4?'warn':'good'}"></span>${scoreLabel(score)}`;
    gradeCell.appendChild(pill);
  }else{
    const span = document.createElement("span");
    span.style.color = "var(--muted)";
    span.style.fontSize = "12px";
    span.textContent = "자동";
    gradeCell.appendChild(span);
  }

  updateKPIs();
}

function makeRow(prefill=null){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="center w-ck"><input type="checkbox" data-role="sel"></td>
    <td class="center w-no" data-role="no"></td>

    <td><input class="tIn" data-role="workName" placeholder="예: 거푸집 설치"></td>
    <td><input class="tIn" data-role="workLoc" placeholder="예: 3층 슬라브"></td>

    <td>
      <textarea class="tTa" data-role="risk" placeholder="위험요인 입력 후 포커스 아웃"></textarea>
      <div class="miniNote">AI 자동분석</div>
    </td>

    <td><input class="tIn" data-role="damage" placeholder="자동"></td>
    <td><input class="tIn" data-role="prob" placeholder="1~3" inputmode="numeric"></td>
    <td><input class="tIn" data-role="sev" placeholder="1~3" inputmode="numeric"></td>

    <td data-role="score" class="center" style="min-width:120px">
      <span style="color:var(--muted);font-size:12px">자동</span>
    </td>

    <td><textarea class="tTa" data-role="solution" placeholder="자동 생성"></textarea></td>

    <td><input class="tIn" data-role="actor" placeholder=""></td>
    <td><input class="tIn" data-role="checker" placeholder=""></td>

    <td class="center">
      <button class="btn danger" data-role="del" type="button" style="padding:8px 10px;border-radius:10px">삭제</button>
    </td>
  `;

  rowBusy.set(tr, { busy:false, lastRisk:"" });

  // prefill
  if(prefill){
    tr.querySelector("[data-role=workName]").value = prefill.workName || "";
    tr.querySelector("[data-role=workLoc]").value  = prefill.workLoc  || "";
    tr.querySelector("[data-role=risk]").value     = prefill.risk     || "";
    tr.querySelector("[data-role=damage]").value   = prefill.damage   || "";
    tr.querySelector("[data-role=prob]").value     = prefill.prob ? String(prefill.prob) : "";
    tr.querySelector("[data-role=sev]").value      = prefill.sev ? String(prefill.sev) : "";
    tr.querySelector("[data-role=solution]").value = prefill.solution || "";
    tr.querySelector("[data-role=actor]").value    = prefill.actor    || "";
    tr.querySelector("[data-role=checker]").value  = prefill.checker  || "";
  }

  // 삭제
  tr.querySelector("[data-role=del]").addEventListener("click", ()=>{
    tr.remove();
    renumber();
    if(tbody.children.length === 0){
      addRow(); addRow(); addRow();
      renumber();
    }
  });

  // 위험요인 blur → AI 분석 (버전1 핵심)
  tr.querySelector("[data-role=risk]").addEventListener("blur", ()=> analyzeRow(tr));

  // 가능성/중대성 입력 → 위험등급 자동
  ["prob","sev"].forEach(k=>{
    tr.querySelector(`[data-role=${k}]`).addEventListener("input", ()=> renderScore(tr));
    tr.querySelector(`[data-role=${k}]`).addEventListener("blur", ()=> renderScore(tr));
  });

  // prefill일 때 등급 표시
  renderScore(tr);

  return tr;
}

function addRow(prefill=null){
  tbody.appendChild(makeRow(prefill));
  renumber();
}

function deleteLastRow(){
  const last = tbody.lastElementChild;
  if(last){
    last.remove();
    renumber();
  }
  if(tbody.children.length === 0){
    addRow(); addRow(); addRow();
    renumber();
  }
}

/* =======================
   8) AI 분석(행 단위)
======================= */
async function analyzeRow(tr){
  const state = rowBusy.get(tr);
  if(!state || state.busy) return;

  const riskEl = tr.querySelector("[data-role=risk]");
  const risk = riskEl.value.trim();
  if(!risk) return;

  if(state.lastRisk === risk) return;

  const damageEl = tr.querySelector("[data-role=damage]");
  const probEl   = tr.querySelector("[data-role=prob]");
  const sevEl    = tr.querySelector("[data-role=sev]");
  const solEl    = tr.querySelector("[data-role=solution]");

  state.busy = true;
  state.lastRisk = risk;

  damageEl.value = "분석 중...";
  probEl.value   = "분석 중...";
  sevEl.value    = "분석 중...";
  solEl.value    = "분석 중...";
  renderScore(tr);

  try{
    const out = await callGemini(buildRiskPrompt(risk));
    if(!out.includes("[피해형태]")) throw new Error("파싱 실패");

    damageEl.value = extractSection(out, "[피해형태]", "[가능성]");
    probEl.value   = extractSection(out, "[가능성]", "[중대성]");
    sevEl.value    = extractSection(out, "[중대성]", "[개선대책]");
    solEl.value    = extractSection(out, "[개선대책]", "");

    probEl.value = (String(probEl.value).match(/[1-3]/) || [""])[0];
    sevEl.value  = (String(sevEl.value).match(/[1-3]/) || [""])[0];

    renderScore(tr);
  }catch(e){
    damageEl.value = "분석 실패";
    probEl.value = "";
    sevEl.value  = "";
    solEl.value  = "";
    renderScore(tr);
    console.error(e);
    toast("AI 분석 실패 (콘솔 확인)");
  }finally{
    state.busy = false;
  }
}

/* =======================
   9) 교육/지시사항 생성(종합)
======================= */
async function generateSummary(){
  const rows = [...tbody.querySelectorAll("tr")];
  let allRisks = "";
  let allSolutions = "";

  rows.forEach(tr=>{
    const risk = tr.querySelector("[data-role=risk]").value.trim();
    const sol  = tr.querySelector("[data-role=solution]").value.trim();
    if(risk && risk !== "분석 중..." && risk !== "분석 실패"){
      allRisks += `- ${risk}\n`;
      if(sol && sol !== "분석 중..." && sol !== "분석 실패"){
        allSolutions += `${sol}\n`;
      }
    }
  });

  if(!allRisks.trim()){
    alert("위험요인이 입력되지 않았습니다.");
    return;
  }

  btnGenerate.disabled = true;
  btnGenerateTop.disabled = true;

  edu1.value = edu2.value = edu3.value = "분석 중...";
  boss.value = "분석 중...";
  setSummaryState("분석 중", "busy");

  try{
    const out = await callGemini(buildSummaryPrompt(allRisks, allSolutions));
    if(!out.includes("[교육내용1]")) throw new Error("파싱 실패");

    edu1.value = extractSection(out, "[교육내용1]", "[교육내용2]");
    edu2.value = extractSection(out, "[교육내용2]", "[교육내용3]");
    edu3.value = extractSection(out, "[교육내용3]", "[현장소장지시사항]");
    boss.value = extractSection(out, "[현장소장지시사항]", "");

    setSummaryState("완료", "ok");
    toast("교육/지시사항 생성 완료");
  }catch(e){
    edu1.value = "분석 실패";
    edu2.value = "";
    edu3.value = "";
    boss.value = String(e?.message || e);
    setSummaryState("오류", "err");
    console.error(e);
    toast("교육/지시사항 생성 실패");
  }finally{
    btnGenerate.disabled = false;
    btnGenerateTop.disabled = false;
  }
}

/* =======================
   10) Firestore 저장/전회차
   문서 ID: {site}__{round}
======================= */
function makeDocId(site, round){
  const safeSite = String(site).replace(/[\/\\#?[\]]/g, "_");
  return `${safeSite}__${round}`;
}

function collectData(){
  const meta = {
    writer: writerEl.value || "",
    meetingDate: meetingDateEl.value || "",
    periodStart: periodStartEl.value || "",
    periodEnd: periodEndEl.value || "",
    tradeLarge: tradeLargeEl.value || "",
    tradeSmall: tradeSmallEl.value || "",
    workDays: Number(workDaysEl.value || 0),
    manpower: manpowerEl.value || "",
    equipments: equipmentsEl.value || ""
  };

  const risks = [...tbody.querySelectorAll("tr")].map(tr=>({
    workName: tr.querySelector("[data-role=workName]").value || "",
    workLoc:  tr.querySelector("[data-role=workLoc]").value || "",
    risk:     tr.querySelector("[data-role=risk]").value || "",
    damage:   tr.querySelector("[data-role=damage]").value || "",
    prob:     Number(tr.querySelector("[data-role=prob]").value || 0),
    sev:      Number(tr.querySelector("[data-role=sev]").value || 0),
    solution: tr.querySelector("[data-role=solution]").value || "",
    actor:    tr.querySelector("[data-role=actor]").value || "",
    checker:  tr.querySelector("[data-role=checker]").value || ""
  }));

  const summary = {
    edu1: edu1.value || "",
    edu2: edu2.value || "",
    edu3: edu3.value || "",
    boss: boss.value || ""
  };

  return {
    site: siteEl.value,
    round: Math.max(1, Number(roundEl.value || 1)),
    meta,
    risks,
    summary
  };
}

async function saveToFirestore(){
  const data = collectData();
 // ✅ [추가] 저장 시 제목 강제 고정
  const fixedTitle = makeTitleByRound(data.round);
  roundTextEl.textContent = data.round;   // 상단 제목 즉시 고정
  const id = makeDocId(data.site, data.round);
  const ref = doc(db, "riskAssessments", id);

  btnSave.disabled = true;
  try{
    const existing = await getDoc(ref);
const payload = {
  ...data,

  // ✅ [추가] 고정된 제목 저장
  title: fixedTitle,

  updatedAt: serverTimestamp(),
};

    if(!existing.exists()){
      payload.createdAt = serverTimestamp();
    }
    await setDoc(ref, payload, { merge:true });
    toast(`저장 완료: ${data.site} / ${data.round}회차`);
  }catch(e){
    console.error(e);
    alert("저장 실패: " + String(e?.message || e));
  }finally{
    btnSave.disabled = false;
  }
}

function fillMeta(meta){
  writerEl.value = meta?.writer || "";
  meetingDateEl.value = meta?.meetingDate || "";
  periodStartEl.value = meta?.periodStart || "";
  periodEndEl.value = meta?.periodEnd || "";
  tradeLargeEl.value = meta?.tradeLarge || "";
  tradeSmallEl.value = meta?.tradeSmall || "";
  workDaysEl.value = (meta?.workDays ?? "");
  manpowerEl.value = meta?.manpower || "";
  equipmentsEl.value = meta?.equipments || "";
}

function fillRisks(risks){
  tbody.innerHTML = "";
  const arr = Array.isArray(risks) ? risks : [];
  if(arr.length){
    arr.forEach(r => addRow(r));
  }else{
    addRow(); addRow(); addRow();
  }
  renumber();
  ckAll.checked = false;
}

function fillSummary(summary){
  edu1.value = summary?.edu1 || "";
  edu2.value = summary?.edu2 || "";
  edu3.value = summary?.edu3 || "";
  boss.value = summary?.boss || "";
}

async function loadPreviousRound(){
  const site = siteEl.value;
  const round = Math.max(1, Number(roundEl.value || 1));
  if(round <= 1){
    toast("1회차는 전회차가 없습니다.");
    return;
  }
  const prevRound = round - 1;
  const prevId = makeDocId(site, prevRound);
  const ref = doc(db, "riskAssessments", prevId);

  btnLoadPrev.disabled = true;
  try{
    const snap = await getDoc(ref);
    if(!snap.exists()){
      toast(`전회차(${prevRound}) 저장 기록이 없습니다.`);
      return;
    }

    const ok = confirm(`⚠ 전회차(${prevRound}회차) 내용을 불러옵니다.\n현재 입력 내용은 덮어씁니다.\n\n불러오시겠습니까?`);
    if(!ok) return;

    const data = snap.data();
    fillMeta(data.meta);
    fillRisks(data.risks);
    fillSummary(data.summary);
// ✅ [추가] 제목은 항상 현재 회차 기준
roundTextEl.textContent = roundEl.value;


    setSummaryState("대기", "idle");
    toast(`전회차(${prevRound}) 복사 완료`);
  }catch(e){
    console.error(e);
    alert("전회차 불러오기 실패: " + String(e?.message || e));
  }finally{
    btnLoadPrev.disabled = false;
  }
}

/* =======================
   11) 선택삭제/체크올
======================= */
function deleteSelected(){
  const rows = [...tbody.querySelectorAll("tr")];
  const targets = rows.filter(tr => tr.querySelector("[data-role=sel]").checked);
  if(!targets.length){
    alert("선택된 행이 없습니다.");
    return;
  }
  targets.forEach(tr=>tr.remove());
  ckAll.checked = false;
  renumber();
  if(tbody.children.length === 0){
    addRow(); addRow(); addRow();
    renumber();
  }
}

ckAll.addEventListener("change", ()=>{
  const on = ckAll.checked;
  [...tbody.querySelectorAll("[data-role=sel]")].forEach(ck=>ck.checked = on);
});

/* =======================
   12) 버튼 이벤트 (버전1 흐름 유지)
======================= */
btnAddRow.addEventListener("click", ()=> addRow());
btnAddRowTop.addEventListener("click", ()=> addRow());

btnDeleteLast.addEventListener("click", deleteLastRow);
btnDeleteSelectedTop.addEventListener("click", deleteSelected);

btnGenerate.addEventListener("click", generateSummary);
btnGenerateTop.addEventListener("click", generateSummary);

btnPrintTop.addEventListener("click", ()=> window.print());

btnSave.addEventListener("click", saveToFirestore);
btnLoadPrev.addEventListener("click", loadPreviousRound);

/* 회차 변경 시: 제목만 즉시 동기화 (버전1 느낌 유지) */
roundEl.addEventListener("change", ()=>{
  syncRoundTitle();
});

/* =======================
   13) 초기 3행 보장 (버전1 핵심)
======================= */
(function initRows(){
  if(tbody.children.length === 0){
    addRow(); addRow(); addRow();
    renumber();
  }
  setSummaryState("대기", "idle");
  toast("v1.0SR FINAL 준비 완료");
})();
</script>

</body>
</html>
