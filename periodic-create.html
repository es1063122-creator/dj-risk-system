<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>정기 위험성평가 작성 | 동진토건</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  authDomain: "dongjin-risk-system.firebaseapp.com",
  projectId: "dongjin-risk-system"
};

const app = initializeApp(firebaseConfig);
window.db = getFirestore(app);
</script>

<style>
:root{
  --bg:#f4f7ff; --ink:#0b1b3b; --muted:#60708a; --card:#fff; --line:#dbe3f2;
  --blue1:#0b2a4f; --blue2:#1f5bd8;
  --red:#ef4444; --orange:#f59e0b; --sky:#3b82f6; --green:#10b981;
  --shadow: 0 18px 44px rgba(0,0,0,.10);
}
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
.header{background:linear-gradient(135deg,var(--blue1),var(--blue2));color:#fff;padding:72px 20px 56px;text-align:center}
.header h1{margin:0;font-size:32px;font-weight:900;letter-spacing:-.4px}
.header p{margin:10px 0 0;font-size:14px;opacity:.92}
.section{max-width:1400px;margin:0 auto;padding:34px 18px 60px}
.card{background:var(--card);border-radius:22px;padding:26px;box-shadow:var(--shadow);margin-bottom:18px;border:1px solid rgba(255,255,255,.7)}
.card h2{margin:0 0 14px;font-size:18px;letter-spacing:-.2px}
.hint{margin-top:6px;font-size:12px;color:var(--muted)}
.small{font-size:12px;color:var(--muted);line-height:1.5}
.row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
.col{flex:1;min-width:220px}
label{display:block;font-size:13px;font-weight:900;color:#223554;margin-bottom:6px}
select, textarea, input{width:100%;border:1px solid var(--line);border-radius:14px;padding:12px 12px;font-size:13px;outline:none;background:#fff}
textarea{min-height:62px;resize:vertical}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;font-size:12px;font-weight:900;background:rgba(31,91,216,.10);color:var(--blue2);border:1px solid rgba(31,91,216,.15)}
.table-wrap{overflow:auto;border-radius:16px;border:1px solid var(--line)}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;background:#fff}
thead th{position:sticky;top:0;background:#eef3ff;z-index:1}
th, td{border-bottom:1px solid #e9eef9;padding:10px;vertical-align:top}
th{text-align:center;font-size:12px;color:#2a3f63;font-weight:900}
tbody tr:hover td{background:#fbfcff}

.risk-level{width:100%;padding:8px 10px;border-radius:12px;border:none;font-weight:900;color:#fff;text-align:center;outline:none}
.risk-level.high{background:var(--red)}
.risk-level.mid{background:var(--orange)}
.risk-level.low{background:var(--sky)}

.btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:14px}
.btn{border:none;cursor:pointer;font-weight:900;letter-spacing:-.2px}
.btn-primary{background:linear-gradient(135deg,var(--blue2),#3b82f6);color:#fff;padding:14px 34px;border-radius:999px;box-shadow:0 12px 22px rgba(31,91,216,.22)}
.btn-add{background:linear-gradient(135deg,var(--green),#34d399);color:#fff;padding:10px 18px;border-radius:999px}
.btn-ghost{background:#fff;color:#24406a;border:1px solid var(--line);padding:10px 16px;border-radius:999px}
.btn-delete{background:#fff;color:var(--red);border:1px solid rgba(239,68,68,.55);padding:8px 10px;border-radius:10px;font-size:12px;font-weight:900;width:100%}
.btn-delete:hover{background:var(--red);color:#fff;border-color:var(--red)}

.loading{display:none;align-items:center;gap:10px;padding:12px 14px;border-radius:14px;background:rgba(31,91,216,.08);border:1px solid rgba(31,91,216,.15);color:#163a7a;font-weight:900}
.spinner{width:18px;height:18px;border-radius:50%;border:2px solid rgba(31,91,216,.25);border-top-color: rgba(31,91,216,.95);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error{display:none;margin-top:10px;padding:12px 14px;border-radius:14px;background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.18);color:#7a1b1b;font-weight:900;font-size:12px;white-space:pre-wrap}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
.modal-box{width:min(560px, calc(100% - 24px));background:#fff;border-radius:20px;padding:26px;box-shadow:0 30px 80px rgba(0,0,0,.22)}
.modal-box h3{margin:0 0 8px;font-size:18px}
.modal-box p{margin:0;color:var(--muted);font-size:13px;line-height:1.5;white-space:pre-line}
.modal-actions{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap}
.modal-actions .btn-primary{flex:1}
.modal-actions .btn-ghost{flex:1}

.note{border-left:6px solid var(--blue2);padding:12px 14px;border-radius:14px;background:#fff;border:1px solid var(--line);margin-bottom:18px;box-shadow: 0 10px 22px rgba(0,0,0,.06)}
.note b{color:#1b3f8f}

.history-wrap{overflow:auto;border:1px solid var(--line);border-radius:16px}
.history-table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;font-size:13px}
.history-table th,.history-table td{border-bottom:1px solid #e9eef9;padding:10px;text-align:center}
.history-table th{background:#eef3ff;font-size:12px;color:#2a3f63;font-weight:900}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid rgba(31,91,216,.18);background:rgba(31,91,216,.08);color:#1f5bd8}
.pill.dim{border-color:rgba(0,0,0,.08);background:#f6f8ff;color:#556}

/* 추가 스타일 */
.chk-col { width: 40px; text-align: center; }
.btn-batch-del { background: #fff; color: var(--red); border: 1px solid var(--red); padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 800; cursor: pointer; transition: 0.2s; }
.btn-batch-del:hover { background: var(--red); color: #fff; }
input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
</style>
</head>

<body>
  <div class="header">
    <h1>정기 위험성평가 작성</h1>
    <p>회차별(1~5회) 이력 관리 · 새로 작성 · 이어서 작성 · PDF 저장까지 한 번에</p>
  </div>

  <div class="section">
    <div class="note">
      <div class="small">
        <b>정기 위험성평가 운영</b><br>
        ① 완료된 공종은 제외하고 진행/예정 공종 중심으로 관리합니다.<br>
        ② 저장은 매번 새 문서(이력)로 남습니다. (회차별 최신 1건이 “이어서 작성” 기준)<br>
        ③ “이어서 작성”은 마지막 저장 상태(삭제/추가/수정)를 그대로 복원합니다.
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label>현장 선택</label>
          <select id="siteSelect">
            <option value="">현장을 선택하세요</option>
            <option value="paju-pmc">파주 PMC</option>
            <option value="ulsan-taehwagang">울산 태화강</option>
            <option value="ulsan-ujeong">울산 우정동</option>
            <option value="yeosu">여수</option>
          </select>
          <div class="hint">※ 현장 선택 시 정기 1~5회 이력(있/없음)을 자동으로 표시합니다.</div>
        </div>

        <div class="col">
          <label>정기 위험성평가 회차</label>
          <select id="roundSelect" disabled>
            <option value="">회차를 선택하세요</option>
            <option value="1">1회</option>
            <option value="2">2회</option>
            <option value="3">3회</option>
            <option value="4">4회</option>
            <option value="5">5회</option>
          </select>
          <div class="hint">※ 회차 선택 후 “새로/이어서”로 불러옵니다.</div>
        </div>

        <div class="col" style="min-width:280px">
          <div class="loading" id="loadingBar"><div class="spinner"></div>불러오는 중...</div>
          <div class="error" id="errorBox"></div>
        </div>
      </div>
    </div>

    <div class="card" id="historyCard" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <h2 style="margin:0;">정기 위험성평가 회차 이력 (1~5회)</h2>
        <span class="pill" id="historyPill">현장 선택 필요</span>
      </div>
      <div class="history-wrap" style="margin-top:12px;">
        <table class="history-table">
          <thead>
            <tr>
              <th style="min-width:70px;">회차</th>
              <th style="min-width:160px;">최근 저장일</th>
              <th style="min-width:100px;">상태</th>
              <th style="min-width:420px;">빠른 작업</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <div class="hint">※ 각 회차는 “최신 1건”이 이어서 작성 기준입니다. (여러 번 저장해도 최신이 우선)</div>
    </div>

    <div class="card" id="riskCard" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:12px;">
           <h2 style="margin:0;">① 기존 위험요인</h2>
           <button class="btn-batch-del" id="batchDelBtn" type="button">선택 항목 삭제</button>
        </div>
        <span class="badge" id="scopeBadge">정기 대상</span>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th class="chk-col"><input type="checkbox" id="selectAll"></th>
              <th style="min-width:60px;">No</th>
              <th style="min-width:220px;">작업내용</th>
              <th style="min-width:240px;">위험요인</th>
              <th style="min-width:120px;">위험등급</th>
              <th style="min-width:320px;">위험감소대책</th>
              <th style="min-width:110px;">관리</th>
            </tr>
          </thead>
          <tbody id="riskBody"></tbody>
        </table>
      </div>

      <div class="hint">※ “삭제”는 원본을 지우는 것이 아니라 이번 정기평가에서 제외하는 것입니다.</div>
    </div>

    <div class="card" id="extraCard" style="display:none;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <h2 style="margin:0;">② 추가 위험성평가 항목</h2>
        <button class="btn btn-add" id="addExtraBtn" type="button">+ 위험요인 추가</button>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
            <tr>
              <th style="min-width:60px;">No</th>
              <th style="min-width:220px;">작업내용</th>
              <th style="min-width:240px;">위험요인</th>
              <th style="min-width:120px;">위험등급</th>
              <th style="min-width:320px;">위험감소대책</th>
              <th style="min-width:110px;">관리</th>
            </tr>
          </thead>
          <tbody id="extraBody"></tbody>
        </table>
      </div>

      <div class="hint">※ 공정/작업방법 변경, 신규 장비/인원 투입 등 변화가 있으면 추가로 기록하세요.</div>
    </div>

    <div class="card" id="saveCard" style="display:none;">
      <div class="btns">
        <button class="btn btn-ghost" id="reloadInitialBtn" type="button">최초 데이터(엑셀) 불러오기</button>
        <button class="btn btn-ghost" id="pdfBtn" type="button">PDF 저장</button>
        <button class="btn btn-primary" id="saveBtn" type="button">정기 위험성평가 저장</button>
      </div>
      <div class="hint" id="saveHint">※ 저장하면 “새 문서(이력)”로 기록됩니다.</div>
    </div>
  </div>

  <div class="modal" id="choiceModal">
    <div class="modal-box">
      <h3 id="modalTitle">정기 위험성평가 불러오기</h3>
      <p id="choiceText">최근 정기 위험성평가가 있습니다. 새로 작성할까요, 이어서 작성할까요?</p>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="btnNew" type="button">새로 작성(최초 기준)</button>
        <button class="btn btn-primary" id="btnContinue" type="button">이어서 작성(최근 정기)</button>
      </div>
      <div class="hint" style="margin-top:10px;">
        * “새로 작성”은 최초 위험성평가(완료 공종 제외) 기준으로 다시 정리합니다.<br>
        * “이어서 작성”은 마지막 저장 상태(삭제/추가/수정)를 그대로 복원합니다.
      </div>
    </div>
  </div>

<script type="module">
import { collection, query, where, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* DOM */
const siteSelect = document.getElementById("siteSelect");
const roundSelect = document.getElementById("roundSelect");

const historyCard = document.getElementById("historyCard");
const historyBody = document.getElementById("historyBody");
const historyPill = document.getElementById("historyPill");

const riskCard = document.getElementById("riskCard");
const extraCard = document.getElementById("extraCard");
const saveCard = document.getElementById("saveCard");
const riskBody = document.getElementById("riskBody");
const extraBody = document.getElementById("extraBody");
const addExtraBtn = document.getElementById("addExtraBtn");
const saveBtn = document.getElementById("saveBtn");
const reloadInitialBtn = document.getElementById("reloadInitialBtn");
const pdfBtn = document.getElementById("pdfBtn");
const selectAll = document.getElementById("selectAll");
const batchDelBtn = document.getElementById("batchDelBtn");

const loadingBar = document.getElementById("loadingBar");
const errorBox = document.getElementById("errorBox");

const choiceModal = document.getElementById("choiceModal");
const btnNew = document.getElementById("btnNew");
const btnContinue = document.getElementById("btnContinue");
const choiceText = document.getElementById("choiceText");
const modalTitle = document.getElementById("modalTitle");

const scopeBadge = document.getElementById("scopeBadge");
const saveHint = document.getElementById("saveHint");

/* State */
let siteId = "";
let siteName = "";
let round = ""; // 1~5

let currentItems = [];
let extraItems = [];

let initialDocSnapCache = null;
let initialItemsCache = null;

// 회차별 최신 regular 캐시: { "1": docData, ... }
let regularLatestByRound = {};

// 모달에서 선택된 회차 기억
let modalRound = "";

/* UI */
function showLoading(on){ loadingBar.style.display = on ? "inline-flex" : "none"; }
function showError(msg){
  if(!msg){ errorBox.style.display="none"; errorBox.textContent=""; return; }
  errorBox.style.display="block";
  errorBox.textContent = msg;
}
function openModal(){ choiceModal.style.display="flex"; }
function closeModal(){ choiceModal.style.display="none"; }
function showMainUI(on){
  riskCard.style.display = on ? "block" : "none";
  extraCard.style.display = on ? "block" : "none";
  saveCard.style.display = on ? "block" : "none";
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}
function escapeTextarea(str){
  return String(str).replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* 위험등급 select */
function riskSelectHTML(v){
  const val = (v === "상" || v === "중" || v === "하") ? v : "중";
  const cls = val === "상" ? "high" : val === "중" ? "mid" : "low";
  return `
    <select class="risk-level ${cls}" data-role="riskLevel">
      <option value="상" ${val === "상" ? "selected" : ""}>상</option>
      <option value="중" ${val === "중" ? "selected" : ""}>중</option>
      <option value="하" ${val === "하" ? "selected" : ""}>하</option>
    </select>
  `;
}
function bindRiskLevelColor(root=document){
  root.querySelectorAll('select[data-role="riskLevel"]').forEach(sel=>{
    sel.addEventListener("change", ()=>{
      sel.classList.remove("high","mid","low");
      sel.classList.add(sel.value==="상"?"high":sel.value==="중"?"mid":"low");
    });
  });
}

/* createdAt 안전 변환 */
function toMillis(createdAt){
  try{
    if(!createdAt) return 0;
    if(typeof createdAt.toDate === "function") return createdAt.toDate().getTime();
    if(createdAt instanceof Date) return createdAt.getTime();
    if(typeof createdAt === "number") return createdAt;
    return 0;
  }catch{ return 0; }
}
function fmtDate(ms){
  if(!ms) return "-";
  return new Date(ms).toLocaleString("ko-KR");
}

/* UI -> state */
function syncFromUI(){
  const curRows = [...riskBody.querySelectorAll("tr")];
  currentItems = curRows.map(tr=>{
    const base = JSON.parse(tr.dataset.base || "{}");
    const lvl = tr.querySelector('select[data-role="riskLevel"]')?.value || (base.riskLevel||"중");
    const measuresTa = tr.querySelector('textarea[data-role="measures"]');
    const measures = (measuresTa?.value || "").split(/\n|,/).map(v=>v.trim()).filter(Boolean);
    return { ...base, riskLevel:lvl, measures, __extra:false };
  });

  const exRows = [...extraBody.querySelectorAll("tr")];
  extraItems = exRows.map(tr=>{
    const workContent = tr.querySelector('textarea[data-role="workContent"]')?.value || "";
    const hazard = tr.querySelector('textarea[data-role="hazard"]')?.value || "";
    const lvl = tr.querySelector('select[data-role="riskLevel"]')?.value || "중";
    const measuresText = tr.querySelector('textarea[data-role="measuresText"]')?.value || "";
    const measures = measuresText.split(/\n|,/).map(v=>v.trim()).filter(Boolean);
    return { workContent, hazard, riskLevel:lvl, measures, __extra:true };
  });
}

/* render */
function render(){
  scopeBadge.textContent = `${siteName} · 정기 ${round}회`;
  saveHint.textContent = `※ 저장하면 “정기 ${round}회” 이력으로 새 문서가 기록됩니다. 다음 접속 시 해당 회차의 최신 문서를 이어서 작성할 수 있습니다.`;
  selectAll.checked = false;

  riskBody.innerHTML = "";
  currentItems.forEach((d, idx)=>{
    const tr = document.createElement("tr");
    tr.dataset.base = JSON.stringify({ ...d, __extra:false });
    tr.innerHTML = `
      <td class="chk-col"><input type="checkbox" class="row-chk" data-idx="${idx}"></td>
      <td style="text-align:center;font-weight:900;">${idx+1}</td>
      <td>${escapeHtml(d.workContent||"")}</td>
      <td>${escapeHtml(d.hazard||"")}</td>
      <td>${riskSelectHTML(d.riskLevel||"중")}</td>
      <td><textarea data-role="measures" placeholder="대책(쉼표/줄바꿈 구분)">${escapeTextarea((d.measures||[]).join(", "))}</textarea></td>
      <td><button class="btn-delete" type="button" data-action="delCurrent" data-idx="${idx}">삭제</button></td>
    `;
    riskBody.appendChild(tr);
  });

  extraBody.innerHTML = "";
  extraItems.forEach((d, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:center;font-weight:900;">${idx+1}</td>
      <td><textarea data-role="workContent" placeholder="작업내용">${escapeTextarea(d.workContent||"")}</textarea></td>
      <td><textarea data-role="hazard" placeholder="위험요인">${escapeTextarea(d.hazard||"")}</textarea></td>
      <td>${riskSelectHTML(d.riskLevel||"중")}</td>
      <td><textarea data-role="measuresText" placeholder="대책(쉼표/줄바꿈 구분)">${escapeTextarea((d.measures||[]).join(", "))}</textarea></td>
      <td><button class="btn-delete" type="button" data-action="delExtra" data-idx="${idx}">삭제</button></td>
    `;
    extraBody.appendChild(tr);
  });

  bindRiskLevelColor(document);
  showMainUI(true);
  showError("");
}

/* =========================
    Firestore load (인덱스 없이)
========================= */

/** ✅ 현장 전체 regular를 읽어서 JS로 (round별 최신) 구성 -> 인덱스 필요 없음 */
async function fetchLatestRegularByRound(siteId){
  const q = query(
    collection(window.db, "periodicRiskAssessments"),
    where("siteId","==", siteId)
  );
  const snap = await getDocs(q);
  const all = [];
  snap.forEach(ds=>{
    const d = ds.data();
    if(!d) return;
    if(String(d.type||"").toLowerCase() !== "regular") return;
    all.push({ ...d, __id: ds.id });
  });

  const map = {}; // round -> latestDoc
  for(const doc of all){
    const r = String(doc.round || "").trim(); // round 없던 구버전 대비
    if(!r) continue;
    const cur = map[r];
    if(!cur){ map[r] = doc; continue; }
    if(toMillis(doc.createdAt) > toMillis(cur.createdAt)) map[r] = doc;
  }
  return map;
}

async function fetchInitialDoc(siteId){
  const q = query(
    collection(window.db, "initialRiskAssessments"),
    where("siteId","==", siteId)
  );
  const snap = await getDocs(q);
  return snap.empty ? null : snap.docs[0];
}

async function fetchInitialItems(initialDocSnap){
  // ✅ subcollection 읽기
  const { getDocs: _getDocs, collection: _collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
  const itemsSnap = await _getDocs(_collection(initialDocSnap.ref, "items"));
  const items = [];
  itemsSnap.forEach(ds=>{
    const v = ds.data();
    if(v?.workStatus === "completed") return;
    items.push({ ...v, __extra:false });
  });
  return items;
}

function splitSavedItems(items){
  const arr = Array.isArray(items) ? items : [];
  const hasFlag = arr.some(x => typeof x?.__extra === "boolean");
  if(hasFlag){
    return {
      cur: arr.filter(x=>!x.__extra).map(x=>({...x,__extra:false})),
      ext: arr.filter(x=>x.__extra).map(x=>({...x,__extra:true}))
    };
  }
  return { cur: arr.map(x=>({...x,__extra:false})), ext: [] };
}

/* =========================
    load actions
========================= */
async function ensureInitialLoaded(){
  if(initialDocSnapCache && initialItemsCache) return;
  initialDocSnapCache = await fetchInitialDoc(siteId);
  if(!initialDocSnapCache){
    initialItemsCache = null;
    return;
  }
  initialItemsCache = await fetchInitialItems(initialDocSnapCache);
}

async function loadFromInitial(){
  await ensureInitialLoaded();
  if(!initialDocSnapCache){
    showError("최초 위험성평가가 없습니다.\n먼저 최초 위험성평가를 등록해 주세요.");
    return;
  }
  currentItems = (initialItemsCache||[]).map(x=>({...x,__extra:false}));
  extraItems = [];
  render();
}

function loadFromLatestRegular(round){
  const doc = regularLatestByRound[String(round)];
  if(!doc){
    showError("해당 회차의 최근 정기 위험성평가를 찾지 못했습니다.\n새로 작성으로 진행해 주세요.");
    return;
  }
  const { cur, ext } = splitSavedItems(doc.items || []);
  currentItems = cur;
  extraItems = ext;
  render();
}

/* =========================
    회차 이력 UI
========================= */
function renderHistory(){
  historyCard.style.display = "block";
  historyPill.textContent = siteName ? `${siteName} · 정기 1~5회` : "현장 선택 필요";

  historyBody.innerHTML = "";
  for(let r=1; r<=5; r++){
    const docData = regularLatestByRound[String(r)];
    const ms = docData ? toMillis(docData.createdAt) : 0;
    const has = !!docData;

    const status = has
      ? `<span class="pill">저장됨</span>`
      : `<span class="pill dim">없음</span>`;

    const dateText = has ? fmtDate(ms) : "-";

    historyBody.innerHTML += `
      <tr>
        <td style="font-weight:900;">${r}회</td>
        <td>${dateText}</td>
        <td>${status}</td>
        <td style="text-align:left">
          <button class="btn btn-ghost" type="button" data-h-action="new" data-round="${r}">새로 작성(최초)</button>
          <button class="btn btn-primary" type="button" data-h-action="continue" data-round="${r}" ${has ? "" : "disabled"}>이어서 작성</button>
          <button class="btn btn-ghost" type="button" data-h-action="pdf" data-round="${r}" ${has ? "" : "disabled"}>PDF</button>
          <button class="btn btn-delete" type="button" data-h-action="delete" data-round="${r}" style="width:auto; padding:8px 10px; margin-left:5px" ${has ? "" : "disabled"}>이력 삭제</button>
        </td>
      </tr>
    `;
  }
}

/* =========================
    모달 제어
========================= */
function openRoundModal(r){
  modalRound = String(r);
  const docData = regularLatestByRound[modalRound];
  modalTitle.textContent = `정기 위험성평가 ${modalRound}회 불러오기`;

  if(docData){
    const ms = toMillis(docData.createdAt);
    const dtText = ms ? ` (저장: ${fmtDate(ms)})` : "";
    choiceText.textContent = `정기 ${modalRound}회 최근 문서가 있습니다${dtText}.\n새로 작성할까요, 이어서 작성할까요?`;
    btnContinue.disabled = false;
  }else{
    choiceText.textContent = `정기 ${modalRound}회 저장된 문서가 없습니다.\n최초 기준으로 새로 작성합니다.`;
    btnContinue.disabled = true;
  }
  openModal();
}

/* =========================
    PDF (print 기반, 한글 안정)
========================= */
function buildPDFHTML(docTitle, subtitle){
  // 현재 UI 상태를 반영하기 위해 먼저 sync
  syncFromUI();

  // 등급 색상
  const lvlColor = (v)=>{
    if(v==="상") return "#ef4444";
    if(v==="중") return "#f59e0b";
    return "#3b82f6";
  };

  const rows = [];
  const allItems = [
    ...currentItems.map(x=>({...x,__extra:false})),
    ...extraItems.map(x=>({...x,__extra:true}))
  ];

  allItems.forEach((it, idx)=>{
    const measures = Array.isArray(it.measures) ? it.measures.join(", ") : (it.measures||"");
    rows.push(`
      <tr>
        <td style="text-align:center;width:40px">${idx+1}</td>
        <td>${escapeHtml(it.workContent||"")}</td>
        <td>${escapeHtml(it.hazard||"")}</td>
        <td style="text-align:center;width:70px">
          <span style="display:inline-block;padding:4px 10px;border-radius:999px;color:#fff;font-weight:800;background:${lvlColor(it.riskLevel||"중")}">
            ${escapeHtml(it.riskLevel||"중")}
          </span>
        </td>
        <td>${escapeHtml(measures)}</td>
        <td style="text-align:center;width:64px">${it.__extra ? "추가" : "기존"}</td>
      </tr>
    `);
  });

  return `
  <!doctype html>
  <html lang="ko">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>${escapeHtml(docTitle)}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      @page { size: A4 portrait; margin: 12mm; }
      body{font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111;margin:0}
      .wrap{padding:0}
      .head{
        border:1px solid #111;border-radius:10px;padding:12px 14px;margin-bottom:10px
      }
      .title{font-size:18px;font-weight:900;text-align:center;margin:0 0 6px}
      .sub{font-size:12px;color:#333;text-align:center;margin:0}
      .meta{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:10px;font-size:12px}
      .meta div{min-width:180px}
      table{width:100%;border-collapse:collapse;font-size:10.5px}
      th,td{border:1px solid #111;padding:6px;vertical-align:top}
      th{background:#f1f4ff;text-align:center;font-weight:900}
      .foot{margin-top:10px;font-size:10px;color:#333}
      .nowrap{white-space:nowrap}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="head">
        <p class="title">${escapeHtml(docTitle)}</p>
        <p class="sub">${escapeHtml(subtitle)}</p>
        <div class="meta">
          <div><b>현장명</b> : ${escapeHtml(siteName||"-")}</div>
          <div><b>정기 회차</b> : ${escapeHtml(round||"-")}회</div>
          <div><b>출력일</b> : ${new Date().toLocaleDateString("ko-KR")}</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th class="nowrap">No</th>
            <th>작업내용</th>
            <th>위험요인</th>
            <th class="nowrap">위험등급</th>
            <th>위험감소대책</th>
            <th class="nowrap">구분</th>
          </tr>
        </thead>
        <tbody>
          ${rows.join("") || `<tr><td colspan="6" style="text-align:center;padding:16px">출력할 항목이 없습니다.</td></tr>`}
        </tbody>
      </table>

      <div class="foot">※ 본 보고서는 동진토건 협력업체 자체 정기 위험성평가 기록을 기반으로 출력되었습니다.</div>
    </div>

    <script>
      window.onload = () => { window.print(); };
    <\/script>
  </body>
  </html>
  `;
}

function openPDFWindow(){
  if(!siteId || !round){
    alert("현장과 회차를 선택한 후 PDF 저장을 누르세요.");
    return;
  }
  const win = window.open("", "_blank");
  const html = buildPDFHTML("정기 위험성평가 보고서", "회차별 정기 위험성평가 기록 (기존/추가 포함)");
  win.document.open();
  win.document.write(html);
  win.document.close();
}

/* =========================
    events
========================= */

// 현장 선택: 초기+회차이력 로딩
siteSelect.addEventListener("change", async ()=>{
  siteId = siteSelect.value;
  siteName = siteSelect.options[siteSelect.selectedIndex]?.text || "";
  round = "";
  roundSelect.value = "";
  roundSelect.disabled = !siteId;

  showError("");
  showMainUI(false);
  historyCard.style.display = "none";

  if(!siteId) return;

  showLoading(true);
  try{
    // 최초 캐시 reset
    initialDocSnapCache = null;
    initialItemsCache = null;

    // 현장의 회차별 최신 regular 구성
    regularLatestByRound = await fetchLatestRegularByRound(siteId);

    // 회차 이력 렌더
    renderHistory();

    showLoading(false);
  }catch(e){
    showLoading(false);
    console.error(e);
    showError("현장 이력 불러오기 실패:\n" + (e?.message || e));
  }
});

// 회차 선택: 모달 띄우기(새로/이어서 선택)
roundSelect.addEventListener("change", ()=>{
  round = roundSelect.value;
  if(!round) return;
  showMainUI(false);
  showError("");
  openRoundModal(round);
});

btnNew.addEventListener("click", async ()=>{
  closeModal();
  round = modalRound;
  roundSelect.value = round;
  showLoading(true);
  try{
    await loadFromInitial();
    showLoading(false);
  }catch(e){
    showLoading(false);
    console.error(e);
    showError("새로 작성 불러오기 실패:\n" + (e?.message || e));
  }
});

btnContinue.addEventListener("click", ()=>{
  closeModal();
  round = modalRound;
  roundSelect.value = round;
  loadFromLatestRegular(round);
});

// 회차 이력 버튼(새로/이어서/PDF/이력삭제)
historyBody.addEventListener("click", async (e)=>{
  const btn = e.target?.closest("button[data-h-action]");
  if(!btn) return;

  const action = btn.dataset.hAction;
  const r = btn.dataset.round;
  if(!r) return;

  // 회차 세팅
  round = String(r);

  if(action === "new"){
    roundSelect.value = round;
    // 즉시 새로작성 (모달 없이)
    showMainUI(false);
    showLoading(true);
    try{
      await loadFromInitial();
      showLoading(false);
    }catch(err){
      showLoading(false);
      console.error(err);
      showError("새로 작성 불러오기 실패:\n" + (err?.message || err));
    }
  }

  if(action === "continue"){
    roundSelect.value = round;
    showMainUI(false);
    showError("");
    loadFromLatestRegular(round);
  }

  if(action === "pdf"){
    // 해당 회차 최신 문서를 불러와서 PDF 출력 (현재 화면 상태 보존을 위해 별도 로딩)
    const docData = regularLatestByRound[String(round)];
    if(!docData){ alert("해당 회차 저장 문서가 없습니다."); return; }
    const { cur, ext } = splitSavedItems(docData.items || []);
    currentItems = cur;
    extraItems = ext;
    render();
    openPDFWindow();
  }

  if(action === "delete"){
    const docData = regularLatestByRound[String(round)];
    if(!docData) return;
    if(!confirm(`정기 ${round}회차의 저장된 이력을 삭제하시겠습니까?\n삭제 후에는 복구할 수 없습니다.`)) return;

    showLoading(true);
    try {
      await deleteDoc(doc(window.db, "periodicRiskAssessments", docData.__id));
      // 목록 갱신
      regularLatestByRound = await fetchLatestRegularByRound(siteId);
      renderHistory();
      showMainUI(false);
      alert("이력이 삭제되었습니다.");
    } catch (err) {
      console.error(err);
      alert("삭제 중 오류가 발생했습니다.");
    } finally {
      showLoading(false);
    }
  }
});

// 추가 위험요인
addExtraBtn.addEventListener("click", ()=>{
  syncFromUI();
  extraItems.push({ workContent:"", hazard:"", riskLevel:"중", measures:[], __extra:true });
  render();
});

// 최초 데이터(엑셀) 불러오기: 현재 작성 중인 내용 버리고 최초(Initial) 데이터로 리셋
reloadInitialBtn.addEventListener("click", async ()=>{
  if(!siteId || !round){ alert("현장과 회차를 선택하세요."); return; }
  const ok = confirm("현재 편집 중인 내용을 모두 지우고,\n해당 현장의 최초 위험성평가(엑셀) 데이터를 다시 불러올까요?");
  if(!ok) return;

  showMainUI(false);
  showLoading(true);
  try{
    await loadFromInitial();
    showLoading(false);
  }catch(e){
    showLoading(false);
    console.error(e);
    showError("데이터 로드 실패:\n" + (e?.message || e));
  }
});

// PDF 버튼: 현재 편집 상태 그대로 출력
pdfBtn.addEventListener("click", ()=>{
  openPDFWindow();
});

// 저장
saveBtn.addEventListener("click", async ()=>{
  if(!siteId || !round){
    alert("현장과 회차를 선택하세요.");
    return;
  }

  syncFromUI();

  // 추가항목 정리
  extraItems = extraItems
    .map(x=>({ ...x, workContent:(x.workContent||"").trim(), hazard:(x.hazard||"").trim() }))
    .filter(x=> x.workContent && x.hazard);

  const itemsToSave = [
    ...currentItems.map(x=>({...x,__extra:false})),
    ...extraItems.map(x=>({...x,__extra:true}))
  ];

  if(itemsToSave.length === 0){
    alert("저장할 항목이 없습니다.");
    return;
  }

  showError("");
  showLoading(true);

  try{
    await addDoc(collection(window.db,"periodicRiskAssessments"),{
      siteId,
      siteName,
      round,              // ✅ 회차 저장
      type: "regular",
      createdAt: new Date(),
      items: itemsToSave
    });

    // 저장 후 회차 이력 갱신
    regularLatestByRound = await fetchLatestRegularByRound(siteId);
    renderHistory();

    showLoading(false);
    alert(`정기 위험성평가 ${round}회 저장 완료!`);

    // 저장 직후 최신으로 다시 로딩
    loadFromLatestRegular(round);

  }catch(e){
    showLoading(false);
    console.error(e);
    showError("저장 실패:\n" + (e?.message || e));
  }
});

// 삭제 이벤트 위임 (개별 삭제 및 전체 선택 삭제)
document.addEventListener("click", (e)=>{
  const btn = e.target?.closest("button[data-action]");
  if(!btn) return;

  const action = btn.dataset.action;
  const idx = Number(btn.dataset.idx);
  
  syncFromUI();

  if(action === "delCurrent"){
    const ok = confirm("이 항목을 이번 정기 위험성평가에서 제외(삭제)할까요?");
    if(!ok) return;
    currentItems.splice(idx,1);
    render();
  }

  if(action === "delExtra"){
    const ok = confirm("추가 위험요인을 삭제할까요?");
    if(!ok) return;
    extraItems.splice(idx,1);
    render();
  }
});

// 전체 선택 기능
selectAll.addEventListener("change", (e) => {
  const isChecked = e.target.checked;
  riskBody.querySelectorAll(".row-chk").forEach(chk => chk.checked = isChecked);
});

// 선택 항목 일괄 삭제 버튼
batchDelBtn.addEventListener("click", () => {
  const checkedBoxes = [...riskBody.querySelectorAll(".row-chk:checked")];
  if(checkedBoxes.length === 0) {
    alert("삭제할 항목을 선택해주세요.");
    return;
  }
  if(!confirm(`선택한 ${checkedBoxes.length}개의 항목을 리스트에서 제외하시겠습니까?`)) return;

  syncFromUI();
  // 역순으로 지워야 인덱스 오류가 없음
  const indices = checkedBoxes.map(chk => Number(chk.dataset.idx)).sort((a,b) => b - a);
  indices.forEach(idx => currentItems.splice(idx, 1));
  render();
});

</script>

</body>
</html>