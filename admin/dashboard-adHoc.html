<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ê´€ë¦¬ì ì „ì²´ í˜„í™© | ìœ„í—˜ì„±í‰ê°€</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Sans KR",system-ui;background:#f4f7ff;color:#0b1b3b}
header{height:56px;background:#0b2a4f;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 18px;font-weight:800}

/* tabs */
.tabs{display:flex;gap:6px;padding:10px 14px;background:#e9efff;border-bottom:1px solid #cfd7ea}
.tab{padding:8px 14px;border-radius:8px;font-weight:800;font-size:13px;cursor:pointer;background:#fff;border:1px solid #ccd6f0}
.tab.active{background:#1f5bd8;color:#fff;border-color:#1f5bd8}

/* layout */
.layout{display:flex;height:calc(100vh - 56px - 54px)}
aside{width:200px;background:#155f7d;color:#fff;padding:12px;overflow:auto}
.site{padding:10px;border-radius:6px;cursor:pointer}
.site.active,.site:hover{background:#0e4b63}
main{flex:1;padding:14px;overflow:auto}

/* summary */
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
  margin-bottom:14px
}
.sum-card{
  background:#fff;
  border-radius:16px;
  padding:18px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  font-weight:800
}
.sum-card .label{font-size:14px;color:#475467}
.sum-card .value{font-size:26px;margin-top:6px}
.sum-total{background:#0b2a4f;color:#fff}
.sum-initial{background:#2563eb;color:#fff}
.sum-periodic{background:#facc15;color:#78350f}
.sum-adHoc{background:#ef4444;color:#fff}

/* TOP5 */
.top5{
  background:#fff;
  border-radius:16px;
  padding:18px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  margin-bottom:14px
}
.top5 h3{margin:0 0 10px;font-size:16px}
.top5 ol{margin:0;padding-left:20px;font-weight:700}
.top5 li{margin-bottom:6px}

/* table */
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 6px 16px rgba(0,0,0,.08)}
th{background:#eaf0ff;padding:10px;font-size:13px;text-align:left}
td{padding:8px;border-top:1px solid #e3e9ff;vertical-align:top;font-size:13px}

/* row colors */
tr.type-initial td{background:#f0f7ff}
tr.type-periodic td{background:#fefce8}
tr.type-adHoc td{background:#fff1f2}
tr:hover td{background:#e6edff}

/* common */
textarea{width:100%;min-height:60px;font-size:12.5px;padding:6px;border-radius:6px;border:1px solid #cbd6f2}
.save-btn{padding:6px 10px;border:none;border-radius:6px;background:#12b76a;color:#fff;font-weight:700;cursor:pointer;font-size:12px}
.toast{position:fixed;left:16px;bottom:16px;background:#0b1b3b;color:#fff;padding:10px 12px;border-radius:10px;display:none;font-size:13px}
</style>
</head>

<body>

<header>
  <div>ë™ì§„í† ê±´ ìœ„í—˜ì„±í‰ê°€ ê´€ë¦¬ì</div>
  <div>ADMIN</div>
</header>

<div class="tabs">
  <div class="tab active" data-type="initial">ìµœì´ˆ</div>
  <div class="tab" data-type="periodic">ì •ê¸°</div>
  <div class="tab" data-type="adHoc">ìˆ˜ì‹œ</div>
</div>

<div class="layout">
<aside id="siteList"></aside>

<main>

<!-- ===== ìš”ì•½ ===== -->
<div class="summary">
  <div id="sumTotal" class="sum-card sum-total"></div>
  <div id="sumInitial" class="sum-card sum-initial"></div>
  <div id="sumPeriodic" class="sum-card sum-periodic"></div>
  <div id="sumAdHoc" class="sum-card sum-adHoc"></div>
</div>

<!-- ===== TOP5 ===== -->
<div class="top5">
  <h3>ğŸ“Š í˜„ì¥ ìœ„í—˜ìš”ì¸ TOP 5</h3>
  <ol id="top5List"></ol>
</div>

<table>
<thead>
<tr>
  <th>êµ¬ë¶„</th>
  <th>íšŒì°¨/ì¼ì</th>
  <th>ìœ„í—˜ìš”ì¸</th>
  <th>ê°œì„ ëŒ€ì±…</th>
  <th style="width:240px">ë¹„ê³ (ê´€ë¦¬ì)</th>
  <th>ì €ì¥</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</main>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* firebase */
const app = initializeApp({
  apiKey:"AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  projectId:"dongjin-risk-system"
});
const db = getFirestore(app);

const siteListEl=document.getElementById("siteList");
const tbody=document.getElementById("tbody");
const toastEl=document.getElementById("toast");
const top5List=document.getElementById("top5List");

let currentSite="";
let currentType="initial";
let rawRows=[];

/* utils */
const CIRCLE=["â‘ ","â‘¡","â‘¢","â‘£","â‘¤","â‘¥","â‘¦","â‘§","â‘¨","â‘©"];
function toast(m){toastEl.textContent=m;toastEl.style.display="block";setTimeout(()=>toastEl.style.display="none",1500);}

/* tabs */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    currentType=t.dataset.type;
    if(currentSite) loadData();
  };
});

/* sites */
(async()=>{
  const snap=await getDocs(collection(db,"sites"));
  snap.forEach(d=>{
    if(!d.data().active)return;
    const div=document.createElement("div");
    div.className="site";
    div.textContent=d.data().siteName;
    div.onclick=()=>{
      document.querySelectorAll(".site").forEach(s=>s.classList.remove("active"));
      div.classList.add("active");
      currentSite=d.data().siteId;
      loadData();
    };
    siteListEl.appendChild(div);
  });
})();

/* load */
async function loadData(){
  rawRows=[];
  tbody.innerHTML="";
  top5List.innerHTML="";

  if(currentType==="initial"){
    const snap=await getDoc(doc(db,"initialRiskAssessments",currentSite));
    if(snap.exists()){
      snap.data().items.forEach((r,i)=>{
        rawRows.push({
          type:"initial",
          date:snap.data().evalDate||"",
          risk:`${CIRCLE[i]} ${r.ìœ„í—˜ìš”ì¸||""}`,
          solution:`${CIRCLE[i]} ${r.ìœ„í—˜ê°ì†ŒëŒ€ì±…||""}`,
          remark:snap.data().remark||"",
          path:["initialRiskAssessments",currentSite]
        });
      });
    }
  }

  if(currentType==="periodic"){
    const rounds=await getDocs(collection(db,"regularRiskAssessments",currentSite,"rounds"));
    rounds.forEach(rd=>{
      const d=rd.data();
      (d.items||[]).forEach((r,i)=>{
        rawRows.push({
          type:"periodic",
          date:`${d.round}ì°¨ (${d.evalDate||""})`,
          risk:`${CIRCLE[i]} ${r.ìœ„í—˜ìš”ì¸||""}`,
          solution:`${CIRCLE[i]} ${r.ìœ„í—˜ê°ì†ŒëŒ€ì±…||""}`,
          remark:d.remark||"",
          path:["regularRiskAssessments",currentSite,"rounds",rd.id]
        });
      });
    });
  }

  if(currentType==="adHoc"){
    const snap=await getDocs(collection(db,"riskAssessments","adHoc","items"));
    snap.forEach(d=>{
      if(d.data().siteId!==currentSite)return;
      (d.data().risks||[]).forEach((r,i)=>{
        rawRows.push({
          type:"adHoc",
          date:d.data().round||"",
          risk:`${CIRCLE[i]} ${r.risk||""}`,
          solution:`${CIRCLE[i]} ${r.solution||""}`,
          remark:d.data().remark||"",
          path:["riskAssessments","adHoc","items",d.id]
        });
      });
    });
  }

  updateSummary();
  updateTop5();
  render();
}

/* summary */
function updateSummary(){
  document.getElementById("sumTotal").innerHTML=`<div class="label">ì „ì²´ ìœ„í—˜ìš”ì¸</div><div class="value">${rawRows.length}ê±´</div>`;
  document.getElementById("sumInitial").innerHTML=`<div class="label">ìµœì´ˆ</div><div class="value">${rawRows.filter(r=>r.type==="initial").length}</div>`;
  document.getElementById("sumPeriodic").innerHTML=`<div class="label">ì •ê¸°</div><div class="value">${rawRows.filter(r=>r.type==="periodic").length}</div>`;
  document.getElementById("sumAdHoc").innerHTML=`<div class="label">ìˆ˜ì‹œ</div><div class="value">${rawRows.filter(r=>r.type==="adHoc").length}</div>`;
}

/* TOP5 */
function updateTop5(){
  const map={};
  rawRows.forEach(r=>{
    const key=r.risk.replace(/[â‘ -â‘©]/g,"").trim();
    if(!key)return;
    map[key]=(map[key]||0)+1;
  });
  Object.entries(map)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,5)
    .forEach(([k,v])=>{
      const li=document.createElement("li");
      li.textContent=`${k} (${v}íšŒ)`;
      top5List.appendChild(li);
    });
}

/* render */
function render(){
  tbody.innerHTML="";
  rawRows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.className=`type-${r.type}`;
    tr.innerHTML=`
      <td>${r.type}</td>
      <td>${r.date}</td>
      <td>${r.risk}</td>
      <td>${r.solution}</td>
      <td><textarea>${r.remark}</textarea></td>
      <td><button class="save-btn">ì €ì¥</button></td>
    `;
    tr.querySelector(".save-btn").onclick=async()=>{
      await updateDoc(doc(db,...r.path),{remark:tr.querySelector("textarea").value});
      toast("ì €ì¥ ì™„ë£Œ");
    };
    tbody.appendChild(tr);
  });
}
</script>

</body>
</html>
