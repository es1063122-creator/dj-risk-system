<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>위험성평가 상세보기 | 관리자 콘솔</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- jsPDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  authDomain: "dongjin-risk-system.firebaseapp.com",
  projectId: "dongjin-risk-system",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.db = db;
</script>

<style>
body{
  font-family:"Noto Sans KR",sans-serif;
  background:#f4f7ff;
  margin:0;
}
header{
  background:linear-gradient(135deg,#0b2a4f,#1f5bd8);
  color:#fff;
  padding:20px 30px;
}
main{
  padding:30px;
}
.card{
  background:#fff;
  border-radius:18px;
  padding:24px;
  box-shadow:0 15px 35px rgba(0,0,0,.08);
  margin-bottom:20px;
}
.card h2{
  margin-top:0;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
}
th{
  background:#eef3ff;
}
.actions{
  text-align:right;
  margin-bottom:20px;
}
button{
  background:#1f5bd8;
  color:#fff;
  border:none;
  padding:12px 24px;
  border-radius:24px;
  font-weight:700;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h1>위험성평가 상세보기</h1>
</header>

<main>
  <div class="actions">
    <button onclick="downloadPDF()">PDF 다운로드</button>
  </div>

  <div class="card">
    <h2 id="title">로딩 중...</h2>
    <p id="meta"></p>
  </div>

  <div class="card">
    <h3>위험요인 목록</h3>
    <table>
      <thead>
        <tr>
          <th>No</th>
          <th>세부공종</th>
          <th>작업내용</th>
          <th>위험요인</th>
          <th>위험등급</th>
          <th>위험감소대책</th>
        </tr>
      </thead>
      <tbody id="itemBody"></tbody>
    </table>
  </div>
</main>

<script type="module">
import {
  doc, getDoc, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params=new URLSearchParams(location.search);
const id=params.get("id"); // initialRiskAssessments 문서 ID

const headerSnap=await getDoc(doc(window.db,"initialRiskAssessments",id));
const header=headerSnap.data();

document.getElementById("title").innerText=
  `현장: ${header.siteName} / 최초 위험성평가`;
document.getElementById("meta").innerText=
  `작성일: ${header.createdAt?.toDate?.()?.toLocaleDateString() || ""}`;

const itemSnap=await getDocs(collection(window.db,"initialRiskAssessments",id,"items"));
const tbody=document.getElementById("itemBody");

const items=[];
itemSnap.forEach(docSnap=>{
  const d=docSnap.data();
  items.push(d);

  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>${d.no}</td>
    <td>${d.detailWork}</td>
    <td>${d.workContent}</td>
    <td>${d.hazard}</td>
    <td>${d.riskLevel}</td>
    <td>${d.measures.join(", ")}</td>
  `;
  tbody.appendChild(tr);
});

// PDF 생성
window.downloadPDF=()=>{
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF("p","mm","a4");

  pdf.setFontSize(16);
  pdf.text("현장별 최초 위험성평가",14,20);

  pdf.setFontSize(11);
  pdf.text(`현장명: ${header.siteName}`,14,30);
  pdf.text(`작성일: ${header.createdAt?.toDate?.()?.toLocaleDateString()}`,14,36);

  let y=45;
  items.forEach((it,i)=>{
    pdf.text(`${i+1}. ${it.hazard}`,14,y);
    y+=6;
    pdf.text(`- 작업내용: ${it.workContent}`,16,y); y+=6;
    pdf.text(`- 위험등급: ${it.riskLevel}`,16,y); y+=6;
    pdf.text(`- 대책: ${it.measures.join(", ")}`,16,y); y+=10;

    if(y>270){ pdf.addPage(); y=20; }
  });

  pdf.save(`위험성평가_${header.siteName}.pdf`);
};
</script>

</body>
</html>
