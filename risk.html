<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€ | ë™ì§„í† ê±´(ì£¼)</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --dj-blue:#004080;
      --dj-blue2:#2a6cf6;
      --bg:#f4f7ff;
      --ink:#0b1b3b;
      --muted:#667085;
      --card:#ffffff;
      --line:#e8ecf6;
      --good:#12b76a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow:0 12px 34px rgba(0,64,128,.14);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(1200px 600px at 10% 0%, rgba(42,108,246,.18), transparent 60%),
                 radial-gradient(900px 500px at 90% 0%, rgba(0,64,128,.16), transparent 55%),
                 var(--bg);
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:saturate(140%) blur(10px);
      background:rgba(244,247,255,.75);
      border-bottom:1px solid rgba(232,236,246,.9);
    }
    .topbar{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg,var(--dj-blue),var(--dj-blue2));
      box-shadow:0 10px 20px rgba(0,64,128,.22);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"DJ";
      position:absolute; inset:0;
      display:grid; place-items:center;
      color:#fff; font-weight:800; letter-spacing:.5px;
    }
    .brand .t{
      display:flex; flex-direction:column;
      line-height:1.1;
      min-width:0;
    }
    .brand .t b{font-size:15px}
    .brand .t span{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .actions{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .btn{
      appearance:none; border:0;
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      transition:.15s transform, .15s opacity, .15s box-shadow;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      color:#fff;
      background:linear-gradient(135deg,var(--dj-blue),var(--dj-blue2));
      box-shadow:0 10px 22px rgba(42,108,246,.28);
    }
    .btn-ghost{
      background:#fff;
      border:1px solid var(--line);
      color:var(--ink);
      box-shadow:0 10px 22px rgba(11,27,59,.06);
    }
    .btn-danger{
      background:#fff;
      border:1px solid rgba(239,68,68,.28);
      color:#b42318;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    main{max-width:1100px; margin:16px auto 40px; padding:0 16px}
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr; }
      header .actions{justify-content:flex-end}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      letter-spacing:-.2px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      background:rgba(42,108,246,.08);
      border:1px solid rgba(42,108,246,.18);
      color:var(--dj-blue);
      white-space:nowrap;
    }
    .badge .dot{width:8px;height:8px;border-radius:50%; background:var(--dj-blue2)}
    .help{
      margin:0 0 12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    label{
      display:block;
      font-size:13px;
      font-weight:800;
      color:#364152;
      margin-top:10px;
      margin-bottom:6px;
    }
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
      color:var(--ink);
      font-size:14px;
    }
    textarea{min-height:88px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(42,108,246,.45);
      box-shadow:0 0 0 4px rgba(42,108,246,.12);
    }
    .row{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .row3{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;
    }
    @media (max-width:520px){
      .row,.row3{grid-template-columns:1fr}
    }
    .hr{height:1px;background:var(--line); margin:14px 0}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:14px;
      background:rgba(11,27,59,.04);
      border:1px solid rgba(11,27,59,.08);
      font-size:12px;
      color:#344054;
      font-weight:800;
    }

    /* Tables */
    .table-wrap{
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:860px;
    }
    thead th{
      position:sticky; top:0; z-index:5;
      background:#f7f9ff;
      font-size:12px;
      color:#344054;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:hover{background:rgba(42,108,246,.04)}
    .center{text-align:center}
    .right{text-align:right}
    .small{font-size:12px;color:var(--muted)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 9px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .tag.low{background:rgba(18,183,106,.10); border-color:rgba(18,183,106,.22); color:#027a48}
    .tag.med{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.25); color:#b45309}
    .tag.high{background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.22); color:#b42318}
    .mini-actions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-top:10px;
    }
    .mini-actions .btn{padding:9px 10px; border-radius:12px; font-weight:900}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#111827; color:#fff;
      padding:12px 14px; border-radius:14px;
      box-shadow:0 14px 34px rgba(0,0,0,.22);
      font-size:13px;
      opacity:0; pointer-events:none;
      transition:.22s opacity, .22s transform;
      z-index:50;
      max-width: min(720px, calc(100% - 24px));
      width:max-content;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}
    .overlay{
      position:fixed; inset:0; z-index:60;
      display:none;
      background:rgba(11,27,59,.35);
      backdrop-filter: blur(6px);
      align-items:center; justify-content:center;
      padding:18px;
    }
    .overlay.show{display:flex}
    .loadingBox{
      width:min(520px,100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      padding:18px;
    }
    .loadingTitle{
      font-weight:900;
      margin:0 0 8px;
      display:flex; align-items:center; gap:10px;
    }
    .spinner{
      width:18px; height:18px;
      border-radius:50%;
      border:3px solid rgba(42,108,246,.22);
      border-top-color: var(--dj-blue2);
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loadingDesc{margin:0; color:var(--muted); font-size:13px; line-height:1.5}

    /* Signature */
    .sig-wrap{
      border:1px dashed rgba(42,108,246,.35);
      border-radius:16px;
      background:rgba(42,108,246,.04);
      padding:12px;
    }
    .sig-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .sig-top .hint{font-size:12px;color:var(--muted)}
    canvas#sigCanvas{
      width:100%;
      height:160px;
      background:#fff;
      border-radius:14px;
      border:1px solid rgba(232,236,246,.9);
      touch-action:none; /* í•µì‹¬: ëª¨ë°”ì¼ ì„œëª… */
    }
    .sig-actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="t">
        <b>ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€</b>
        <span>ì´ë²¤íŠ¸(ë³€ê²½Â·ì‚¬ê³ Â·ê¸°ìƒ ë“±) ë°œìƒ ì‹œ ì¦‰ì‹œ í‰ê°€ Â· ì „íŒŒ Â· ì¦ë¹™</span>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" id="btnReset" type="button">ì´ˆê¸°í™”</button>
      <button class="btn btn-primary" id="btnSubmit" type="button">ì €ì¥(ì œì¶œ)</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT: ê¸°ë³¸ì •ë³´/íŠ¸ë¦¬ê±°/ì „íŒŒ/ì„œëª… -->
    <section class="card">
      <h2>
        <span>â‘  ê¸°ë³¸ì •ë³´ & ìˆ˜ì‹œ ì‚¬ìœ </span>
        <span class="badge"><span class="dot"></span> AD-HOC</span>
      </h2>
      <p class="help">
        ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€ëŠ” â€œì™œ ë‹¤ì‹œ í–ˆëŠ”ì§€(ì‚¬ìœ )â€ì™€ â€œì¦‰ì‹œ ì¡°ì¹˜ ì—¬ë¶€â€ê°€ í•µì‹¬ ì¦ë¹™ì…ë‹ˆë‹¤.
        í˜„ì¥Â·í‰ê°€ìÂ·ë°œìƒ ì‚¬ìœ ë¥¼ ì •í™•íˆ ê¸°ë¡í•˜ì„¸ìš”.
      </p>

      <label>í˜„ì¥</label>
      <select id="siteSelect"></select>

      <div class="row">
        <div>
          <label>í‰ê°€ì¼ì</label>
          <input id="evalDate" type="date" />
        </div>
        <div>
          <label>í‰ê°€ì(ì‘ì„±ì)</label>
          <input id="evaluator" type="text" placeholder="ì˜ˆ: ê¹€ëŒ€í™" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>ë°œìƒì¼ì(ì‚¬ìœ  ë°œìƒ)</label>
          <input id="eventDate" type="datetime-local" />
        </div>
        <div>
          <label>ìˆ˜ì‹œ ì‚¬ìœ (íŠ¸ë¦¬ê±°)</label>
          <select id="triggerType">
            <option value="">ì„ íƒ</option>
            <option value="near_miss">ì•„ì°¨ì‚¬ê³ /ê·¼ì ‘ì‚¬ê³ </option>
            <option value="accident">ì‚¬ê³  ë°œìƒ</option>
            <option value="method_change">ê³µë²•/ì‘ì—…ë°©ë²• ë³€ê²½</option>
            <option value="equipment_change">ì¥ë¹„ ì‹ ê·œíˆ¬ì…/êµì²´</option>
            <option value="worker_change">ì‘ì—…ì/í•˜ë„ê¸‰ ë³€ê²½</option>
            <option value="weather">ê¸°ìƒ ì•…í™”(ìš°ì²œ/ê°•í’/í­ì—¼ ë“±)</option>
            <option value="guideline_change">ë²•/ì§€ì¹¨ ë³€ê²½</option>
            <option value="manager_judgement">ê´€ë¦¬ì íŒë‹¨(ê¸°íƒ€)</option>
          </select>
        </div>
      </div>

      <label>ì‚¬ìœ  ìƒì„¸(í•„ìˆ˜)</label>
      <textarea id="triggerDetail" placeholder="ì˜ˆ: ê°•í’ ì˜ˆë³´ë¡œ ê³ ì†Œì‘ì—… ìœ„í—˜ ì¦ê°€ â†’ ì‘ì—…ë°©ë²• ë³€ê²½ ë° ì¶”ë½ë°©ì§€ ì¬ì ê²€"></textarea>

      <div class="hr"></div>

      <h2 style="margin-top:0">
        <span>â‘¡ ì¦‰ì‹œì¡°ì¹˜ & ì „íŒŒ í™•ì¸</span>
        <span class="pill" id="timeGapPill">ì‹œê°„ì°¨: -</span>
      </h2>

      <div class="row">
        <div>
          <label>ì¦‰ì‹œ ì¡°ì¹˜</label>
          <select id="actionStatus">
            <option value="done">ì¦‰ì‹œ ì¡°ì¹˜ ì™„ë£Œ</option>
            <option value="planned">ì¡°ì¹˜ ì˜ˆì •</option>
            <option value="ongoing">ì¡°ì¹˜ ì§„í–‰ì¤‘</option>
          </select>
        </div>
        <div>
          <label>ì¡°ì¹˜ ì˜ˆì •ì¼(ì„ íƒ)</label>
          <input id="actionDue" type="date" />
        </div>
      </div>

      <label>ì¡°ì¹˜ë‚´ìš©(í•„ìˆ˜)</label>
      <textarea id="actionDetail" placeholder="ì˜ˆ: ì¶”ë½ë°©ì§€ ë‚œê°„ ë³´ê°•, ì•ˆì „ëŒ€ ê±¸ì´ì  ì„¤ì¹˜, ì‘ì—…ì¤‘ì§€ í›„ ì¬êµìœ¡ ì‹¤ì‹œ"></textarea>

      <div class="row">
        <div>
          <label>ì „íŒŒ(ì‘ì—…ìì—ê²Œ ì•ˆë‚´ ì™„ë£Œ)</label>
          <select id="sharedToWorkers">
            <option value="yes">ì˜ˆ</option>
            <option value="no">ì•„ë‹ˆì˜¤</option>
          </select>
        </div>
        <div>
          <label>í™•ì¸(ê´€ë¦¬ê°ë…ì í™•ì¸)</label>
          <select id="confirmedBySupervisor">
            <option value="yes">ì˜ˆ</option>
            <option value="no">ì•„ë‹ˆì˜¤</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0">â‘¢ ì„œëª…(ëª¨ë°”ì¼ ìµœì í™”)</h2>
      <div class="sig-wrap">
        <div class="sig-top">
          <div class="hint">ì†ê°€ë½/íœìœ¼ë¡œ ì„œëª…í•˜ì„¸ìš” (ëª¨ë°”ì¼: í„°ì¹˜ ì§€ì›)</div>
          <div class="sig-actions">
            <button class="btn btn-ghost" type="button" id="btnSigClear">ì„œëª… ì§€ìš°ê¸°</button>
            <button class="btn btn-ghost" type="button" id="btnSigFit">ìº”ë²„ìŠ¤ ë§ì¶¤</button>
          </div>
        </div>
        <canvas id="sigCanvas"></canvas>
        <div class="small" style="margin-top:10px;">
          * ì €ì¥ ì‹œ ì„œëª… ì´ë¯¸ì§€ê°€ í•¨ê»˜ ê¸°ë¡ë©ë‹ˆë‹¤.
        </div>
      </div>
    </section>

    <!-- RIGHT: ìœ„í—˜ìš”ì¸ ë¶ˆëŸ¬ì˜¤ê¸°/ì„ íƒ/ì¶”ê°€ -->
    <section class="card">
      <h2>
        <span>â‘£ ìœ„í—˜ìš”ì¸ ì„ íƒ(ê¸°ì¡´ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°) + ì¶”ê°€</span>
        <span class="small">ìˆ˜ì‹œëŠ” â€œì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°â€ë³´ë‹¤ â€œí•„ìš”í•œ ê²ƒë§Œ ì„ íƒâ€ì´ ì›ì¹™</span>
      </h2>

      <p class="help">
        ì•„ë˜ì—ì„œ <b>ê¸°ì¡´(ìµœì´ˆ/ì •ê¸°) ìœ„í—˜ìš”ì¸</b>ì„ ê¸°ê°„ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•œ ë’¤ ì²´í¬í•´ì„œ ê°€ì ¸ì˜¤ê³ ,
        ì´ë²ˆ ìˆ˜ì‹œì—ì„œë§Œ ìƒê¸´ ìœ„í—˜ìš”ì¸ì€ <b>ì§ì ‘ ì¶”ê°€</b>í•˜ì„¸ìš”.
      </p>

      <div class="row3">
        <div>
          <label>ì¡°íšŒ ì‹œì‘ì¼</label>
          <input id="fromDate" type="date" />
        </div>
        <div>
          <label>ì¡°íšŒ ì¢…ë£Œì¼</label>
          <input id="toDate" type="date" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn btn-ghost" id="btnLoadExisting" type="button" style="width:100%;">ê¸°ì¡´ ìœ„í—˜ìš”ì¸ ì¡°íšŒ</button>
        </div>
      </div>

      <div class="mini-actions">
        <button class="btn btn-ghost" id="btnPickSelected" type="button">ì„ íƒí•œ í•­ëª© ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn btn-danger" id="btnDeletePicked" type="button">ì„ íƒ ì‚­ì œ</button>
        <span class="small" id="existingCount">ì¡°íšŒ 0ê±´</span>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
          <tr>
            <th class="center" style="min-width:50px;">
              <input type="checkbox" id="chkAllExisting" />
            </th>
            <th style="min-width:70px;">ì¼ì</th>
            <th style="min-width:220px;">ì‘ì—…ë‚´ìš©</th>
            <th style="min-width:260px;">ìœ„í—˜ìš”ì¸</th>
            <th style="min-width:120px;">ìœ„í—˜ë„</th>
            <th style="min-width:320px;">ìœ„í—˜ê°ì†ŒëŒ€ì±…</th>
            <th style="min-width:120px;">ì¶œì²˜</th>
          </tr>
          </thead>
          <tbody id="existingBody"></tbody>
        </table>
      </div>

      <div class="hr"></div>

      <h2 style="margin-top:0">â‘¤ ìˆ˜ì‹œ ìœ„í—˜ìš”ì¸ ëª©ë¡(ì œì¶œ ëŒ€ìƒ)</h2>

      <div class="mini-actions">
        <button class="btn btn-ghost" id="btnAddManual" type="button">ì§ì ‘ ì¶”ê°€</button>
        <span class="small" id="pickedCount">í˜„ì¬ 0ê±´</span>
      </div>

      <div class="table-wrap" style="margin-top:12px;">
        <table>
          <thead>
          <tr>
            <th class="center" style="min-width:50px;">
              <input type="checkbox" id="chkAllPicked" />
            </th>
            <th style="min-width:60px;">No</th>
            <th style="min-width:220px;">ì‘ì—…ë‚´ìš©</th>
            <th style="min-width:260px;">ìœ„í—˜ìš”ì¸</th>
            <th style="min-width:110px;">ë¹ˆë„</th>
            <th style="min-width:110px;">ê°•ë„</th>
            <th style="min-width:120px;">ìœ„í—˜ë„</th>
            <th style="min-width:360px;">ìœ„í—˜ê°ì†ŒëŒ€ì±…</th>
            <th style="min-width:120px;">ì¶œì²˜</th>
          </tr>
          </thead>
          <tbody id="pickedBody"></tbody>
        </table>
      </div>

      <div class="hr"></div>

      <div class="help" style="margin:0;">
        âœ… ì œì¶œ ì‹œ Firestore <b>risk_assessments</b> ì»¬ë ‰ì…˜ì— <b>type="ad-hoc"</b>ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.<br>
        âœ… ê¸°ì¡´ ìœ„í—˜ìš”ì¸ ì¡°íšŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ <b>risk_items</b> ì»¬ë ‰ì…˜ì„ ì¡°íšŒí•©ë‹ˆë‹¤(ì•„ë˜ JSì—ì„œ ì»¬ë ‰ì…˜ëª… ë³€ê²½ ê°€ëŠ¥).
      </div>
    </section>
  </div>
</main>

<div class="overlay" id="overlay">
  <div class="loadingBox">
    <div class="loadingTitle"><span class="spinner"></span><span id="loadingTitle">ì²˜ë¦¬ ì¤‘â€¦</span></div>
    <p class="loadingDesc" id="loadingDesc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase (v10 modular) -->
<script type="module">
  /******************************************************
   * âœ… 0) Firebase ì„¤ì • (ë³¸ì¸ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´)
   ******************************************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp, getDocs,
    query, where, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // (ì„ íƒ) ì„œëª…ì„ Storageì— ì˜¬ë¦¬ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ + rules í™•ì¸
  // import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  authDomain: "dongjin-risk-system.firebaseapp.com",
  projectId: "dongjin-risk-system",
  storageBucket: "dongjin-risk-system.appspot.com",
  messagingSenderId: "419989869270",
  appId: "1:419989869270:web:b1d2dae3d82a7110732f77"
};


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  // const storage = getStorage(app);

  /******************************************************
   * âœ… 1) ì»¬ë ‰ì…˜ëª…(í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
   ******************************************************/
  const COL_SITES = "sites";              // í˜„ì¥ ëª©ë¡
  const COL_EXISTING_RISK_ITEMS = "risk_items"; // ê¸°ì¡´(ìµœì´ˆ/ì •ê¸°) ìœ„í—˜ìš”ì¸ ì €ì¥ ì»¬ë ‰ì…˜(ë‹¹ì‹  ì‹œìŠ¤í…œì— ë§ê²Œ ë³€ê²½)
  const COL_RISK_ASSESSMENTS = "risk_assessments"; // ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€ ì €ì¥ ì»¬ë ‰ì…˜

  /******************************************************
   * âœ… 2) DOM
   ******************************************************/
  const $ = (id) => document.getElementById(id);

  const siteSelect = $("siteSelect");
  const evalDate = $("evalDate");
  const eventDate = $("eventDate");
  const evaluator = $("evaluator");
  const triggerType = $("triggerType");
  const triggerDetail = $("triggerDetail");

  const actionStatus = $("actionStatus");
  const actionDue = $("actionDue");
  const actionDetail = $("actionDetail");

  const sharedToWorkers = $("sharedToWorkers");
  const confirmedBySupervisor = $("confirmedBySupervisor");
  const timeGapPill = $("timeGapPill");

  const fromDate = $("fromDate");
  const toDate = $("toDate");
  const btnLoadExisting = $("btnLoadExisting");
  const existingBody = $("existingBody");
  const chkAllExisting = $("chkAllExisting");
  const existingCount = $("existingCount");

  const btnPickSelected = $("btnPickSelected");
  const btnDeletePicked = $("btnDeletePicked");
  const pickedBody = $("pickedBody");
  const chkAllPicked = $("chkAllPicked");
  const btnAddManual = $("btnAddManual");
  const pickedCount = $("pickedCount");

  const btnSubmit = $("btnSubmit");
  const btnReset = $("btnReset");

  const overlay = $("overlay");
  const loadingTitle = $("loadingTitle");
  const loadingDesc = $("loadingDesc");
  const toast = $("toast");

  /******************************************************
   * âœ… 3) ìœ í‹¸
   ******************************************************/
  function showLoading(title="ì²˜ë¦¬ ì¤‘â€¦", desc="ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”."){
    loadingTitle.textContent = title;
    loadingDesc.textContent = desc;
    overlay.classList.add("show");
  }
  function hideLoading(){ overlay.classList.remove("show"); }
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 2200);
  }
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function nowLocalDatetime(){
    // datetime-local í˜•ì‹: YYYY-MM-DDTHH:mm
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }
  function parseDateOrNull(v){
    if(!v) return null;
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }
  function hoursGapText(){
    const ev = parseDateOrNull(eventDate.value);
    if(!ev){ timeGapPill.textContent = "ì‹œê°„ì°¨: -"; return; }
    const now = new Date();
    const diffMs = now.getTime() - ev.getTime();
    const sign = diffMs >= 0 ? "" : "-";
    const abs = Math.abs(diffMs);
    const hrs = Math.floor(abs / (1000*60*60));
    const mins = Math.floor((abs % (1000*60*60)) / (1000*60));
    timeGapPill.textContent = `ì‹œê°„ì°¨: ${sign}${hrs}ì‹œê°„ ${mins}ë¶„`;
  }
  eventDate.addEventListener("input", hoursGapText);
  setInterval(hoursGapText, 30000);

  /******************************************************
   * âœ… 4) ìœ„í—˜ë„ ê³„ì‚°(ë¹ˆë„Ã—ê°•ë„)
   ******************************************************/
  function riskScore(freq, sev){
    const f = Number(freq||0), s = Number(sev||0);
    return f*s;
  }
  function riskLevelTag(score){
    // ê¸°ì¤€ì€ í˜„ì¥ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ê¸°ë³¸ê°’ ì œê³µ
    // 1~4: ë‚®ìŒ / 5~9: ì¤‘ê°„ / 10~25: ë†’ìŒ
    if(score >= 10) return { cls:"high", text:"ë†’ìŒ" };
    if(score >= 5)  return { cls:"med",  text:"ì¤‘ê°„" };
    return { cls:"low", text:"ë‚®ìŒ" };
  }

  /******************************************************
   * âœ… 5) ìƒíƒœ (existing, picked)
   ******************************************************/
  let existingRows = []; // ì¡°íšŒ ê²°ê³¼
  let pickedRows = [];   // ì œì¶œ ëŒ€ìƒ

  function renderExisting(){
    existingBody.innerHTML = "";
    existingCount.textContent = `ì¡°íšŒ ${existingRows.length}ê±´`;

    if(existingRows.length === 0){
      existingBody.innerHTML = `<tr><td colspan="7" class="center small">ì¡°íšŒëœ ìœ„í—˜ìš”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    for(const row of existingRows){
      const tr = document.createElement("tr");
      const lvl = riskLevelTag(Number(row.score||0));
      tr.innerHTML = `
        <td class="center"><input type="checkbox" class="chkExisting" data-id="${row._id}"></td>
        <td>${row.date || "-"}</td>
        <td>${escapeHtml(row.task || "")}</td>
        <td>${escapeHtml(row.hazard || "")}</td>
        <td><span class="tag ${lvl.cls}">${lvl.text} (${row.score ?? "-"})</span></td>
        <td>${escapeHtml(row.measure || "")}</td>
        <td class="small">${escapeHtml(row.source || "ê¸°ì¡´")}</td>
      `;
      existingBody.appendChild(tr);
    }
  }

  function renderPicked(){
    pickedBody.innerHTML = "";
    pickedCount.textContent = `í˜„ì¬ ${pickedRows.length}ê±´`;

    if(pickedRows.length === 0){
      pickedBody.innerHTML = `<tr><td colspan="9" class="center small">ì œì¶œí•  ìœ„í—˜ìš”ì¸ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤. (ê¸°ì¡´ì—ì„œ ì„ íƒ ë˜ëŠ” ì§ì ‘ ì¶”ê°€)</td></tr>`;
      return;
    }

    pickedRows.forEach((row, idx) => {
      const tr = document.createElement("tr");
      const score = riskScore(row.freq, row.sev);
      const lvl = riskLevelTag(score);
      tr.innerHTML = `
        <td class="center"><input type="checkbox" class="chkPicked" data-idx="${idx}"></td>
        <td class="center">${idx+1}</td>
        <td>
          <input type="text" value="${escapeAttr(row.task||"")}" data-k="task" data-idx="${idx}" class="editPicked">
        </td>
        <td>
          <input type="text" value="${escapeAttr(row.hazard||"")}" data-k="hazard" data-idx="${idx}" class="editPicked">
        </td>
        <td>
          <select data-k="freq" data-idx="${idx}" class="editPicked">
            ${opt15(row.freq)}
          </select>
        </td>
        <td>
          <select data-k="sev" data-idx="${idx}" class="editPicked">
            ${opt15(row.sev)}
          </select>
        </td>
        <td><span class="tag ${lvl.cls}">${lvl.text} (${score})</span></td>
        <td>
          <input type="text" value="${escapeAttr(row.measure||"")}" data-k="measure" data-idx="${idx}" class="editPicked">
          <div class="small" style="margin-top:6px;">â€» ìˆ˜ì‹œ ì¡°ì¹˜/ëŒ€ì±…ì€ í˜„ì¥ìƒí™©ì— ë§ê²Œ ìˆ˜ì •</div>
        </td>
        <td class="small">${escapeHtml(row.source||"ìˆ˜ì‹œ")}</td>
      `;
      pickedBody.appendChild(tr);
    });
  }

  function opt15(v){
    const val = Number(v||3);
    let html = "";
    for(let i=1;i<=5;i++){
      html += `<option value="${i}" ${i===val?"selected":""}>${i}</option>`;
    }
    return html;
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){ return escapeHtml(str).replaceAll("\n"," "); }

  // picked ì¸ë¼ì¸ í¸ì§‘ ë°˜ì˜
  pickedBody.addEventListener("input", (e)=>{
    const el = e.target;
    if(!el.classList.contains("editPicked")) return;
    const idx = Number(el.dataset.idx);
    const k = el.dataset.k;
    if(!pickedRows[idx]) return;
    pickedRows[idx][k] = (el.tagName === "SELECT") ? Number(el.value) : el.value;
    renderPicked(); // ìœ„í—˜ë„ ê°±ì‹ 
  });
  pickedBody.addEventListener("change", (e)=>{
    const el = e.target;
    if(!el.classList.contains("editPicked")) return;
    const idx = Number(el.dataset.idx);
    const k = el.dataset.k;
    if(!pickedRows[idx]) return;
    pickedRows[idx][k] = (el.tagName === "SELECT") ? Number(el.value) : el.value;
    renderPicked();
  });

  /******************************************************
   * âœ… 6) ì‚¬ì´íŠ¸ ë¡œë“œ
   ******************************************************/
async function loadSites(){
  showLoading("í˜„ì¥ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦", "sites ì»¬ë ‰ì…˜ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤.");
  try{
    const snap = await getDocs(
      collection(db, COL_SITES)
    );

    console.log("sites count =", snap.size); // ğŸ” ë””ë²„ê·¸ìš©

      const sites = [];
      snap.forEach(doc=>{
        const d = doc.data();
        sites.push({ id: doc.id, name: d.name || doc.id });
      });

      // sites ì»¬ë ‰ì…˜ì— name í•„ë“œê°€ ì—†ë‹¤ë©´, idë¡œë¼ë„ ë³´ì´ê²Œ
      siteSelect.innerHTML = `<option value="">í˜„ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>` +
        sites.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");

      hideLoading();
    }catch(err){
      console.error(err);
      hideLoading();
      showToast("í˜„ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: Firebase ì„¤ì •/ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
    }
  }

  /******************************************************
   * âœ… 7) ê¸°ì¡´ ìœ„í—˜ìš”ì¸ ì¡°íšŒ (ê¸°ê°„ + í˜„ì¥)
   *  - ê¸°ë³¸: COL_EXISTING_RISK_ITEMS = risk_items
   *  - í•„ìš”í•˜ë©´ ì»¬ë ‰ì…˜ëª…/í•„ë“œëª…ë§Œ ë§ì¶°ì£¼ë©´ ë¨
   ******************************************************/
  async function loadExistingRisks(){
    const siteId = siteSelect.value;
    if(!siteId){ showToast("í˜„ì¥ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }

    const f = fromDate.value;
    const t = toDate.value;
    if(!f || !t){ showToast("ì¡°íšŒ ì‹œì‘ì¼/ì¢…ë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
    if(f > t){ showToast("ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤."); return; }

    showLoading("ê¸°ì¡´ ìœ„í—˜ìš”ì¸ ì¡°íšŒ ì¤‘â€¦", "ê¸°ê°„Â·í˜„ì¥ ì¡°ê±´ìœ¼ë¡œ ìœ„í—˜ìš”ì¸ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.");

    try{
      // â—ë‹¹ì‹  ì‹œìŠ¤í…œì˜ í•„ë“œëª…ì— ë§ì¶° ë³€ê²½ ê°€ëŠ¥:
      // siteId: í˜„ì¥ID, date: 'YYYY-MM-DD' ë¬¸ìì—´(ê¶Œì¥)
      const qy = query(
        collection(db, COL_EXISTING_RISK_ITEMS),
        where("siteId","==",siteId),
        where("date",">=",f),
        where("date","<=",t),
        orderBy("date","desc"),
        limit(400)
      );

      const snap = await getDocs(qy);

      existingRows = [];
      snap.forEach(doc=>{
        const d = doc.data();
        existingRows.push({
          _id: doc.id,
          date: d.date || "",
          task: d.task || d.work || "",
          hazard: d.hazard || d.riskFactor || "",
          measure: d.measure || d.countermeasure || "",
          // scoreëŠ” ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ freq*sevë¡œ ê³„ì‚°(ìˆì„ ë•Œ)
          score: (d.score != null) ? d.score : riskScore(d.freq, d.sev),
          freq: d.freq ?? 3,
          sev: d.sev ?? 3,
          source: d.type ? `ê¸°ì¡´(${d.type})` : "ê¸°ì¡´"
        });
      });

      renderExisting();
      hideLoading();
      showToast(`ì¡°íšŒ ì™„ë£Œ: ${existingRows.length}ê±´`);
    }catch(err){
      console.error(err);
      hideLoading();
      showToast("ì¡°íšŒ ì‹¤íŒ¨: ì»¬ë ‰ì…˜ëª…/í•„ë“œëª…/ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
    }
  }

  /******************************************************
   * âœ… 8) ê¸°ì¡´ì—ì„œ ì„ íƒ ê°€ì ¸ì˜¤ê¸° / ì„ íƒ ì‚­ì œ
   ******************************************************/
  function pickSelectedFromExisting(){
    const checks = Array.from(document.querySelectorAll(".chkExisting")).filter(c=>c.checked);
    if(checks.length === 0){ showToast("ê°€ì ¸ì˜¬ í•­ëª©ì„ ì²´í¬í•˜ì„¸ìš”."); return; }

    const ids = new Set(checks.map(c=>c.dataset.id));
    const picked = existingRows.filter(r=>ids.has(r._id));

    // ì¤‘ë³µ ë°©ì§€(ê°™ì€ _id ê¸°ë°˜)
    const existIds = new Set(pickedRows.map(r=>r._srcId).filter(Boolean));
    const toAdd = picked
      .filter(r=>!existIds.has(r._id))
      .map(r=>({
        task: r.task,
        hazard: r.hazard,
        measure: r.measure,
        freq: Number(r.freq||3),
        sev: Number(r.sev||3),
        source: r.source || "ê¸°ì¡´",
        _srcId: r._id
      }));

    pickedRows = [...pickedRows, ...toAdd];
    renderPicked();
    showToast(`ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ: +${toAdd.length}ê±´`);
  }

  function deleteSelectedPicked(){
    const checks = Array.from(document.querySelectorAll(".chkPicked")).filter(c=>c.checked);
    if(checks.length === 0){ showToast("ì‚­ì œí•  í•­ëª©ì„ ì²´í¬í•˜ì„¸ìš”."); return; }
    const idxs = checks.map(c=>Number(c.dataset.idx)).sort((a,b)=>b-a);
    for(const i of idxs){
      pickedRows.splice(i,1);
    }
    renderPicked();
    showToast("ì„ íƒ í•­ëª© ì‚­ì œ ì™„ë£Œ");
  }

  chkAllExisting.addEventListener("change", ()=>{
    const on = chkAllExisting.checked;
    document.querySelectorAll(".chkExisting").forEach(c=>c.checked = on);
  });
  chkAllPicked.addEventListener("change", ()=>{
    const on = chkAllPicked.checked;
    document.querySelectorAll(".chkPicked").forEach(c=>c.checked = on);
  });

  /******************************************************
   * âœ… 9) ì§ì ‘ ì¶”ê°€(ìˆ˜ì‹œ ì „ìš©)
   ******************************************************/
  function addManualRow(){
    pickedRows.push({
      task: "",
      hazard: "",
      measure: "",
      freq: 3,
      sev: 3,
      source: "ìˆ˜ì‹œ(ì§ì ‘ì…ë ¥)"
    });
    renderPicked();
    showToast("1ê±´ ì¶”ê°€ë¨ (ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”)");
  }

  /******************************************************
   * âœ… 10) ì„œëª… ìº”ë²„ìŠ¤(ëª¨ë°”ì¼ ìµœì í™”)
   ******************************************************/
  const sigCanvas = $("sigCanvas");
  const ctx = sigCanvas.getContext("2d");
  let drawing = false;
  let last = null;

  function fitCanvas(){
    const rect = sigCanvas.getBoundingClientRect();
    const ratio = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    sigCanvas.width = Math.floor(rect.width * ratio);
    sigCanvas.height = Math.floor(rect.height * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.lineWidth = 2.2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#0b1b3b";
    // ë°°ê²½ í°ìƒ‰(íˆ¬ëª… ë°©ì§€)
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,sigCanvas.width,sigCanvas.height);
    ctx.restore();
  }

  function getPos(e){
    const rect = sigCanvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : null;
    const x = (touch ? touch.clientX : e.clientX) - rect.left;
    const y = (touch ? touch.clientY : e.clientY) - rect.top;
    return {x,y};
  }

  function startDraw(e){
    e.preventDefault();
    drawing = true;
    last = getPos(e);
  }
  function moveDraw(e){
    if(!drawing) return;
    e.preventDefault();
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    last = p;
  }
  function endDraw(e){
    if(!drawing) return;
    e.preventDefault();
    drawing = false;
    last = null;
  }
  function clearSig(){
    fitCanvas();
  }
  function signatureDataURL(){
    // PNG dataURL
    return sigCanvas.toDataURL("image/png");
  }

  // Pointer + Touch
  sigCanvas.addEventListener("pointerdown", startDraw, {passive:false});
  sigCanvas.addEventListener("pointermove", moveDraw, {passive:false});
  sigCanvas.addEventListener("pointerup", endDraw, {passive:false});
  sigCanvas.addEventListener("pointercancel", endDraw, {passive:false});
  sigCanvas.addEventListener("touchstart", startDraw, {passive:false});
  sigCanvas.addEventListener("touchmove", moveDraw, {passive:false});
  sigCanvas.addEventListener("touchend", endDraw, {passive:false});

  $("btnSigClear").addEventListener("click", clearSig);
  $("btnSigFit").addEventListener("click", ()=>{ fitCanvas(); showToast("ìº”ë²„ìŠ¤ ì¬ì„¤ì • ì™„ë£Œ"); });
  window.addEventListener("resize", ()=>fitCanvas());

  /******************************************************
   * âœ… 11) ì œì¶œ(ì €ì¥)
   ******************************************************/
  function validate(){
    if(!siteSelect.value) return "í˜„ì¥ì„ ì„ íƒí•˜ì„¸ìš”.";
    if(!evalDate.value) return "í‰ê°€ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
    if(!evaluator.value.trim()) return "í‰ê°€ì(ì‘ì„±ì)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
    if(!triggerType.value) return "ìˆ˜ì‹œ ì‚¬ìœ (íŠ¸ë¦¬ê±°)ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
    if(!triggerDetail.value.trim()) return "ì‚¬ìœ  ìƒì„¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
    if(!actionDetail.value.trim()) return "ì¡°ì¹˜ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.";
    if(pickedRows.length === 0) return "ì œì¶œí•  ìœ„í—˜ìš”ì¸ì´ ì—†ìŠµë‹ˆë‹¤. (ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸° ë˜ëŠ” ì§ì ‘ ì¶”ê°€)";
    // í•µì‹¬ í•­ëª© ë¹ˆì¹¸ ì²´í¬
    const bad = pickedRows.find(r => !String(r.task||"").trim() || !String(r.hazard||"").trim() || !String(r.measure||"").trim());
    if(bad) return "ìœ„í—˜ìš”ì¸ ëª©ë¡ì— ë¹ˆì¹¸ì´ ìˆìŠµë‹ˆë‹¤. (ì‘ì—…ë‚´ìš©/ìœ„í—˜ìš”ì¸/ëŒ€ì±…ì„ ì±„ìš°ì„¸ìš”)";
    return "";
  }

  async function submit(){
    const msg = validate();
    if(msg){ showToast(msg); return; }

    showLoading("ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€ ì €ì¥ ì¤‘â€¦", "Firestoreì— ê¸°ë¡ì„ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.");

    try{
      // ì„œëª…: dataURLë¡œ ì €ì¥(í•„ìš” ì‹œ Storage ì—…ë¡œë“œë¡œ ë³€ê²½ ê°€ëŠ¥)
      const sig = signatureDataURL();

      // risks ë°°ì—´ ì •ë¦¬
      const risks = pickedRows.map((r, idx)=>({
        no: idx+1,
        task: r.task,
        hazard: r.hazard,
        measure: r.measure,
        freq: Number(r.freq||3),
        sev: Number(r.sev||3),
        score: riskScore(r.freq, r.sev),
        source: r.source || "ìˆ˜ì‹œ",
        srcId: r._srcId || null
      }));

      const payload = {
        type: "ad-hoc",
        siteId: siteSelect.value,
        evalDate: evalDate.value,
        evaluator: evaluator.value.trim(),

        eventDate: eventDate.value || null,
        triggerType: triggerType.value,
        triggerDetail: triggerDetail.value.trim(),

        actionStatus: actionStatus.value,
        actionDue: actionDue.value || null,
        actionDetail: actionDetail.value.trim(),

        sharedToWorkers: sharedToWorkers.value === "yes",
        confirmedBySupervisor: confirmedBySupervisor.value === "yes",

        signature: {
          evaluatorName: evaluator.value.trim(),
          imageDataUrl: sig
        },

        risks,
        createdAt: serverTimestamp()
      };

      const ref = await addDoc(collection(db, COL_RISK_ASSESSMENTS), payload);

      hideLoading();
      showToast("ì €ì¥ ì™„ë£Œ âœ…");

      // ì €ì¥ í›„ ê°€ë³ê²Œ ì•ˆë‚´
      console.log("Saved docId:", ref.id);

      // ì œì¶œ í›„ ì´ˆê¸°í™”(ì›í•˜ë©´ ì£¼ì„)
      setTimeout(()=>resetForm(true), 700);

    }catch(err){
      console.error(err);
      hideLoading();
      showToast("ì €ì¥ ì‹¤íŒ¨: ê¶Œí•œ(rules) ë˜ëŠ” Firebase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
    }
  }

  /******************************************************
   * âœ… 12) ì´ˆê¸°í™”
   ******************************************************/
  function resetForm(keepSite=false){
    if(!keepSite) siteSelect.value = "";
    evalDate.value = todayISO();
    eventDate.value = nowLocalDatetime();
    evaluator.value = "";
    triggerType.value = "";
    triggerDetail.value = "";
    actionStatus.value = "done";
    actionDue.value = "";
    actionDetail.value = "";
    sharedToWorkers.value = "yes";
    confirmedBySupervisor.value = "yes";

    // ì¡°íšŒ ê¸°ê°„ ê¸°ë³¸ê°’: ìµœê·¼ 30ì¼
    const d = new Date();
    const to = todayISO();
    const fromD = new Date(d.getTime() - 29*24*60*60*1000);
    const f = `${fromD.getFullYear()}-${String(fromD.getMonth()+1).padStart(2,'0')}-${String(fromD.getDate()).padStart(2,'0')}`;
    fromDate.value = f;
    toDate.value = to;

    existingRows = [];
    pickedRows = [];
    chkAllExisting.checked = false;
    chkAllPicked.checked = false;

    renderExisting();
    renderPicked();
    fitCanvas();
    hoursGapText();
  }

  /******************************************************
   * âœ… 13) ì´ë²¤íŠ¸ ë°”ì¸ë”©
   ******************************************************/
  btnLoadExisting.addEventListener("click", loadExistingRisks);
  btnPickSelected.addEventListener("click", pickSelectedFromExisting);
  btnDeletePicked.addEventListener("click", deleteSelectedPicked);
  btnAddManual.addEventListener("click", addManualRow);
  btnSubmit.addEventListener("click", submit);
  btnReset.addEventListener("click", ()=>{ resetForm(false); showToast("ì´ˆê¸°í™” ì™„ë£Œ"); });

  /******************************************************
   * âœ… 14) ì‹œì‘
   ******************************************************/
  resetForm(false);
  await loadSites();

</script>
</body>
</html>
