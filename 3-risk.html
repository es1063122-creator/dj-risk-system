<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ë™ì§„í† ê±´ ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€ v1.0SR FINAL (Secure)</title>
  <link rel="icon" type="image/x-icon"
        href="https://raw.githubusercontent.com/es1063122-creator/dj-risk-system/main/djlogo.ico">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --dj:#004080;
      --dj2:#2a6cf6;
      --bg:#eef2f8; 
      --card:#ffffff;
      --line:#d0d7e6; 
      --ink:#0b1b3b;
      --muted:#475467;
      --good:#12b76a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --r:16px;
      --shadow:0 10px 26px rgba(0,64,128,.10);
      --shadow2:0 12px 30px rgba(0,64,128,.14);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans KR", system-ui,-apple-system,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--ink);
    }

    /* âœ… ë²„ì „1 ëŠë‚Œ: í™”ë©´ ê°€ë¡œ ê½‰ ì°¨ê²Œ + ë°€ë„ ìœ ì§€ */
    .wrap{
      width:100%;
      margin:0;
      padding:14px 16px 24px;
    }

    .card{
      background:var(--card);
      border:1.5px solid #cfd7ea;
      border-radius:18px;
      box-shadow:0 8px 22px rgba(0,40,90,.10);
      padding:14px;
      margin-bottom:12px;
      position:relative;
    }

    /* ===== Header (ë²„ì „1 ìŠ¤íƒ€ì¼) ===== */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
    }
    .brand{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width:280px;
    }
    .mark{
      width:auto;
      height:auto;
      background:none;
      box-shadow:none;
      border-radius:0;
      padding:0;
    }
    .titles .h1{
      font-weight:900;
      font-size:22px;
      line-height:1.2;
      margin:0;
    }
    .titles .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
      line-height:1.25;
    }

    .btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(42,108,246,.22);
      background:#e6edff;
      color:#0b2a5a;;
      font-weight:900;
      font-size:12.5px;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      box-shadow:none;
    }
    .btn:hover{filter:brightness(.99)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:var(--dj);
      border-color:rgba(0,64,128,.2);
      color:#fff;
      box-shadow:var(--shadow2);
    }
    .btn.danger{
      background:#fff;
      color:#b42318;
      border-color:rgba(239,68,68,.22);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    /* ===== Form grid (ë²„ì „1 ë°€ë„) ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      align-items:start;
    }
    .field{display:flex; flex-direction:column; gap:6px;}
    .label{
      font-size:14px;
      font-weight:900;
      color:#2b3a5c;
      letter-spacing:-.2px;
    }
    .hint{
      font-size:11.5px;
      color:var(--muted);
      line-height:1.25;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      background:#fff;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(42,108,246,.45);
      box-shadow:0 0 0 4px rgba(42,108,246,.12);
    }

    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .hr{height:1px; background:var(--line); margin:12px 0}

    /* ===== Section titles ===== */
    .sectionTitle{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .sectionTitle .t{
      font-size:15px;
      font-weight:900;
      color:#0b2a5a;
    }
    .sectionTitle .desc{
      font-size:11.5px;
      color:var(--muted);
      margin-top:2px;
    }

    /* ===== KPI Pills (ë²„ì „1 ëŠë‚Œ) ===== */
    .kpis{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(232,236,246,.95);
      background:#f1f5ff;
      border:1.2px solid #cbd6f2;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.idle{background:var(--dj2)}

    /* ===== Table ===== */
    .tableWrap{
      border:1px solid rgba(232,236,246,.95);
      border-radius:14px;
      overflow:auto;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:1320px; /* ë²„ì „1ì²˜ëŸ¼ ë„‰ë„‰ */
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:#e9f0ff; 
      border-bottom:2px solid #b8c6e6;
      padding:10px 8px;
      font-size:12.5px;
      color:#102a56;
      font-weight:900;
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1.2px solid #d6deef;
      padding:8px;
      vertical-align:top;
      background:#fff;
    }
    tbody tr:hover td{
      background:#f2f6ff;
    }

    tbody tr:hover td{background:#fbfdff}
    .center{text-align:center}
    .w-ck{width:44px}
    .w-no{width:54px}

    /* í…Œì´ë¸” ì•ˆ input/textarea: ë²„ì „1ì²˜ëŸ¼ ë‚®ê³  ê¹”ë” */
    .tIn, .tSel, .tTa{
      width:100%;
      border:1.3px solid #c6d0e6;
      border-radius:12px;
      padding:5px 6px;
      font-size:11.5px;
      line-height:1.25;
      color:#0b1b3b;
      background:#ffffff;
    }
      .tIn:focus, .tTa:focus{
      border-color:#2a6cf6;
      box-shadow:0 0 0 3px rgba(42,108,246,.18);
    }

    .tTa{min-height:66px}
    .miniNote{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    .scoreBox{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .scorePill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      width:max-content;
      border:1px solid rgba(232,236,246,.95);
      background:#fff;
    }
   .scoreLow{
  border-color:#12b76a;
  background:#e9f9f1;
}
.scoreMid{
  border-color:#f59e0b;
  background:#fff4e5;
}
.scoreHigh{
  border-color:#ef4444;
  background:#fdecec;
}


    .rowBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
      justify-content:flex-start;
    }

    /* ===== Education Section ===== */
    .eduGrid{
      display:grid;
      grid-template-columns:repeat(12, 1fr);
      gap:10px;
      margin-top:10px;
    }

    /* ===== Toast ===== */
    .toast{
      position:fixed;
      left:16px;
      bottom:16px;
      background:#0b1b3b;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
      font-size:13px;
      display:none;
      z-index:9999;
      max-width:calc(100vw - 32px);
    }

    /* ===== v3.2 ë¡œê³  í‘œì‹œ ===== */
    .mark.logo{
      background:none;
      display:flex;
      align-items:center;
      justify-content:flex-start;
    }
    .mark.logo img{
      width:36px;
      height:36px;
      object-fit:contain;
    }

    /* ===== v3.1 ì»¬ëŸ¼ ë¹„ìœ¨ ë¯¸ì„¸ì¡°ì • ===== */
   /* ===== ì»¬ëŸ¼ í­ ì••ì¶• (ë²„ì „1 ë°€ë„ ìœ ì§€) ===== */

/* ì‘ì—…ëª… */
th:nth-child(3){ min-width:120px; }

/* ì‘ì—…ìœ„ì¹˜ */
th:nth-child(4){ min-width:110px; }

/* í”¼í•´í˜•íƒœ */
th:nth-child(6){ min-width:60px; }

/* ê°€ëŠ¥ì„± */
th:nth-child(7){ min-width:38px; }

/* ì¤‘ëŒ€ì„± */
th:nth-child(8){ min-width:38px; }

/* ìœ„í—˜ë“±ê¸‰ */
th:nth-child(9){ min-width:90px; }

/* ê°œì„ ëŒ€ì±… (í•µì‹¬ì´ë¯€ë¡œ ìµœì†Œë§Œ ìœ ì§€) */
th:nth-child(10){ min-width:360px; }

/* ì¡°ì¹˜ì */
th:nth-child(11){ min-width:60px; }

/* ì ê²€ì */
th:nth-child(12){ min-width:60px; }


    /* ===== Print / PDF ===== */
    @page { size: A4 landscape; margin: 10mm; }

    /* ê¸°ë³¸ í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€ */
    .print-approval{
      display:none;
    }

   @media print{
    body{background:#fff}
    .wrap{padding:0}
    .card{box-shadow:none; border-radius:12px}

    /* UI ì œê±° */
    .btns,
    .rowBtns,
    .toast{
      display:none !important;
    }

    table{
      width:100% !important;
      min-width:100% !important;
      table-layout:fixed !important;
    }

    .tableWrap{
      border:1px solid #bbb;
      overflow:visible !important;
    }

    thead th{background:#f3f6ff}

    input, select, textarea{
      border:1px solid #bbb;
      box-shadow:none;
    }

    th:nth-child(1),
    td:nth-child(1){ display:none !important; }

    th:last-child,
    td:last-child{ display:none !important; }

    th:nth-child(2), td:nth-child(2){width:36px}
    th:nth-child(3), td:nth-child(3){width:90px}
    th:nth-child(4), td:nth-child(4){width:90px}
    th:nth-child(5), td:nth-child(5){width:170px}
    th:nth-child(6), td:nth-child(6){width:55px;text-align:center}
    th:nth-child(7), td:nth-child(7){width:45px;text-align:center}
    th:nth-child(8), td:nth-child(8){width:45px;text-align:center}
    th:nth-child(9), td:nth-child(9){width:70px;text-align:center}
    th:nth-child(10), td:nth-child(10){width:auto}
    th:nth-child(11), td:nth-child(11){width:65px}
    th:nth-child(12), td:nth-child(12){width:65px}

    td:nth-child(3) input,
    td:nth-child(4) input{
      white-space:normal !important;
      word-break:break-word !important;
      height:auto !important;
      min-height:36px;
    }


    tr, td{
      page-break-inside:auto !important;
      break-inside:auto !important;
    }
.print-approval{
  display:flex;
  position:absolute;
  top:8mm;
  right:10mm;
  gap:10mm;                 /* ê°„ê²© ë„“í˜ */
  font-size:11px;           /* ì¡°ê¸ˆ í‚¤ì›€ */
  align-items:flex-end;
}

.print-approval .sig{
  display:flex;
  align-items:flex-end;
  gap:4mm;                  /* 'ì‘ì„±' ê¸€ìì™€ ì„œëª…ì¹¸ ì‚¬ì´ */
  white-space:nowrap;
  font-weight:800;
  color:#000;
}

/* ìš°ì¸¡ ì„œëª… ì—¬ë°± + ë°‘ì¤„ */
.print-approval .sig span{
  display:inline-block;
  width:26mm;               /* ì„œëª…ì¹¸ ë” ë„“ê²Œ */
  height:7mm;               /* ì„œëª…ì¹¸ ë” ë†’ê²Œ */
  border-bottom:1.6px solid #000;
}


    .card:not(:first-of-type) .print-approval{
      display:none !important;
    }
 /* ===============================
     ğŸ”¥ textareaë¥¼ "ì¶œë ¥ìš© í…ìŠ¤íŠ¸"ë¡œ ê°•ì œ ë³€í™˜
     =============================== */

  /* ê¸°ì¡´ í™”ë©´ìš© ìµœì†Œ ë†’ì´ ì™„ì „ ë¬´ë ¥í™” */
  .tTa{
    min-height: 0 !important;
  }

  /* textarea ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì™„ì „ ì œê±° */
  textarea::-webkit-scrollbar{
    display:none !important;
  }

  /* í–‰ ë‹¨ìœ„ í˜ì´ì§€ ë¶„í•  í—ˆìš© */
  tr{
    page-break-inside: auto !important;
    break-inside: auto !important;
    }
  }
/* ===============================
   ğŸ”¥ PDF ì¶œë ¥ ì „ìš© í…ìŠ¤íŠ¸ ì²˜ë¦¬
=============================== */

/* í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€ */
.printText{
  display:none;
}

/* ì¸ì‡„(PDF)ì—ì„œë§Œ í‘œì‹œ */
@media print{

  /* ğŸ”´ ì…ë ¥ìš© textarea ì™„ì „ ì œê±° */
  textarea{
    display:none !important;
  }

  /* ğŸŸ¢ ì¶œë ¥ìš© í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ */
  .printText{
    display:block !important;
    white-space:pre-wrap;
    word-break:break-word;
    font-size:10.5px;
    line-height:1.35;
    color:#000;
  }

  /* ì…€ ë†’ì´ ìë™ í™•ì¥ */
  td{
    height:auto !important;
    vertical-align:top !important;
  }

  tr{
    page-break-inside:auto !important;
    break-inside:auto !important;
  }
}


/* =========================
   âœ… ì…ë ¥ êµ¬ë¶„ ìƒ‰ìƒ
   - ê´€ë¦¬ì ìˆ˜ê¸° ì…ë ¥: adminInput
   - AI ìë™ ìƒì„±: aiInput
========================= */

/* ê´€ë¦¬ì ìˆ˜ê¸° ì…ë ¥(ì—°í•œ ì›œí†¤) */
.adminInput{
  background:#fff6e9;
  border-color:#f2c48d !important;
  color:var(--ink);
}
.adminInput:focus{
  background:#fff1dc;
  border-color:#f59e0b !important;
  box-shadow:0 0 0 3px rgba(245,158,11,.18);
}

/* =========================
   ğŸ¤– AI ë¶„ì„ ê²°ê³¼ ì „ìš© ìƒ‰ìƒ (í†µì¼)
   - í”¼í•´í˜•íƒœ / ê°€ëŠ¥ì„± / ì¤‘ëŒ€ì„± / ê°œì„ ëŒ€ì±…
========================= */
.aiInput{
  background:#eaf1ff;              /* â— í°ìƒ‰ ì•„ë‹˜, ì—°í•œ ë¸”ë£¨ */
  border:1.5px solid #9db7ff !important;
  color:#0a2458;
  font-weight:600;
}

.aiInput:focus{
  background:#e1ecff;
  border-color:#2a6cf6 !important;
  box-shadow:0 0 0 3px rgba(42,108,246,.22);
}



</style>
</head>

<body>
<div class="wrap">

  <!-- ===== Header (ë²„ì „1 ê¸°ì¤€) ===== -->
  <div class="card">
    <div class="header">
      <div class="brand">
        <div class="mark logo">
          <img src="https://raw.githubusercontent.com/es1063122-creator/dj-risk-system/main/djlogo.ico" alt="ë™ì§„í† ê±´ ë¡œê³ ">
        </div>

        <div class="titles">
          <p class="h1">ìœ„í—˜ì„±í‰ê°€ì„œ ì œ <span id="roundText">1</span>íšŒì°¨</p>
          <div class="sub">ë™ì§„í† ê±´(ì£¼) Â· ìˆ˜ì‹œ ìœ„í—˜ì„±í‰ê°€ ì‹œìŠ¤í…œ</div>
        </div>
      </div>

      <!-- âœ… ë²„ì „1 ë²„íŠ¼ ë°°ì¹˜ ìœ ì§€ + ì €ì¥/ì „íšŒì°¨ëŠ” ê°™ì€ í†¤ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì¶”ê°€ -->
      <div class="btns">
        <button class="btn" id="btnAddRowTop" type="button">í–‰ ì¶”ê°€</button>
        <button class="btn" id="btnDeleteSelectedTop" type="button">ì„ íƒ ì‚­ì œ</button>
        <button class="btn primary" id="btnGenerateTop" type="button">êµìœ¡/ì§€ì‹œì‚¬í•­ ìƒì„±</button>
        <button class="btn" id="btnPrintTop" type="button">PDF/ì¸ì‡„</button>

        <button class="btn" id="btnLoadPrev" type="button">íšŒì°¨ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn primary" id="btnSave" type="button">ì €ì¥</button>
      </div>

      <!-- ===== ì¸ì‡„ìš© ì‚¬ì¸ ê²°ì¬ (ìš°ì¸¡ ìƒë‹¨) ===== -->
      <div class="print-approval">
        <div class="sig">ì‘ì„± <span></span></div>
        <div class="sig">ê²€í†  <span></span></div>
        <div class="sig">ìŠ¹ì¸ <span></span></div>
      </div>
    </div>
  </div>

<!-- ===== íšŒì°¨ / ê³µì¢… ì„ íƒ (ì „íšŒì°¨ ë¶ˆëŸ¬ì˜¤ê¸°) ===== -->
<div class="card" id="prevLoadBox" style="display:none;">
  <div class="sectionTitle">
    <div>
      <div class="t">íšŒì°¨ ë° ê³µì¢… ì„ íƒ</div>
      <div class="desc">ë¶ˆëŸ¬ì˜¬ íšŒì°¨ë¥¼ ì„ íƒí•œ í›„ ê³µì¢…ì„ ì„ íƒí•˜ì„¸ìš”.</div>
    </div>
  </div>

  <div class="grid">
    <!-- íšŒì°¨ ì„ íƒ -->
    <div class="field" style="grid-column: span 3;">
      <div class="label">íšŒì°¨ ì„ íƒ</div>
      <select id="prevRoundSelect"></select>
    </div>

    <div class="field" style="grid-column: span 3; display:flex; align-items:flex-end;">
      <button class="btn primary" id="btnConfirmPrevRound" type="button">
        íšŒì°¨ ì„ íƒ
      </button>
    </div>

    <!-- ê³µì¢… ì„ íƒ (íšŒì°¨ ì„ íƒ í›„ í‘œì‹œ) -->
    <div class="field" id="prevTradeField" style="grid-column: span 4; display:none;">
      <div class="label">ê³µì¢… ëŒ€ë¶„ë¥˜</div>
      <select id="prevTradeSelect"></select>
    </div>

    <div class="field" id="prevTradeBtns" style="grid-column: span 5; display:none; align-items:flex-end;">
      <button class="btn primary" id="btnConfirmPrevTrade" type="button">
        ë¶ˆëŸ¬ì˜¤ê¸°
      </button>
      <button class="btn" id="btnCancelPrevTrade" type="button" style="margin-left:8px;">
        ì·¨ì†Œ
      </button>
    </div>
  </div>
</div>

   <div class="card"> 
    <div class="grid">
      <div class="field" style="grid-column: span 3;">
        <div class="label">ì œëª©(íšŒì°¨)</div>
        <input id="round" type="number" min="1" value="1">
        <div class="hint">ì˜ˆ: â€œìœ„í—˜ì„±í‰ê°€ì„œ ì œ 1íšŒì°¨â€</div>
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">í˜„ì¥</div>
        <!-- âœ… sites ì»¬ë ‰ì…˜ ì—°ë™: ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ì±„ì›€ -->
        <!-- âœ… ì—†ìœ¼ë©´ ì•„ë˜ ê¸°ë³¸ ì˜µì…˜ ìœ ì§€(ë°±ì—…) -->
        <select id="site">
          <option value="paju-pmc">íŒŒì£¼pmc</option>
          <option value="ulsan-taehwagang">ìš¸ì‚°íƒœí™”ê°•</option>
          <option value="ulsan-ujeong">ìš¸ì‚°ìš°ì •ë™</option>
          <option value="gangbyeon-ipark">ê°•ë³€ì•„ì´íŒŒí¬</option>
          <option value="mapo-3-1">ë§ˆí¬ë¡œ3-1</option>
          <option value="gimhae-science">ê¹€í•´ì‚¬ì´ì–¸ìŠ¤</option>
        </select>
        <div class="hint">* Firestore sites ì»¬ë ‰ì…˜ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ìµœì‹  í˜„ì¥ëª©ë¡ìœ¼ë¡œ ë°”ë€ë‹ˆë‹¤.</div>
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">ì‘ì„±ì</div>
        <input id="writer" placeholder="ì˜ˆ: ê¹€ëŒ€í™">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">íšŒì˜ì¼ì</div>
        <input id="meetingDate" type="date">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">í‰ê°€ê¸°ê°„ ì‹œì‘</div>
        <input id="periodStart" type="date">
      </div>

      <div class="field" style="grid-column: span 3;">
        <div class="label">í‰ê°€ê¸°ê°„ ì¢…ë£Œ</div>
        <input id="periodEnd" type="date">
      </div>

      <div class="field" style="grid-column: span 3;">
  <div class="label">ê³µì¢… ëŒ€ë¶„ë¥˜</div>
  <input id="tradeLarge" list="tradeLargeList" placeholder="ì˜ˆ: í† ê³µ / ì² ê·¼ì½˜í¬ë¦¬íŠ¸ / ê°€ì„¤">
  <datalist id="tradeLargeList"></datalist>
</div>

<div class="field" style="grid-column: span 3;">
  <div class="label">ê³µì¢… ì†Œë¶„ë¥˜</div>
  <input id="tradeSmall" list="tradeSmallList" placeholder="ì˜ˆ: êµ´ì°© / ê±°í‘¸ì§‘ / ì•ˆì „ì‹œì„¤">
  <datalist id="tradeSmallList"></datalist>
</div>

      <div class="field" style="grid-column: span 2;">
        <div class="label">ì‘ì—…ì¼ìˆ˜</div>
        <input id="workDays" type="number" min="0" placeholder="ì˜ˆ: 5">
      </div>

      <div class="field" style="grid-column: span 5;">
        <div class="label">ì§ì¢…ë³„ ì¸ì›</div>
        <textarea id="manpower" placeholder="ì˜ˆ:
- êµ´í‹€ëª©ê³µ 4
- ì² ê·¼ê³µ 3
- ì¥ë¹„ê¸°ì‚¬ 1"></textarea>
      </div>

      <div class="field" style="grid-column: span 5;">
        <div class="label">íˆ¬ì…ì¥ë¹„</div>
        <textarea id="equipments" placeholder="ì˜ˆ:
- êµ´ì°©ê¸°(0.7) 1ëŒ€
- ì§€ê²Œì°¨ 1ëŒ€"></textarea>
      </div>
    </div>
  </div>

  <!-- ===== ìœ„í—˜ì„±í‰ê°€ ìƒì„¸ (ë²„ì „1 ê¸°ì¤€ + KPI) ===== -->
  <div class="card">
    <div class="sectionTitle">
      <div>
        <div class="t">ìœ„í—˜ì„±í‰ê°€ ìƒì„¸</div>
        <div class="desc">ìœ„í—˜ìš”ì¸ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ë¥¼ ë²—ì–´ë‚˜ë©´ AIê°€ ìë™ìœ¼ë¡œ í”¼í•´í˜•íƒœÂ·ê°€ëŠ¥ì„±Â·ì¤‘ëŒ€ì„±Â·ê°œì„ ëŒ€ì±…ì„ ìƒì„±í•©ë‹ˆë‹¤.</div>
      </div>
      <div class="kpis">
        <span class="pill"><span class="dot idle"></span>í–‰ ìˆ˜: <b id="kpiRows">3</b></span>
        <span class="pill"><span class="dot bad"></span>ê³ ìœ„í—˜(7~9): <b id="kpiHigh">0</b></span>
        <span class="pill"><span class="dot warn"></span>ì¤‘ìœ„í—˜(4~6): <b id="kpiMid">0</b></span>
        <span class="pill"><span class="dot good"></span>ì €ìœ„í—˜(1~3): <b id="kpiLow">0</b></span>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="center w-ck"><input type="checkbox" id="ckAll"></th>
            <th class="center w-no">No</th>
            <th style="min-width:160px;">ì‘ì—…ëª…</th>
            <th style="min-width:140px;">ì‘ì—…ìœ„ì¹˜</th>
            <th style="min-width:260px;">ìœ„í—˜ìš”ì¸ (AI ë¶„ì„ íŠ¸ë¦¬ê±°)</th>
            <th style="min-width:75px;">í”¼í•´í˜•íƒœ</th>
            <th style="min-width:45px;">ê°€ëŠ¥ì„±</th>
            <th style="min-width:45px;">ì¤‘ëŒ€ì„±</th>
            <th style="min-width:120px;">ìœ„í—˜ë“±ê¸‰</th>
            <th style="min-width:420px;">ê°œì„ ëŒ€ì±…</th>
            <th style="min-width:75px;">ì¡°ì¹˜ì</th>
            <th style="min-width:75px;">ì ê²€ì</th>
            <th class="center" style="min-width:90px;">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- ë²„ì „1 ëŠë‚Œ: í•˜ë‹¨ í–‰ ë²„íŠ¼ -->
    <div class="rowBtns">
      <button class="btn" id="btnAddRow" type="button">+ í–‰ ì¶”ê°€</button>
      <button class="btn danger" id="btnDeleteLast" type="button">ë§ˆì§€ë§‰ í–‰ ì‚­ì œ</button>
    </div>
  </div>

  <!-- ===== êµìœ¡/ì§€ì‹œì‚¬í•­ (ë²„ì „1 ê¸°ì¤€) ===== -->
  <div class="card">
    <div class="sectionTitle">
      <div>
        <div class="t">êµìœ¡ë‚´ìš©(í‚¤ì›Œë“œ) Â· í˜„ì¥ì†Œì¥ ì§€ì‹œì‚¬í•­</div>
        <div class="desc">â€œêµìœ¡/ì§€ì‹œì‚¬í•­ ìƒì„±â€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, í‘œì˜ ë¶„ì„ê²°ê³¼ë¥¼ ì¢…í•©í•´ ìë™ ì‘ì„±í•©ë‹ˆë‹¤.</div>
      </div>
      <div class="kpis">
        <span class="pill"><span class="dot idle" id="sumDot"></span><b id="sumState">ëŒ€ê¸°</b></span>
      </div>
    </div>

    <div style="margin-top:8px;">
      <button class="btn primary" id="btnGenerate" type="button">êµìœ¡/ì§€ì‹œì‚¬í•­ ìƒì„±</button>
    </div>

    <div class="eduGrid">
      <div class="field" style="grid-column: span 4;">
        <div class="label">êµìœ¡ í‚¤ì›Œë“œ 1</div>
        <input id="edu1" class="aiInput" placeholder="ìë™ ìƒì„±">
      </div>
      <div class="field" style="grid-column: span 4;">
        <div class="label">êµìœ¡ í‚¤ì›Œë“œ 2</div>
        <input id="edu2" class="aiInput" placeholder="ìë™ ìƒì„±">
      </div>
      <div class="field" style="grid-column: span 4;">
        <div class="label">êµìœ¡ í‚¤ì›Œë“œ 3</div>
        <input id="edu3" class="aiInput" placeholder="ìë™ ìƒì„±">
      </div>

      <div class="field" style="grid-column: span 12;">
        <div class="label">í˜„ì¥ì†Œì¥ ì§€ì‹œì‚¬í•­ (ë§¨ ë§ˆì§€ë§‰)</div>
        <textarea id="boss" class="aiInput" placeholder="ìë™ ìƒì„± (1~3ë²ˆ ì§€ì‹œì‚¬í•­)"></textarea>
      </div>
    </div>
  </div>
    <!-- ===== ì „íšŒì°¨ í”¼ë“œë°± (ì‹ ê·œ) ===== -->
  <div class="card" id="prevFeedbackCard">
    <div class="sectionTitle">
      <div>
        <div class="t">ì „íšŒì°¨ í”¼ë“œë°±</div>
        <div class="desc">ì „íšŒì°¨ ìœ„í—˜ìš”ì¸Â·ê°œì„ ëŒ€ì±…ì„ ë¶ˆëŸ¬ì™€ ì´í–‰ê²°ê³¼ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div class="tableWrap">
      <table style="min-width:1100px">
        <thead>
          <tr>
            <th class="center" style="width:54px;">No</th>
            <th style="min-width:320px;">ì „íšŒì°¨ ìœ„í—˜ìš”ì¸</th>
            <th style="min-width:420px;">ì „íšŒì°¨ ê°œì„ ëŒ€ì±…</th>
            <th style="min-width:320px;">ì´í–‰ê²°ê³¼ (ì´ë²ˆ íšŒì°¨ ì‘ì„±)</th>
          </tr>
        </thead>
        <tbody id="prevFeedbackBody">
          <tr>
            <td class="center" colspan="4" style="color:var(--muted);padding:14px;">
              ì „íšŒì°¨ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì‹¤í–‰í•˜ë©´ ì—¬ê¸°ì— í•­ëª©ì´ í‘œì‹œë©ë‹ˆë‹¤.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===== ê·¼ë¡œì ì˜ê²¬ì²­ì·¨ (ì‹ ê·œ) ===== -->
  <div class="card">
    <div class="sectionTitle">
      <div>
        <div class="t">ê·¼ë¡œì ì˜ê²¬ì²­ì·¨</div>
        <div class="desc">ì‘ì—… ì¤‘ ëŠë‚€ ìœ„í—˜ìš”ì¸Â·ë¶ˆí¸ì‚¬í•­Â·ê°œì„ ìš”ì²­ì„ ììœ ë¡­ê²Œ ì‘ì„±(ê³µë€ ê°€ëŠ¥)</div>
      </div>
    </div>

    <textarea id="workerOpinion" class="adminInput" placeholder="ê·¼ë¡œì ì˜ê²¬ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš” (ê³µë€ ê°€ëŠ¥)"
  style="min-height:140px;"></textarea>

  </div>


</div>

<div class="toast" id="toast"></div>

<script type="module">
/* =========================================================
   v1.0SR FINAL (Secure)
   - âœ… ê¸°ì¡´ ê¸°ëŠ¥ 100% ìœ ì§€
   - âœ… Gemini API Key ì œê±° (ë…¸ì¶œ 0)
   - âœ… Firebase Functions(analyzeRisk / generateEducation)ë¡œ í”„ë¡ì‹œ í˜¸ì¶œ
   - âœ… Firestore ì €ì¥ + ì „íšŒì°¨ ë¶ˆëŸ¬ì˜¤ê¸° ìœ ì§€
   - âœ… sites ì»¬ë ‰ì…˜ ìˆìœ¼ë©´ í˜„ì¥ ë“œë¡­ë‹¤ìš´ ìë™ ë¡œë”©(ì—†ìœ¼ë©´ ê¸°ì¡´ ì˜µì…˜ ìœ ì§€)
========================================================= */
/* =======================
   0) ì„¤ì • (Apps Script)
======================= */
// âœ… Apps Script ì›¹ì•± URL (ë°˜ë“œì‹œ /exec)
const GAS_URL = "https://script.google.com/macros/s/AKfycbyA3eWajF3YCQCP1o7bu2LlU_rdPTvRoSQkZQTQtdQqUbBn1rvahO5Wk3QpOMvjGxfO/exec";
/* âœ… Firebase (ì‚¬ìš©ì ì œê³µ config ê·¸ëŒ€ë¡œ) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, serverTimestamp,
  collection, getDocs, addDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";


const firebaseConfig = {
  apiKey: "AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  authDomain: "dongjin-risk-system.firebaseapp.com",
  projectId: "dongjin-risk-system",
  storageBucket: "dongjin-risk-system.firebasestorage.app",
  messagingSenderId: "419989869270",
  appId: "1:419989869270:web:b1d2dae3d82a7110732f77",
  measurementId: "G-WP7514NHWL"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =======================
   1) DOM
======================= */
const $ = (id)=>document.getElementById(id);

const roundEl = $("round");
const roundTextEl = $("roundText");
const siteEl = $("site");
const writerEl = $("writer");
const meetingDateEl = $("meetingDate");
const periodStartEl = $("periodStart");
const periodEndEl = $("periodEnd");
const tradeLargeEl = $("tradeLarge");
const tradeSmallEl = $("tradeSmall");
const workDaysEl = $("workDays");
const manpowerEl = $("manpower");
const equipmentsEl = $("equipments");

const tbody = $("tbody");
const ckAll = $("ckAll");

const btnAddRow = $("btnAddRow");
const btnAddRowTop = $("btnAddRowTop");
const btnDeleteSelectedTop = $("btnDeleteSelectedTop");
const btnDeleteLast = $("btnDeleteLast");
const btnGenerate = $("btnGenerate");
const btnGenerateTop = $("btnGenerateTop");
const btnPrintTop = $("btnPrintTop");
const btnSave = $("btnSave");
const btnLoadPrev = $("btnLoadPrev");

const kpiRows = $("kpiRows");
const kpiHigh = $("kpiHigh");
const kpiMid  = $("kpiMid");
const kpiLow  = $("kpiLow");

const edu1 = $("edu1");
const edu2 = $("edu2");
const edu3 = $("edu3");
const boss = $("boss");
const prevFeedbackBody = $("prevFeedbackBody");
const workerOpinionEl = $("workerOpinion");


const sumDot = $("sumDot");
const sumState = $("sumState");

const toastEl = $("toast");
// ì „íšŒì°¨ ê³µì¢… ì„ íƒ UI
const prevTradeBox = $("prevTradeBox");
const prevTradeSelect = $("prevTradeSelect");
const btnConfirmPrevTrade = $("btnConfirmPrevTrade");
const btnCancelPrevTrade = $("btnCancelPrevTrade");
const prevLoadBox = $("prevLoadBox");
const prevRoundSelect = $("prevRoundSelect");
const btnConfirmPrevRound = $("btnConfirmPrevRound");

const prevTradeField = $("prevTradeField");
const prevTradeBtns  = $("prevTradeBtns");


/* =======================
   2) Toast
======================= */
let toastTimer=null;
function toast(msg){
  if(!msg) return;
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastEl.style.display="none", 1600);
}

/* =======================
   3) ë‚ ì§œ ê¸°ë³¸ê°’(ì˜¤ëŠ˜)
======================= */
(function initDates(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  const d = String(now.getDate()).padStart(2,"0");
  const iso = `${y}-${m}-${d}`;
  meetingDateEl.value ||= iso;
  periodStartEl.value ||= iso;
  periodEndEl.value ||= iso;
})();

/* =======================
   4) íšŒì°¨ ì œëª© ë™ê¸°í™”
======================= */
function syncRoundTitle(){
  const v = Math.max(1, Number(roundEl.value || 1));
  roundEl.value = v;
  roundTextEl.textContent = String(v);
}
function makeTitleByRound(round){
  const r = Math.max(1, Number(round || 1));
  return `ìœ„í—˜ì„±í‰ê°€ì„œ ì œ ${r}íšŒì°¨`;
}
roundEl.addEventListener("input", syncRoundTitle);
roundEl.addEventListener("change", syncRoundTitle);
syncRoundTitle();

/* =======================
   4-1) âœ… í˜„ì¥ ë“œë¡­ë‹¤ìš´: sites ì»¬ë ‰ì…˜ ìë™ ë¡œë”© (ìˆìœ¼ë©´)
   - siteId: ì˜ë¬¸, siteName: í•œê¸€
   - value = siteId, text = siteName (ì›í•˜ë©´ í‘œê¸° ë³€ê²½ ê°€ëŠ¥)
======================= */
async function loadSitesFromFirestore(){
  try{
    const snap = await getDocs(collection(db, "sites"));
    const list = [];
    snap.forEach(d=>{
      const s = d.data();
      if(s && s.active){
        list.push({
          siteId: s.siteId || d.id,
          siteName: s.siteName || d.id
        });
      }
    });
    if(!list.length) return;

    // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€ ëŒ€ì‹ , Firestoreê°€ ìˆìœ¼ë©´ ìµœì‹ ìœ¼ë¡œ êµì²´
    // (ì›í•˜ë©´ ê¸°ì¡´ + ì¶”ê°€ë¡œ í•©ì¹  ìˆ˜ë„ ìˆì§€ë§Œ, í˜„ì¥ ë§ˆìŠ¤í„°ë¥¼ ìš°ì„ )
    siteEl.innerHTML = "";
    list.sort((a,b)=>String(a.siteName).localeCompare(String(b.siteName), "ko"));
    list.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = s.siteId;
      opt.textContent = s.siteName; // ì›¹ì—ëŠ” í•œê¸€
      siteEl.appendChild(opt);
    });

    toast("í˜„ì¥ëª©ë¡(ì½˜ì†” sites) ë¶ˆëŸ¬ì˜´");
  }catch(e){
    // sitesê°€ ì—†ê±°ë‚˜ ê¶Œí•œ/ê·œì¹™ ë¬¸ì œë©´ ì¡°ìš©íˆ ë¬´ì‹œ(ê¸°ë³¸ ì˜µì…˜ ì‚¬ìš©)
    console.warn("sites load skipped:", e?.message || e);
  }
}
loadSitesFromFirestore();
loadTradesFromFirestore();
siteEl.addEventListener("change", loadTradesFromFirestore);

// =======================
// 4-2) âœ… ê³µì¢… ë“œë¡­ë‹¤ìš´(datalist) ë¡œë”©
// - tradeMasters/{site}/items ì—ì„œ ëª©ë¡ êµ¬ì„±
// - ëŒ€ë¶„ë¥˜/ì†Œë¶„ë¥˜ë¥¼ ê°ê° ì¶”ì²œ ëª©ë¡ìœ¼ë¡œ ì œê³µ
// =======================
async function loadTradesFromFirestore(){
  const site = siteEl.value;
  if(!site) return;

  try{
    const ref = collection(db, "tradeMasters", site, "items");
    const snap = await getDocs(ref);

    const largeSet = new Set();
    const smallSet = new Set();

    snap.forEach(d=>{
      const v = d.data();
      if(v && v.active !== false){
        if(v.tradeLarge) largeSet.add(String(v.tradeLarge).trim());
        if(v.tradeSmall) smallSet.add(String(v.tradeSmall).trim());
      }
    });

    // datalist ì±„ìš°ê¸°
    const largeList = $("tradeLargeList");
    const smallList = $("tradeSmallList");

    largeList.innerHTML = [...largeSet]
      .sort((a,b)=>a.localeCompare(b,"ko"))
      .map(v=>`<option value="${v}"></option>`)
      .join("");

    smallList.innerHTML = [...smallSet]
      .sort((a,b)=>a.localeCompare(b,"ko"))
      .map(v=>`<option value="${v}"></option>`)
      .join("");

    // ì˜µì…˜: ì•ˆë‚´ í† ìŠ¤íŠ¸
    // toast("ê³µì¢… ëª©ë¡ ë¶ˆëŸ¬ì˜´");
  }catch(e){
    console.warn("tradeMasters load skipped:", e?.message || e);
  }
}


/* =======================
   5) ìœ„í—˜ë“±ê¸‰ ê³„ì‚° + KPI
======================= */
function calcScore(prob, sev){
  const p = Number(prob||0);
  const s = Number(sev||0);
  if(p>=1 && p<=3 && s>=1 && s<=3) return p*s;
  return 0;
}
function scoreLabel(score){
  if(!score) return "";
  if(score>=7) return `ê³ (${score})`;
  if(score>=4) return `ì¤‘(${score})`;
  return `ì €(${score})`;
}
function scoreClass(score){
  if(score>=7) return "scorePill scoreHigh";
  if(score>=4) return "scorePill scoreMid";
  if(score>=1) return "scorePill scoreLow";
  return "scorePill";
}
function updateKPIs(){
  const rows = [...tbody.querySelectorAll("tr")];
  let low=0, mid=0, high=0;
  rows.forEach(tr=>{
    const score = Number(tr.querySelector("[data-role=score]").dataset.score || 0);
    if(score>=7) high++;
    else if(score>=4) mid++;
    else if(score>=1) low++;
  });
  kpiRows.textContent = rows.length;
  kpiHigh.textContent = high;
  kpiMid.textContent  = mid;
  kpiLow.textContent  = low;
}

/* =======================
   6) AI í˜¸ì¶œ/íŒŒì‹±
   - âœ… Functionsë¡œ í”„ë¡ì‹œ í˜¸ì¶œ (API Key ë…¸ì¶œ ì—†ìŒ)
======================= */
function extractSection(fullText, startMarker, endMarker=""){
  const s = fullText.indexOf(startMarker);
  if(s < 0) return "";
  let start = s + startMarker.length;
  let chunk = fullText.slice(start);
  if(endMarker){
    const e = chunk.indexOf(endMarker);
    if(e >= 0) chunk = chunk.slice(0, e);
  }
  chunk = chunk.trim();

  if(startMarker.includes("[ê°€ëŠ¥ì„±]") || startMarker.includes("[ì¤‘ëŒ€ì„±]")){
    const m = chunk.match(/[1-3]/);
    return m ? m[0] : "";
  }
  return chunk;
}

/* =======================
   âœ… Apps Script í˜¸ì¶œ (JSON ê³ ì •)
======================= */
async function callGAS(action, payload){
  const form = new FormData();
  form.append("action", action);

  Object.entries(payload || {}).forEach(([k, v]) => {
    form.append(k, v);
  });

  const res = await fetch(GAS_URL, {
    method: "POST",
    body: form   // âš  Content-Type ì§€ì • ì•ˆ í•¨
  });

  const json = await res.json().catch(() => null);
  if (!json || json.error) {
    throw new Error(json?.error || "Apps Script ì˜¤ë¥˜");
  }
  return json;
}

/* âœ… ê¸°ì¡´ callGemini ìœ ì§€ (payload í‚¤ë§Œ Functions ê¸°ì¤€ì— ë§ì¶¤) */
async function callGemini(promptText, preferEndpoint = FN_ANALYZE){
  try{
    // ğŸ”¥ í•µì‹¬ ìˆ˜ì •: prompt â†’ riskFactor
    const out = await callFunction(preferEndpoint, {
      riskFactor: promptText
    });
    return (out?.text || "").trim();
  }catch(e){
    // fallback ë¡œì§ ê·¸ëŒ€ë¡œ ìœ ì§€
    if(preferEndpoint === FN_EDU){
      const out2 = await callFunction(FN_ANALYZE, {
        riskFactor: promptText
      });
      return (out2?.text || "").trim();
    }
    throw e;
  }
}


function buildRiskPrompt(riskFactor){
  return `
ë‹¤ìŒ ìœ„í—˜ìš”ì¸ì— ëŒ€í•´ ë¶„ì„í•´ì£¼ì„¸ìš”. ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”:

[í”¼í•´í˜•íƒœ]
í”¼í•´ ìœ í˜•ì„ í•œ ë‹¨ì–´ë¡œ ì‘ì„± (ì˜ˆ: ì¶”ë½, ê°ì „, í™”ì¬)

[ê°€ëŠ¥ì„±]
1, 2, 3 ì¤‘ í•˜ë‚˜ì˜ ìˆ«ìë§Œ ì…ë ¥

[ì¤‘ëŒ€ì„±]
1, 2, 3 ì¤‘ í•˜ë‚˜ì˜ ìˆ«ìë§Œ ì…ë ¥

[ê°œì„ ëŒ€ì±…]
ê° ê°œì„ ëŒ€ì±…ì„ 7~8ë‹¨ì–´ ì •ë„ë¡œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
1. ì²« ë²ˆì§¸ ê°œì„ ëŒ€ì±… (êµ¬ì²´ì ì¸ ì¡°ì¹˜ì‚¬í•­ í¬í•¨)
2. ë‘ ë²ˆì§¸ ê°œì„ ëŒ€ì±… (êµ¬ì²´ì ì¸ ì¡°ì¹˜ì‚¬í•­ í¬í•¨)
3. ì„¸ ë²ˆì§¸ ê°œì„ ëŒ€ì±… (êµ¬ì²´ì ì¸ ì¡°ì¹˜ì‚¬í•­ í¬í•¨)

ìœ„í—˜ìš”ì¸: ${String(riskFactor).replace(/"/g,"'")}
`.trim();
}

function buildSummaryPrompt(risksText, solutionsText){
  return `
ë‹¤ìŒ ìœ„í—˜ìš”ì¸ê³¼ ê°œì„ ëŒ€ì±…ì„ ë°”íƒ•ìœ¼ë¡œ êµìœ¡ë‚´ìš©ê³¼ í˜„ì¥ì†Œì¥ì§€ì‹œì‚¬í•­ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”:

[êµìœ¡ë‚´ìš©1]
4~6ë‹¨ì–´ ì´ë‚´ë¡œ í•µì‹¬ í‚¤ì›Œë“œë§Œ ì‘ì„±. ê´„í˜¸ ì‚¬ìš© ê¸ˆì§€

[êµìœ¡ë‚´ìš©2]
3~5ë‹¨ì–´ ì´ë‚´ë¡œ í•µì‹¬ í‚¤ì›Œë“œë§Œ ì‘ì„±. ê´„í˜¸ ì‚¬ìš© ê¸ˆì§€

[êµìœ¡ë‚´ìš©3]
3~5ë‹¨ì–´ ì´ë‚´ë¡œ í•µì‹¬ í‚¤ì›Œë“œë§Œ ì‘ì„±. ê´„í˜¸ ì‚¬ìš© ê¸ˆì§€

[í˜„ì¥ì†Œì¥ì§€ì‹œì‚¬í•­]
1. ì²« ë²ˆì§¸ ì§€ì‹œì‚¬í•­ (10ë‹¨ì–´ ì´ë‚´ë¡œ ì§§ê³  ëª…í™•í•˜ê²Œ)
2. ë‘ ë²ˆì§¸ ì§€ì‹œì‚¬í•­ (10ë‹¨ì–´ ì´ë‚´ë¡œ ì§§ê³  ëª…í™•í•˜ê²Œ)
3. ì„¸ ë²ˆì§¸ ì§€ì‹œì‚¬í•­ (10ë‹¨ì–´ ì´ë‚´ë¡œ ì§§ê³  ëª…í™•í•˜ê²Œ)

ìœ„í—˜ìš”ì¸:
${risksText}

ê°œì„ ëŒ€ì±…:
${solutionsText}
`.trim();
}

/* =======================
   7) í…Œì´ë¸” Row ìƒì„±/ë Œë”
======================= */
const rowBusy = new WeakMap(); // {busy:boolean, lastRisk:string}

function renumber(){
  [...tbody.querySelectorAll("tr")].forEach((tr, idx)=>{
    tr.querySelector("[data-role=no]").textContent = String(idx+1);
  });
  updateKPIs();
}

function setSummaryState(state, kind="idle"){
  sumState.textContent = state;
  sumDot.classList.remove("good","warn","bad","idle");
  if(kind==="ok") sumDot.classList.add("good");
  else if(kind==="err") sumDot.classList.add("bad");
  else if(kind==="busy") sumDot.classList.add("warn");
  else sumDot.classList.add("idle");
}

function renderScore(tr){
  const prob = tr.querySelector("[data-role=prob]").value;
  const sev  = tr.querySelector("[data-role=sev]").value;
  const score = calcScore(prob, sev);

  const gradeCell = tr.querySelector("[data-role=score]");
  gradeCell.dataset.score = String(score || 0);
  gradeCell.innerHTML = "";

  if(score){
    const pill = document.createElement("span");
    pill.className = scoreClass(score);
    pill.innerHTML = `<span class="dot ${score>=7?'bad':score>=4?'warn':'good'}"></span>${scoreLabel(score)}`;
    gradeCell.appendChild(pill);
  }else{
    const span = document.createElement("span");
    span.style.color = "var(--muted)";
    span.style.fontSize = "12px";
    span.textContent = "ìë™";
    gradeCell.appendChild(span);
  }

  updateKPIs();
}

function makeRow(prefill=null){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="center w-ck"><input type="checkbox" data-role="sel"></td>
    <td class="center w-no" data-role="no"></td>

    <td><input class="tIn adminInput" data-role="workName" placeholder="ì˜ˆ: ê±°í‘¸ì§‘ ì„¤ì¹˜"></td>
    <td><input class="tIn adminInput" data-role="workLoc" placeholder="ì˜ˆ: 3ì¸µ ìŠ¬ë¼ë¸Œ"></td>

    <td>
      <textarea class="tTa adminInput" data-role="risk" placeholder="ìœ„í—˜ìš”ì¸ ì…ë ¥ í›„ í¬ì»¤ìŠ¤ ì•„ì›ƒ"></textarea>
      <div class="printText" data-print="risk"></div>
      <div class="miniNote">AI ìë™ë¶„ì„</div>
    </td>

    <td><input class="tIn aiInput" data-role="damage" placeholder="ìë™"></td>
    <td><input class="tIn aiInput" data-role="prob" placeholder="1~3" inputmode="numeric"></td>
    <td><input class="tIn aiInput" data-role="sev" placeholder="1~3" inputmode="numeric"></td>

    <td data-role="score" class="center" style="min-width:120px">
      <span style="color:var(--muted);font-size:12px">ìë™</span>
    </td>

    <td>
      <textarea class="tTa aiInput" data-role="solution" placeholder="ìë™ ìƒì„±"></textarea>
      <div class="printText" data-print="solution"></div>
    </td>

    <td><input class="tIn adminInput" data-role="actor" placeholder=""></td>
    <td><input class="tIn adminInput" data-role="checker" placeholder=""></td>

    <td class="center">
      <button class="btn danger" data-role="del" type="button"
        style="padding:6px 8px;border-radius:8px;font-size:11px">ì‚­ì œ</button>
    </td>
  `;

  rowBusy.set(tr, { busy:false, lastRisk:"" });

  // prefill
  if(prefill){
    tr.querySelector("[data-role=workName]").value = prefill.workName || "";
    tr.querySelector("[data-role=workLoc]").value  = prefill.workLoc  || "";
    tr.querySelector("[data-role=risk]").value     = prefill.risk     || "";
    tr.querySelector("[data-role=damage]").value   = prefill.damage   || "";
    tr.querySelector("[data-role=prob]").value     = prefill.prob ? String(prefill.prob) : "";
    tr.querySelector("[data-role=sev]").value      = prefill.sev ? String(prefill.sev) : "";
    tr.querySelector("[data-role=solution]").value = prefill.solution || "";
    tr.querySelector("[data-role=actor]").value    = prefill.actor    || "";
    tr.querySelector("[data-role=checker]").value  = prefill.checker  || "";
  }

  // ì‚­ì œ
  tr.querySelector("[data-role=del]").addEventListener("click", ()=>{
    tr.remove();
    renumber();
    if(tbody.children.length === 0){
      addRow(); addRow(); addRow();
      renumber();
    }
  });

  // ìœ„í—˜ìš”ì¸ blur â†’ AI ë¶„ì„ (ë²„ì „1 í•µì‹¬)
  tr.querySelector("[data-role=risk]").addEventListener("blur", ()=> analyzeRow(tr));

  // ê°€ëŠ¥ì„±/ì¤‘ëŒ€ì„± ì…ë ¥ â†’ ìœ„í—˜ë“±ê¸‰ ìë™
  ["prob","sev"].forEach(k=>{
    tr.querySelector(`[data-role=${k}]`).addEventListener("input", ()=> renderScore(tr));
    tr.querySelector(`[data-role=${k}]`).addEventListener("blur", ()=> renderScore(tr));
  });

  // prefillì¼ ë•Œ ë“±ê¸‰ í‘œì‹œ
  renderScore(tr);

  return tr;
}

function addRow(prefill=null){
  tbody.appendChild(makeRow(prefill));
  renumber();
}

function deleteLastRow(){
  const last = tbody.lastElementChild;
  if(last){
    last.remove();
    renumber();
  }
  if(tbody.children.length === 0){
    addRow(); addRow(); addRow();
    renumber();
  }
}

/* =======================
   8) AI ë¶„ì„(í–‰ ë‹¨ìœ„)
======================= */
async function analyzeRow(tr){
  const state = rowBusy.get(tr);
  if(!state || state.busy) return;

  const riskEl = tr.querySelector("[data-role=risk]");
  const risk = riskEl.value.trim();
  if(!risk) return;

  if(state.lastRisk === risk) return;

  const damageEl = tr.querySelector("[data-role=damage]");
  const probEl   = tr.querySelector("[data-role=prob]");
  const sevEl    = tr.querySelector("[data-role=sev]");
  const solEl    = tr.querySelector("[data-role=solution]");

  state.busy = true;
  state.lastRisk = risk;

  damageEl.value = "ë¶„ì„ ì¤‘...";
  probEl.value   = "ë¶„ì„ ì¤‘...";
  sevEl.value    = "ë¶„ì„ ì¤‘...";
  solEl.value    = "ë¶„ì„ ì¤‘...";
  renderScore(tr);

  try {
  const out = await callGAS("analyzeRiskJson", {
    riskFactor: risk
  });

  damageEl.value = out.damage || "";
  probEl.value   = String(out.prob || "");
  sevEl.value    = String(out.sev || "");

  solEl.value = out.solutionText || "";


  renderScore(tr);

} catch (e) {
  damageEl.value = "ë¶„ì„ ì‹¤íŒ¨";
  probEl.value = "";
  sevEl.value  = "";
  solEl.value  = "";
  renderScore(tr);
  console.error(e);
  toast("AI ë¶„ì„ ì‹¤íŒ¨");
} finally {
  state.busy = false;
 }
}

/* =======================
   9) êµìœ¡/ì§€ì‹œì‚¬í•­ ìƒì„±(ì¢…í•©)
======================= */
async function generateSummary(){
  const rows = [...tbody.querySelectorAll("tr")];
  let allRisks = "";
  let allSolutions = "";

  rows.forEach(tr=>{
    const risk = tr.querySelector("[data-role=risk]").value.trim();
    const sol  = tr.querySelector("[data-role=solution]").value.trim();
    if(risk && risk !== "ë¶„ì„ ì¤‘..." && risk !== "ë¶„ì„ ì‹¤íŒ¨"){
      allRisks += `- ${risk}\n`;
      if(sol && sol !== "ë¶„ì„ ì¤‘..." && sol !== "ë¶„ì„ ì‹¤íŒ¨"){
        allSolutions += `${sol}\n`;
      }
    }
  });

  if(!allRisks.trim()){
    alert("ìœ„í—˜ìš”ì¸ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  btnGenerate.disabled = true;
  btnGenerateTop.disabled = true;

  edu1.value = edu2.value = edu3.value = "ë¶„ì„ ì¤‘...";
  boss.value = "ë¶„ì„ ì¤‘...";
  setSummaryState("ë¶„ì„ ì¤‘", "busy");

  try{
    // âœ… generateEducation í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ analyzeRiskë¡œ ìë™ fallback
    const out = await callGAS("generateEducation", {
  content: allSolutions
});

edu1.value = out.edu1 || "";
edu2.value = out.edu2 || "";
edu3.value = out.edu3 || "";
boss.value = out.boss || "";

setSummaryState("ì™„ë£Œ", "ok");
toast("êµìœ¡/ì§€ì‹œì‚¬í•­ ìƒì„± ì™„ë£Œ");

  }catch(e){
    edu1.value = "ë¶„ì„ ì‹¤íŒ¨";
    edu2.value = "";
    edu3.value = "";
    boss.value = String(e?.message || e);
    setSummaryState("ì˜¤ë¥˜", "err");
    console.error(e);
    toast("êµìœ¡/ì§€ì‹œì‚¬í•­ ìƒì„± ì‹¤íŒ¨");
  }finally{
    btnGenerate.disabled = false;
    btnGenerateTop.disabled = false;
  }
}

/* =======================
   10) Firestore ì €ì¥/ì „íšŒì°¨
   ë¬¸ì„œ ID: {site}__{round}
======================= */
function makeDocId(site, round, tradeLarge, tradeSmall){
  const safe = (v)=>String(v||"").replace(/[\/\\#?[\]]/g, "_").trim();
  return `${safe(site)}__${round}__${safe(tradeLarge)}__${safe(tradeSmall)}`;
}

function collectData(){
  const meta = {
    writer: writerEl.value || "",
    meetingDate: meetingDateEl.value || "",
    periodStart: periodStartEl.value || "",
    periodEnd: periodEndEl.value || "",
    tradeLarge: tradeLargeEl.value || "",
    tradeSmall: tradeSmallEl.value || "",
    workDays: Number(workDaysEl.value || 0),
    manpower: manpowerEl.value || "",
    equipments: equipmentsEl.value || "",
    workerOpinion: workerOpinionEl?.value || "",
  };

  const risks = [...tbody.querySelectorAll("tr")].map(tr=>({
    workName: tr.querySelector("[data-role=workName]").value || "",
    workLoc:  tr.querySelector("[data-role=workLoc]").value || "",
    risk:     tr.querySelector("[data-role=risk]").value || "",
    damage:   tr.querySelector("[data-role=damage]").value || "",
    prob:     Number(tr.querySelector("[data-role=prob]").value || 0),
    sev:      Number(tr.querySelector("[data-role=sev]").value || 0),
    solution: tr.querySelector("[data-role=solution]").value || "",
    actor:    tr.querySelector("[data-role=actor]").value || "",
    checker:  tr.querySelector("[data-role=checker]").value || ""
  }));

  const summary = {
    edu1: edu1.value || "",
    edu2: edu2.value || "",
    edu3: edu3.value || "",
    boss: boss.value || ""
  };
  const prevFeedback = [];
document
  .querySelectorAll("#prevFeedbackBody textarea[data-role=prevResult]")
  .forEach((ta) => {
    prevFeedback.push({
      prevIndex: Number(ta.dataset.prevIndex || 0),
      result: ta.value || ""
    });
  });

  return {
    site: siteEl.value,
    round: Math.max(1, Number(roundEl.value || 1)),
    meta,
    risks,
    summary,
    prevFeedback
  };
}
// =======================
// âœ… ê³µì¢… ë§ˆìŠ¤í„° ëˆ„ì  ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
// =======================
async function upsertTradeMaster(site, tradeLarge, tradeSmall){
  const large = String(tradeLarge||"").trim();
  const small = String(tradeSmall||"").trim();

  if(!site || !large || !small) return;

  try{
    const ref = collection(db, "tradeMasters", site, "items");
    const q = query(
      ref,
      where("tradeLarge","==",large),
      where("tradeSmall","==",small)
    );
    const snap = await getDocs(q);

    if(snap.empty){
      await addDoc(ref, {
        tradeLarge: large,
        tradeSmall: small,
        active: true,
        createdAt: serverTimestamp()
      });
    }
  }catch(e){
    console.warn("upsertTradeMaster skipped:", e?.message || e);
  }
}

async function saveToFirestore(){
  const data = collectData();
// âœ… ê³µì¢… ë§ˆìŠ¤í„° ìë™ ëˆ„ì  ì €ì¥
await upsertTradeMaster(
  data.site,
  tradeLargeEl.value,
  tradeSmallEl.value
);
await loadTradesFromFirestore();


  // âœ… ì €ì¥ ì‹œ ì œëª© ê°•ì œ ê³ ì •
  const fixedTitle = makeTitleByRound(data.round);
  roundTextEl.textContent = data.round;

  const id = makeDocId(
  data.site,
  data.round,
  tradeLargeEl.value,
  tradeSmallEl.value
);

  const ref = doc(db, "riskAssessments", "adHoc", "items", id);

  btnSave.disabled = true;
  try{
    const existing = await getDoc(ref);
    const payload = {
      ...data,
      title: fixedTitle,
      updatedAt: serverTimestamp(),
  siteId: data.site,
  type: "adHoc",               // ìˆ˜ì‹œ ê³ ì •
  round: data.round,

  title: fixedTitle,
  updatedAt: serverTimestamp(),
};


    if(!existing.exists()){
      payload.createdAt = serverTimestamp();
    }
    await setDoc(ref, payload, { merge:true });
    toast(`ì €ì¥ ì™„ë£Œ: ${data.site} / ${data.round}íšŒì°¨`);
  }catch(e){
    console.error(e);
    alert("ì €ì¥ ì‹¤íŒ¨: " + String(e?.message || e));
  }finally{
    btnSave.disabled = false;
  }
}

function fillMeta(meta){
  writerEl.value = meta?.writer || "";
  meetingDateEl.value = meta?.meetingDate || "";
  periodStartEl.value = meta?.periodStart || "";
  periodEndEl.value = meta?.periodEnd || "";
  tradeLargeEl.value = meta?.tradeLarge || "";
  tradeSmallEl.value = meta?.tradeSmall || "";
  workDaysEl.value = (meta?.workDays ?? "");
  manpowerEl.value = meta?.manpower || "";
  equipmentsEl.value = meta?.equipments || "";
  if(workerOpinionEl) workerOpinionEl.value = meta?.workerOpinion || "";
}

function fillRisks(risks){
  tbody.innerHTML = "";
  const arr = Array.isArray(risks) ? risks : [];
  if(arr.length){
    arr.forEach(r => addRow(r));
  }else{
    addRow(); addRow(); addRow();
  }
  renumber();
  ckAll.checked = false;
}

function fillSummary(summary){
  edu1.value = summary?.edu1 || "";
  edu2.value = summary?.edu2 || "";
  edu3.value = summary?.edu3 || "";
  boss.value = summary?.boss || "";
}


let prevRoundData = {}; // { round: [docs...] }

async function loadPreviousRound(){
  const site = siteEl.value;
  btnLoadPrev.disabled = true;

  try{
    const q = query(
      collection(db, "riskAssessments"),
      where("site","==",site)
    );
    const snap = await getDocs(q);

    if(snap.empty){
      toast("ì €ì¥ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    prevRoundData = {};
    snap.forEach(d=>{
      const data = d.data();
      const r = data.round;
      if(!prevRoundData[r]) prevRoundData[r] = [];
      prevRoundData[r].push(data);
    });

    const rounds = Object.keys(prevRoundData)
      .map(n=>Number(n))
      .sort((a,b)=>b-a);

    prevRoundSelect.innerHTML = rounds
      .map(r=>`<option value="${r}">${r}íšŒì°¨</option>`)
      .join("");

    prevLoadBox.style.display = "block";
    prevTradeField.style.display = "none";
    prevTradeBtns.style.display  = "none";

    toast("íšŒì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”");

  }catch(e){
    console.error(e);
    alert("íšŒì°¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
  }finally{
    btnLoadPrev.disabled = false;
  }
}

// ğŸ”¹ íšŒì°¨ ì„ íƒ â†’ ê³µì¢… ëŒ€ë¶„ë¥˜ ëª©ë¡ ìƒì„±
btnConfirmPrevRound.addEventListener("click", () => {
  const round = Number(prevRoundSelect.value);
  const list = prevRoundData[round] || [];

  if (!list.length) {
    toast("í•´ë‹¹ íšŒì°¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ğŸ”¹ í•´ë‹¹ íšŒì°¨ì— ì¡´ì¬í•˜ëŠ” ê³µì¢… ëŒ€ë¶„ë¥˜ë§Œ ì¶”ì¶œ
  const tradeSet = new Set();
  list.forEach(d => {
    if (d?.meta?.tradeLarge) {
      tradeSet.add(d.meta.tradeLarge);
    }
  });

  if (!tradeSet.size) {
    toast("í•´ë‹¹ íšŒì°¨ì— ê³µì¢… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ğŸ”¹ ê³µì¢… ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
  prevTradeSelect.innerHTML = [...tradeSet]
    .sort((a, b) => a.localeCompare(b, "ko"))
    .map(t => `<option value="${t}">${t}</option>`)
    .join("");

  // ğŸ”¹ ê³µì¢… ì„ íƒ UI í‘œì‹œ
  prevTradeField.style.display = "block";
  prevTradeBtns.style.display  = "flex";

  toast("ê³µì¢…ì„ ì„ íƒí•˜ì„¸ìš”");
});

function confirmLoadPrevByTrade(){
  const round = Number(prevRoundSelect.value);
  const tradeLarge = prevTradeSelect.value;

  const list = prevRoundData[round] || [];
  const data = list.find(d => d?.meta?.tradeLarge === tradeLarge);

  if(!data){
    toast("ì„ íƒí•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const ok = confirm(
    `âš  ì„ íƒí•œ íšŒì°¨ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\n` +
    `íšŒì°¨: ${round}íšŒì°¨\n` +
    `ê³µì¢…: ${tradeLarge}\n\n` +
    `í˜„ì¬ ì…ë ¥ ë‚´ìš©ì€ ë®ì–´ì”ë‹ˆë‹¤.\në¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`
  );
  if(!ok) return;

  fillMeta(data.meta);
  fillRisks(data.risks);
  fillSummary(data.summary);

  // ğŸ”¹ ì „íšŒì°¨ í”¼ë“œë°±
  prevFeedbackBody.innerHTML = "";
  const prevRisks = Array.isArray(data.risks) ? data.risks : [];

  if(!prevRisks.length){
    prevFeedbackBody.innerHTML = `
      <tr>
        <td class="center" colspan="4" style="color:var(--muted);padding:14px;">
          ì „íšŒì°¨ ìœ„í—˜ìš”ì¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
        </td>
      </tr>
    `;
  }else{
    prevRisks.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="center">${i+1}</td>
        <td>${(r.risk || "").replaceAll("<","&lt;")}</td>
        <td>${(r.solution || "").replaceAll("<","&lt;")}</td>
        <td>
          <textarea class="tTa adminInput"
            data-role="prevResult"
            data-prev-index="${i}"
            placeholder="ì´í–‰ê²°ê³¼ ì‘ì„±"></textarea>
        </td>
      `;
      prevFeedbackBody.appendChild(tr);
    });
  }

  tradeLargeEl.value = tradeLarge;
  roundTextEl.textContent = round;

  prevLoadBox.style.display = "none";
  setSummaryState("ëŒ€ê¸°","idle");
  toast("íšŒì°¨ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
}



/* =======================
   11) ì„ íƒì‚­ì œ/ì²´í¬ì˜¬
======================= */
function deleteSelected(){
  const rows = [...tbody.querySelectorAll("tr")];
  const targets = rows.filter(tr => tr.querySelector("[data-role=sel]").checked);
  if(!targets.length){
    alert("ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  targets.forEach(tr=>tr.remove());
  ckAll.checked = false;
  renumber();
  if(tbody.children.length === 0){
    addRow(); addRow(); addRow();
    renumber();
  }
}

ckAll.addEventListener("change", ()=>{
  const on = ckAll.checked;
  [...tbody.querySelectorAll("[data-role=sel]")].forEach(ck=>ck.checked = on);
});

/* =======================
   12) ë²„íŠ¼ ì´ë²¤íŠ¸ (ë²„ì „1 íë¦„ ìœ ì§€)
======================= */
btnAddRow.addEventListener("click", ()=> addRow());
btnAddRowTop.addEventListener("click", ()=> addRow());

// ===== ê¸°ë³¸ ì •ë³´ (ë²„ì „1 ë°€ë„ ìœ ì§€) =====

btnDeleteLast.addEventListener("click", deleteLastRow);

btnDeleteLast.addEventListener("click", deleteLastRow);
btnDeleteSelectedTop.addEventListener("click", deleteSelected);

btnGenerate.addEventListener("click", generateSummary);
btnGenerateTop.addEventListener("click", generateSummary);

btnPrintTop.addEventListener("click", ()=> window.print());

btnSave.addEventListener("click", saveToFirestore);
btnLoadPrev.addEventListener("click", loadPreviousRound);
btnConfirmPrevTrade.addEventListener("click", confirmLoadPrevByTrade);

btnCancelPrevTrade.addEventListener("click", ()=>{
  prevLoadBox.style.display = "none";
  prevRoundData = {};
});

/* íšŒì°¨ ë³€ê²½ ì‹œ: ì œëª©ë§Œ ì¦‰ì‹œ ë™ê¸°í™” (ë²„ì „1 ëŠë‚Œ ìœ ì§€) */
roundEl.addEventListener("change", ()=>{
  syncRoundTitle();
});

/* =======================
   13) ì´ˆê¸° 3í–‰ ë³´ì¥ (ë²„ì „1 í•µì‹¬)
======================= */
(function initRows(){
  if(tbody.children.length === 0){
    addRow(); addRow(); addRow();
    renumber();
  }
  setSummaryState("ëŒ€ê¸°", "idle");
  toast("v1.0SR FINAL (Secure) ì¤€ë¹„ ì™„ë£Œ");
})();

/* ===============================
   ğŸ”¥ PDF ì¶œë ¥ ì§ì „: textarea â†’ printText ë³µì‚¬
=============================== */
window.addEventListener("beforeprint", () => {
  document.querySelectorAll("tbody tr").forEach(tr => {
    const risk = tr.querySelector("[data-role=risk]");
    const sol  = tr.querySelector("[data-role=solution]");

    const prRisk = tr.querySelector("[data-print=risk]");
    const prSol  = tr.querySelector("[data-print=solution]");

    if (risk && prRisk) prRisk.textContent = risk.value;
    if (sol && prSol)   prSol.textContent  = sol.value;
  });
});

</script>
</body>
</html>
