<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>최초 위험성평가 등록 | 동진토건</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --blue:#1f5bd8;
  --dark:#0b2a4f;
  --bg:#f4f7ff;
}
body{
  margin:0;
  font-family:"Noto Sans KR",sans-serif;
  background:var(--bg);
  color:#0b1b3b;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,var(--dark),var(--blue));
  color:#fff;
  padding:80px 20px;
  text-align:center;
}
.header h1{margin:0;font-size:36px;font-weight:800}
.header p{margin-top:12px;font-size:16px;opacity:.95}

/* LAYOUT */
.section{max-width:1200px;margin:0 auto;padding:40px 20px}
.box{
  background:#fff;
  border-radius:22px;
  padding:32px;
  margin-bottom:30px;
  box-shadow:0 18px 40px rgba(0,0,0,.08)
}
h2{margin:0 0 18px;font-size:20px;font-weight:800}

/* FORM */
label{font-size:14px;font-weight:700}
select,input{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #d0d6e4;
  font-size:14px;
}

/* SUMMARY */
.summary{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}
.summary-item{
  background:#f7f9ff;
  border:1px solid #e1e7f5;
  border-radius:16px;
  padding:20px;
}
.summary-item span{font-size:12px;color:#667}
.summary-item strong{display:block;margin-top:6px;font-size:18px;font-weight:800}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
th{background:#eef3ff;font-weight:800}

/* 위험등급 색상 */
.risk-badge{
  display:inline-block;
  min-width:36px;
  text-align:center;
  padding:4px 10px;
  border-radius:999px;
  font-weight:800;
  font-size:12px;
  color:#fff;
}
.risk-high{background:#ef4444}
.risk-mid{background:#f59e0b}
.risk-low{background:#3b82f6}

/* ACTIONS */
.actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:20px;
}
button{
  padding:14px 30px;
  border-radius:999px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.primary{background:var(--blue);color:#fff}
.ghost{background:#fff;border:1px solid #aaa}
.danger{background:#ef4444;color:#fff}
</style>
</head>

<body>

<div class="header">
  <h1>최초 위험성평가 등록</h1>
  <p>협력업체 자체 위험성평가 기준 데이터</p>
</div>

<div class="section">

<!-- 현장 선택 -->
<div class="box">
  <h2>① 현장 선택</h2>
  <label>현장명</label>
  <select id="siteSelect">
    <option value="">선택</option>
    <option value="paju-pmc">파주 PMC</option>
    <option value="ulsan-taehwagang">울산 태화강</option>
    <option value="ulsan-ujeong">울산 우정동</option>
    <option value="yeosu">여수</option>
  </select>
  <div id="statusText" style="margin-top:10px;font-size:13px;color:#555"></div>
</div>

<!-- 요약 -->
<div class="box" id="summaryBox" style="display:none">
  <h2>② 기본 정보</h2>
  <div class="summary">
    <div class="summary-item">
      <span>현장명</span>
      <strong id="summarySite"></strong>
    </div>
    <div class="summary-item">
      <span>최초 작성일</span>
      <strong id="summaryDate"></strong>
    </div>
  </div>
</div>

<!-- 작성일 -->
<div class="box" id="dateBox">
  <h2>③ 최초 작성일</h2>
  <input type="date" id="createdDate">
</div>

<!-- 엑셀 -->
<div class="box" id="excelBox">
  <h2>④ 엑셀 업로드</h2>
  <input type="file" id="excelFile" accept=".xlsx,.xls">
</div>

<!-- 미리보기 -->
<div class="box" id="previewBox" style="display:none">
  <h2>⑤ 위험성평가 항목</h2>
  <div style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>NO</th><th>대공종</th><th>중공종</th><th>세부공종</th>
          <th>작업내용</th><th>위험요인</th><th>위험분류</th>
          <th>위험등급</th><th>위험감소대책</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="actions">
    <button class="danger" id="deleteBtn" style="display:none">삭제</button>
    <button class="ghost" id="pdfBtn">PDF</button>
    <button class="primary" id="saveBtn">저장</button>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyDO0z7h5WVsyHob7PAJLzOBFi8wCifAsdY",
  projectId:"dongjin-risk-system"
});
const db = getFirestore(app);

const siteSelect = document.getElementById("siteSelect");
const excelFile = document.getElementById("excelFile");
const tbody = document.getElementById("tbody");
const previewBox = document.getElementById("previewBox");
const createdDateInput = document.getElementById("createdDate");
const saveBtn = document.getElementById("saveBtn");
const pdfBtn = document.getElementById("pdfBtn");
const deleteBtn = document.getElementById("deleteBtn");
const statusText = document.getElementById("statusText");
const summaryBox = document.getElementById("summaryBox");
const summarySite = document.getElementById("summarySite");
const summaryDate = document.getElementById("summaryDate");

let siteId="", siteName="", items=[];

/* 현장 선택 */
siteSelect.addEventListener("change", async ()=>{
  siteId = siteSelect.value;
  siteName = siteSelect.options[siteSelect.selectedIndex]?.text||"";
  if(!siteId) return;

  summarySite.textContent = siteName;

  const snap = await getDoc(doc(db,"initialRiskAssessments",siteId));
  if(snap.exists()){
    const d = snap.data();
    items = d.items || [];
    createdDateInput.value = d.createdDate;
    createdDateInput.disabled = true;
    summaryDate.textContent = d.createdDate;
    summaryBox.style.display="block";
    deleteBtn.style.display="inline-block";
    render();
    statusText.textContent="기존 최초 위험성평가 불러옴";
  }else{
    items=[];
    createdDateInput.value="";
    createdDateInput.disabled=false;
    summaryBox.style.display="none";
    previewBox.style.display="none";
    deleteBtn.style.display="none";
    statusText.textContent="저장된 데이터 없음";
  }
});

/* 엑셀 */
excelFile.addEventListener("change", async e=>{
  const buf = await e.target.files[0].arrayBuffer();
  const wb = XLSX.read(buf,{type:"array"});
  const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
  items = json.map(r=>({
    no:r.NO,
    major:r["대공종명"],
    middle:r["중공종명"],
    detail:r["세부공종"],
    work:r["작업내용"],
    hazard:r["위험요인"],
    hazardType:r["위험분류"],
    level:r["위험등급"],
    measures:r["위험감소대책"]
  }));
  render();
});

/* 렌더 */
function render(){
  tbody.innerHTML="";
  items.forEach(r=>{
    const cls =
      r.level==="상"?"risk-high":
      r.level==="중"?"risk-mid":"risk-low";

    tbody.innerHTML+=`
      <tr>
        <td>${r.no}</td>
        <td>${r.major}</td>
        <td>${r.middle}</td>
        <td>${r.detail}</td>
        <td>${r.work}</td>
        <td>${r.hazard}</td>
        <td>${r.hazardType}</td>
        <td style="text-align:center">
          <span class="risk-badge ${cls}">${r.level}</span>
        </td>
        <td>${r.measures}</td>
      </tr>`;
  });
  previewBox.style.display="block";
}

/* 저장 */
saveBtn.addEventListener("click", async ()=>{
  if(!siteId || !items.length || !createdDateInput.value){
    alert("현장, 작성일, 엑셀 데이터 필요");
    return;
  }
  await setDoc(doc(db,"initialRiskAssessments",siteId),{
    siteId,
    siteName,
    createdDate:createdDateInput.value,
    items
  });
  alert("저장 완료");
});

/* 삭제 */
deleteBtn.addEventListener("click", async ()=>{
  if(!confirm("최초 위험성평가를 완전히 삭제합니다.")) return;
  await deleteDoc(doc(db,"initialRiskAssessments",siteId));
  location.reload();
});

/* PDF */
pdfBtn.addEventListener("click", ()=>{
  const w = window.open("","");
  w.document.write(`
    <html><head><meta charset="utf-8">
    <style>
    body{font-family:'Noto Sans KR';padding:30px}
    h1{text-align:center}
    table{width:100%;border-collapse:collapse;font-size:11px}
    th,td{border:1px solid #000;padding:5px}
    th{background:#eee}
    </style>
    </head><body>
    <h1>최초 위험성평가 보고서</h1>
    <p><b>현장명 :</b> ${siteName}</p>
    <table>
    ${document.querySelector("table").innerHTML}
    </table>
    <script>window.print();<\/script>
    </body></html>
  `);
});
</script>

</body>
</html>
